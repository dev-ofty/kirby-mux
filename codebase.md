# .editorconfig

```
# This file is for unifying the coding style for different editors and IDEs
# editorconfig.org

[*]
charset = utf-8
indent_style = space
indent_size = 2
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.php]
indent_size = 4

[*.md,*.txt]
trim_trailing_whitespace = false
insert_final_newline = false

[composer.json]
indent_size = 4

```

# .gitattributes

```
# Note: You need to uncomment the lines you want to use; the other lines can be deleted

# Git
# .gitattributes export-ignore
# .gitignore export-ignore

# Tests
# /.coveralls.yml export-ignore
# /.travis.yml export-ignore
# /phpunit.xml.dist export-ignore
# /tests/ export-ignore

```

# .gitignore

```
# OS files
.DS_Store

# npm modules
/node_modules

# Parcel cache folder
.cache

# Files of Composer dependencies that are not needed for the plugin
/vendor/**/.*
/vendor/**/*.json
/vendor/**/*.txt
/vendor/**/*.md
/vendor/**/*.yml
/vendor/**/*.yaml
/vendor/**/*.xml
/vendor/**/*.dist
/vendor/**/readme.php
/vendor/**/LICENSE
/vendor/**/COPYING
/vendor/**/VERSION
/vendor/**/docs/*
/vendor/**/example/*
/vendor/**/examples/*
/vendor/**/test/*
/vendor/**/tests/*
/vendor/**/php4/*
/vendor/getkirby/composer-installer

```

# blueprints/blocks/mux-audio.yml

```yml
name: Audio
icon: file-audio
fields:
  audio:
    label: Audio
    type: files
    multiple: false
    query: page.files.template('mux-audio')
    uploads:
      template: mux-audio
    min: 1
    required: true
  caption:
    label: Caption
    type: writer
    inline: true
```

# blueprints/blocks/mux-video.yml

```yml
name: Video MUX
icon: video
fields:
  video:
    label: field.blocks.video.name
    type: files
    multiple: false
    query: page.files.template('mux-video')
    image:
      back: black
    uploads:
      template: mux-video
    min: 1
    max: 1
    required: true
  mute:
    type: toggle
    help: "This will allow the video to autoplay but the video will be muted unless the user unmute it manually"
  caption:
    label: field.blocks.video.caption
    type: writer
    inline: true
  thumbnail:
    label: field.blocks.mux-video.thumbnail
    help: field.blocks.mux-video.thumbnail.help
    type: number
    default: 0
    step: 1

```

# blueprints/files/mux-audio.yml

```yml
title:
  de: Mux audio
  en: Mux audio

accept:
  mime: audio/*
  type: audio

fields:
  mux:
    type: hidden

```

# blueprints/files/mux-video.yml

```yml
title:
  de: Mux video
  en: Mux video

accept:
  mime: video/*
  type: video

fields:
  mux:
    type: hidden

```

# classes/KirbyMux/Auth.php

```php
<?php
namespace KirbyMux;
use MuxPhp;
use GuzzleHttp;

class Auth
{
    public static function assetsApi() {
        // Authentication setup
        $config = MuxPhp\Configuration::getDefaultConfiguration()
            ->setUsername($_ENV['MUX_TOKEN_ID'])
            ->setPassword($_ENV['MUX_TOKEN_SECRET']);

        // API client initialization
        $assetsApi = new MuxPhp\Api\AssetsApi(
            new GuzzleHttp\Client(),
            $config
        );

        return $assetsApi;
    }
}

```

# classes/KirbyMux/Methods.php

```php
<?php
namespace KirbyMux;
use MuxPhp;
class Methods
{
    public static function upload($assetsApi, $url, $type) {
        $file = $_ENV['MUX_DEV'] === "true" ? "https://storage.googleapis.com/muxdemofiles/mux-video-intro.mp4" : $url;
        if($type === 'audio') :
        $file = $url;
        endif;
        $input = new MuxPhp\Models\InputSettings(["url" => $file]);
        $createAssetRequest = new MuxPhp\Models\CreateAssetRequest(["input" => $input, "playback_policy" => [MuxPhp\Models\PlaybackPolicy::_PUBLIC], "mp4_support" => "standard"]);
        // $updateAssetMp4SupportRequest = new MuxPhp\Models\UpdateAssetMP4SupportRequest(["mp4_support" => "standard"]);
        $result = $assetsApi->createAsset($createAssetRequest);
        return $result;
    }
}

```

# composer.json

```json
{
  "name": "devofty/kirby-mux",
  "description": "Upload videos directly to mux @forked from robinscholz/kirby-mux which allows video analysis for dimensions and audio upload with Mux + Mp4.",
  "type": "kirby-plugin",
  "keywords": [
    "kirby",
    "mux",
    "video",
    "stream"
  ],
  "license": "MIT",
  "homepage": "https://github.com/dev-ofty/kirby-mux#readme",
  "authors": [
    {
      "name": "Dev ofty",
      "email": "dev@ofty.ch",
      "homepage": "https://ofty.ch"
    }
  ],
  "require": {
    "php": ">=8.1.0",
    "getkirby/composer-installer": "^1.2",
    "muxinc/mux-php": "^5.0",
    "vlucas/phpdotenv": "^5.4",
    "james-heinrich/getid3": "^1.9"
  },
  "autoload": {
    "psr-4": {
      "KirbyMux\\": "classes/KirbyMux/"
    }
  },
  "scripts": {
    "dist": "composer install --no-dev --optimize-autoloader"
  },
  "config": {
    "optimize-autoloader": true,
    "allow-plugins": {
      "getkirby/composer-installer": true
    }
  }
}

```

# index.css

```css
.video-player{position:relative;display:flex}.thumb{width:100%;height:100%;position:absolute;top:0;left:0;right:0;bottom:0;z-index:10}.overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;z-index:20}.overlay__inner{width:56px;height:42px;padding-left:3px;background:#000;border:0;display:flex;color:#fff;align-items:center;justify-content:center;transition:width .15s ease-out,height .15s ease-out;cursor:pointer}.overlay__inner svg{width:14px;height:auto}.overlay__inner:active{width:53.333px;height:40px}video{width:100%;cursor:pointer}.k-block-container-type-mux-video{position:relative;z-index:0}.k-block-container-type-mux-video .k-block-figure-empty{height:100%}.audio-player{position:relative;display:flex}audio{width:100%;cursor:pointer}

```

# index.js

```js
(function(){"use strict";var Ye=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function ze(G){return G&&G.__esModule&&Object.prototype.hasOwnProperty.call(G,"default")?G.default:G}var Ne={exports:{}};(function(G,q){typeof window!="undefined"&&function(C,h){G.exports=h()}(Ye,function(){return function(w){var C={};function h(F){if(C[F])return C[F].exports;var O=C[F]={i:F,l:!1,exports:{}};return w[F].call(O.exports,O,O.exports,h),O.l=!0,O.exports}return h.m=w,h.c=C,h.d=function(F,O,D){h.o(F,O)||Object.defineProperty(F,O,{enumerable:!0,get:D})},h.r=function(F){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(F,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(F,"__esModule",{value:!0})},h.t=function(F,O){if(O&1&&(F=h(F)),O&8||O&4&&typeof F=="object"&&F&&F.__esModule)return F;var D=Object.create(null);if(h.r(D),Object.defineProperty(D,"default",{enumerable:!0,value:F}),O&2&&typeof F!="string")for(var M in F)h.d(D,M,function(R){return F[R]}.bind(null,M));return D},h.n=function(F){var O=F&&F.__esModule?function(){return F.default}:function(){return F};return h.d(O,"a",O),O},h.o=function(F,O){return Object.prototype.hasOwnProperty.call(F,O)},h.p="/dist/",h(h.s="./src/hls.ts")}({"./node_modules/eventemitter3/index.js":function(w,C,h){var F=Object.prototype.hasOwnProperty,O="~";function D(){}Object.create&&(D.prototype=Object.create(null),new D().__proto__||(O=!1));function M(a,l,s){this.fn=a,this.context=l,this.once=s||!1}function R(a,l,s,S,v){if(typeof s!="function")throw new TypeError("The listener must be a function");var p=new M(s,S||a,v),d=O?O+l:l;return a._events[d]?a._events[d].fn?a._events[d]=[a._events[d],p]:a._events[d].push(p):(a._events[d]=p,a._eventsCount++),a}function A(a,l){--a._eventsCount===0?a._events=new D:delete a._events[l]}function c(){this._events=new D,this._eventsCount=0}c.prototype.eventNames=function(){var l=[],s,S;if(this._eventsCount===0)return l;for(S in s=this._events)F.call(s,S)&&l.push(O?S.slice(1):S);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(s)):l},c.prototype.listeners=function(l){var s=O?O+l:l,S=this._events[s];if(!S)return[];if(S.fn)return[S.fn];for(var v=0,p=S.length,d=new Array(p);v<p;v++)d[v]=S[v].fn;return d},c.prototype.listenerCount=function(l){var s=O?O+l:l,S=this._events[s];return S?S.fn?1:S.length:0},c.prototype.emit=function(l,s,S,v,p,d){var n=O?O+l:l;if(!this._events[n])return!1;var u=this._events[n],f=arguments.length,E,r;if(u.fn){switch(u.once&&this.removeListener(l,u.fn,void 0,!0),f){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,s),!0;case 3:return u.fn.call(u.context,s,S),!0;case 4:return u.fn.call(u.context,s,S,v),!0;case 5:return u.fn.call(u.context,s,S,v,p),!0;case 6:return u.fn.call(u.context,s,S,v,p,d),!0}for(r=1,E=new Array(f-1);r<f;r++)E[r-1]=arguments[r];u.fn.apply(u.context,E)}else{var e=u.length,t;for(r=0;r<e;r++)switch(u[r].once&&this.removeListener(l,u[r].fn,void 0,!0),f){case 1:u[r].fn.call(u[r].context);break;case 2:u[r].fn.call(u[r].context,s);break;case 3:u[r].fn.call(u[r].context,s,S);break;case 4:u[r].fn.call(u[r].context,s,S,v);break;default:if(!E)for(t=1,E=new Array(f-1);t<f;t++)E[t-1]=arguments[t];u[r].fn.apply(u[r].context,E)}}return!0},c.prototype.on=function(l,s,S){return R(this,l,s,S,!1)},c.prototype.once=function(l,s,S){return R(this,l,s,S,!0)},c.prototype.removeListener=function(l,s,S,v){var p=O?O+l:l;if(!this._events[p])return this;if(!s)return A(this,p),this;var d=this._events[p];if(d.fn)d.fn===s&&(!v||d.once)&&(!S||d.context===S)&&A(this,p);else{for(var n=0,u=[],f=d.length;n<f;n++)(d[n].fn!==s||v&&!d[n].once||S&&d[n].context!==S)&&u.push(d[n]);u.length?this._events[p]=u.length===1?u[0]:u:A(this,p)}return this},c.prototype.removeAllListeners=function(l){var s;return l?(s=O?O+l:l,this._events[s]&&A(this,s)):(this._events=new D,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=O,c.EventEmitter=c,w.exports=c},"./node_modules/url-toolkit/src/url-toolkit.js":function(w,C,h){(function(F){var O=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,D=/^(?=([^\/?#]*))\1([^]*)$/,M=/(?:\/|^)\.(?=\/)/g,R=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,A={buildAbsoluteURL:function(c,a,l){if(l=l||{},c=c.trim(),a=a.trim(),!a){if(!l.alwaysNormalize)return c;var s=A.parseURL(c);if(!s)throw new Error("Error trying to parse base URL.");return s.path=A.normalizePath(s.path),A.buildURLFromParts(s)}var S=A.parseURL(a);if(!S)throw new Error("Error trying to parse relative URL.");if(S.scheme)return l.alwaysNormalize?(S.path=A.normalizePath(S.path),A.buildURLFromParts(S)):a;var v=A.parseURL(c);if(!v)throw new Error("Error trying to parse base URL.");if(!v.netLoc&&v.path&&v.path[0]!=="/"){var p=D.exec(v.path);v.netLoc=p[1],v.path=p[2]}v.netLoc&&!v.path&&(v.path="/");var d={scheme:v.scheme,netLoc:S.netLoc,path:null,params:S.params,query:S.query,fragment:S.fragment};if(!S.netLoc&&(d.netLoc=v.netLoc,S.path[0]!=="/"))if(!S.path)d.path=v.path,S.params||(d.params=v.params,S.query||(d.query=v.query));else{var n=v.path,u=n.substring(0,n.lastIndexOf("/")+1)+S.path;d.path=A.normalizePath(u)}return d.path===null&&(d.path=l.alwaysNormalize?A.normalizePath(S.path):S.path),A.buildURLFromParts(d)},parseURL:function(c){var a=O.exec(c);return a?{scheme:a[1]||"",netLoc:a[2]||"",path:a[3]||"",params:a[4]||"",query:a[5]||"",fragment:a[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(M,"");c.length!==(c=c.replace(R,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};w.exports=A})()},"./node_modules/webworkify-webpack/index.js":function(w,C,h){function F(l){var s={};function S(p){if(s[p])return s[p].exports;var d=s[p]={i:p,l:!1,exports:{}};return l[p].call(d.exports,d,d.exports,S),d.l=!0,d.exports}S.m=l,S.c=s,S.i=function(p){return p},S.d=function(p,d,n){S.o(p,d)||Object.defineProperty(p,d,{configurable:!1,enumerable:!0,get:n})},S.r=function(p){Object.defineProperty(p,"__esModule",{value:!0})},S.n=function(p){var d=p&&p.__esModule?function(){return p.default}:function(){return p};return S.d(d,"a",d),d},S.o=function(p,d){return Object.prototype.hasOwnProperty.call(p,d)},S.p="/",S.oe=function(p){throw console.error(p),p};var v=S(S.s=ENTRY_MODULE);return v.default||v}var O="[\\.|\\-|\\+|\\w|/|@]+",D="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+O+").*?\\)";function M(l){return(l+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function R(l){return!isNaN(1*l)}function A(l,s,S){var v={};v[S]=[];var p=s.toString(),d=p.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!d)return v;for(var n=d[1],u=new RegExp("(\\\\n|\\W)"+M(n)+D,"g"),f;f=u.exec(p);)f[3]!=="dll-reference"&&v[S].push(f[3]);for(u=new RegExp("\\("+M(n)+'\\("(dll-reference\\s('+O+'))"\\)\\)'+D,"g");f=u.exec(p);)l[f[2]]||(v[S].push(f[1]),l[f[2]]=h(f[1]).m),v[f[2]]=v[f[2]]||[],v[f[2]].push(f[4]);for(var E=Object.keys(v),r=0;r<E.length;r++)for(var e=0;e<v[E[r]].length;e++)R(v[E[r]][e])&&(v[E[r]][e]=1*v[E[r]][e]);return v}function c(l){var s=Object.keys(l);return s.reduce(function(S,v){return S||l[v].length>0},!1)}function a(l,s){for(var S={main:[s]},v={main:[]},p={main:{}};c(S);)for(var d=Object.keys(S),n=0;n<d.length;n++){var u=d[n],f=S[u],E=f.pop();if(p[u]=p[u]||{},!(p[u][E]||!l[u][E])){p[u][E]=!0,v[u]=v[u]||[],v[u].push(E);for(var r=A(l,l[u][E],u),e=Object.keys(r),t=0;t<e.length;t++)S[e[t]]=S[e[t]]||[],S[e[t]]=S[e[t]].concat(r[e[t]])}}return v}w.exports=function(l,s){s=s||{};var S={main:h.m},v=s.all?{main:Object.keys(S.main)}:a(S,l),p="";Object.keys(v).filter(function(E){return E!=="main"}).forEach(function(E){for(var r=0;v[E][r];)r++;v[E].push(r),S[E][r]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",p=p+"var "+E+" = ("+F.toString().replace("ENTRY_MODULE",JSON.stringify(r))+")({"+v[E].map(function(e){return""+JSON.stringify(e)+": "+S[E][e].toString()}).join(",")+`});
`}),p=p+"new (("+F.toString().replace("ENTRY_MODULE",JSON.stringify(l))+")({"+v.main.map(function(E){return""+JSON.stringify(E)+": "+S.main[E].toString()}).join(",")+"}))(self);";var d=new window.Blob([p],{type:"text/javascript"});if(s.bare)return d;var n=window.URL||window.webkitURL||window.mozURL||window.msURL,u=n.createObjectURL(d),f=new window.Worker(u);return f.objectURL=u,f}},"./src/config.ts":function(w,C,h){h.r(C),h.d(C,"hlsDefaultConfig",function(){return n}),h.d(C,"mergeConfig",function(){return f}),h.d(C,"enableStreamingMode",function(){return E});var F=h("./src/controller/abr-controller.ts"),O=h("./src/empty.js"),D=h.n(O),M=h("./src/controller/buffer-controller.ts"),R=h("./src/controller/cap-level-controller.ts"),A=h("./src/controller/fps-controller.ts"),c=h("./src/utils/xhr-loader.ts"),a=h("./src/utils/fetch-loader.ts"),l=h("./src/utils/mediakeys-helper.ts"),s=h("./src/utils/logger.ts");function S(){return S=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},S.apply(this,arguments)}function v(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(o){return Object.getOwnPropertyDescriptor(r,o).enumerable})),t.push.apply(t,i)}return t}function p(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?v(Object(t),!0).forEach(function(i){d(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):v(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function d(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}var n=p(p({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:c.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:F.default,bufferController:M.default,capLevelController:R.default,fpsController:A.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:l.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},u()),{},{subtitleStreamController:void 0,subtitleTrackController:void 0,timelineController:void 0,audioStreamController:void 0,audioTrackController:void 0,emeController:void 0,cmcdController:void 0});function u(){return{cueHandler:D.a,enableWebVTT:!1,enableIMSC1:!1,enableCEA708Captions:!1,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function f(r,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return S({},r,e)}function E(r){var e=r.loader;if(e!==a.default&&e!==c.default)s.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),r.progressive=!1;else{var t=Object(a.fetchSupported)();t&&(r.loader=a.default,r.progressive=!0,r.enableSoftwareAES=!0,s.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}},"./src/controller/abr-controller.ts":function(w,C,h){h.r(C);var F=h("./src/polyfills/number.ts"),O=h("./src/utils/ewma-bandwidth-estimator.ts"),D=h("./src/events.ts"),M=h("./src/utils/buffer-helper.ts"),R=h("./src/errors.ts"),A=h("./src/types/loader.ts"),c=h("./src/utils/logger.ts");function a(S,v){for(var p=0;p<v.length;p++){var d=v[p];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(S,d.key,d)}}function l(S,v,p){return v&&a(S.prototype,v),p&&a(S,p),Object.defineProperty(S,"prototype",{writable:!1}),S}var s=function(){function S(p){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=p;var d=p.config;this.bwEstimator=new O.default(d.abrEwmaSlowVoD,d.abrEwmaFastVoD,d.abrEwmaDefaultEstimate),this.registerListeners()}var v=S.prototype;return v.registerListeners=function(){var d=this.hls;d.on(D.Events.FRAG_LOADING,this.onFragLoading,this),d.on(D.Events.FRAG_LOADED,this.onFragLoaded,this),d.on(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),d.on(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),d.on(D.Events.ERROR,this.onError,this)},v.unregisterListeners=function(){var d=this.hls;d.off(D.Events.FRAG_LOADING,this.onFragLoading,this),d.off(D.Events.FRAG_LOADED,this.onFragLoaded,this),d.off(D.Events.FRAG_BUFFERED,this.onFragBuffered,this),d.off(D.Events.LEVEL_LOADED,this.onLevelLoaded,this),d.off(D.Events.ERROR,this.onError,this)},v.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},v.onFragLoading=function(d,n){var u=n.frag;if(u.type===A.PlaylistLevelType.MAIN&&!this.timer){var f;this.fragCurrent=u,this.partCurrent=(f=n.part)!=null?f:null,this.timer=self.setInterval(this.onCheck,100)}},v.onLevelLoaded=function(d,n){var u=this.hls.config;n.details.live?this.bwEstimator.update(u.abrEwmaSlowLive,u.abrEwmaFastLive):this.bwEstimator.update(u.abrEwmaSlowVoD,u.abrEwmaFastVoD)},v._abandonRulesCheck=function(){var d=this.fragCurrent,n=this.partCurrent,u=this.hls,f=u.autoLevelEnabled,E=u.config,r=u.media;if(!(!d||!r)){var e=n?n.stats:d.stats,t=n?n.duration:d.duration;if(e.aborted){c.logger.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!f||r.paused||!r.playbackRate||!r.readyState)){var i=performance.now()-e.loading.start,o=Math.abs(r.playbackRate);if(!(i<=500*t/o)){var m=u.levels,L=u.minAutoLevel,P=m[d.level],y=e.total||Math.max(e.loaded,Math.round(t*P.maxBitrate/8)),T=Math.max(1,e.bwEstimate?e.bwEstimate/8:e.loaded*1e3/i),g=(y-e.loaded)/T,x=r.currentTime,I=(M.BufferHelper.bufferInfo(r,x,E.maxBufferHole).end-x)/o;if(!(I>=2*t/o||g<=I)){var U=Number.POSITIVE_INFINITY,b;for(b=d.level-1;b>L;b--){var B=m[b].maxBitrate;if(U=t*B/(8*.8*T),U<I)break}if(!(U>=g)){var _=this.bwEstimator.getEstimate();c.logger.warn("Fragment "+d.sn+(n?" part "+n.index:"")+" of level "+d.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+b+`
      Current BW estimate: `+(Object(F.isFiniteNumber)(_)?(_/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+g.toFixed(3)+` s
      Estimated load time for the next fragment: `+U.toFixed(3)+` s
      Time to underbuffer: `+I.toFixed(3)+" s"),u.nextLoadLevel=b,this.bwEstimator.sample(i,e.loaded),this.clearTimer(),d.loader&&(this.fragCurrent=this.partCurrent=null,d.loader.abort()),u.trigger(D.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:d,part:n,stats:e})}}}}}},v.onFragLoaded=function(d,n){var u=n.frag,f=n.part;if(u.type===A.PlaylistLevelType.MAIN&&Object(F.isFiniteNumber)(u.sn)){var E=f?f.stats:u.stats,r=f?f.duration:u.duration;if(this.clearTimer(),this.lastLoadedFragLevel=u.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var e=this.hls.levels[u.level],t=(e.loaded?e.loaded.bytes:0)+E.loaded,i=(e.loaded?e.loaded.duration:0)+r;e.loaded={bytes:t,duration:i},e.realBitrate=Math.round(8*t/i)}if(u.bitrateTest){var o={stats:E,frag:u,part:f,id:u.type};this.onFragBuffered(D.Events.FRAG_BUFFERED,o)}}},v.onFragBuffered=function(d,n){var u=n.frag,f=n.part,E=f?f.stats:u.stats;if(!E.aborted&&!(u.type!==A.PlaylistLevelType.MAIN||u.sn==="initSegment")){var r=E.parsing.end-E.loading.start;this.bwEstimator.sample(r,E.loaded),E.bwEstimate=this.bwEstimator.getEstimate(),u.bitrateTest?this.bitrateTestDelay=r/1e3:this.bitrateTestDelay=0}},v.onError=function(d,n){switch(n.details){case R.ErrorDetails.FRAG_LOAD_ERROR:case R.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer();break}},v.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},v.getNextABRAutoLevel=function(){var d=this.fragCurrent,n=this.partCurrent,u=this.hls,f=u.maxAutoLevel,E=u.config,r=u.minAutoLevel,e=u.media,t=n?n.duration:d?d.duration:0,i=e?e.currentTime:0,o=e&&e.playbackRate!==0?Math.abs(e.playbackRate):1,m=this.bwEstimator?this.bwEstimator.getEstimate():E.abrEwmaDefaultEstimate,L=(M.BufferHelper.bufferInfo(e,i,E.maxBufferHole).end-i)/o,P=this.findBestLevel(m,r,f,L,E.abrBandWidthFactor,E.abrBandWidthUpFactor);if(P>=0)return P;c.logger.trace((L?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var y=t?Math.min(t,E.maxStarvationDelay):E.maxStarvationDelay,T=E.abrBandWidthFactor,g=E.abrBandWidthUpFactor;if(!L){var x=this.bitrateTestDelay;if(x){var I=t?Math.min(t,E.maxLoadingDelay):E.maxLoadingDelay;y=I-x,c.logger.trace("bitrate test took "+Math.round(1e3*x)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*y)+" ms"),T=g=1}}return P=this.findBestLevel(m,r,f,L+y,T,g),Math.max(P,0)},v.findBestLevel=function(d,n,u,f,E,r){for(var e,t=this.fragCurrent,i=this.partCurrent,o=this.lastLoadedFragLevel,m=this.hls.levels,L=m[o],P=!!(L!=null&&(e=L.details)!==null&&e!==void 0&&e.live),y=L==null?void 0:L.codecSet,T=i?i.duration:t?t.duration:0,g=u;g>=n;g--){var x=m[g];if(!(!x||y&&x.codecSet!==y)){var I=x.details,U=(i?I==null?void 0:I.partTarget:I==null?void 0:I.averagetargetduration)||T,b=void 0;g<=o?b=E*d:b=r*d;var B=m[g].maxBitrate,_=B*U/b;if(c.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+g+"/"+Math.round(b)+"/"+B+"/"+U+"/"+f+"/"+_),b>B&&(!_||P&&!this.bitrateTestDelay||_<f))return g}}return-1},l(S,[{key:"nextAutoLevel",get:function(){var d=this._nextAutoLevel,n=this.bwEstimator;if(d!==-1&&!n.canEstimate())return d;var u=this.getNextABRAutoLevel();return d!==-1&&this.hls.levels[u].loadError?d:(d!==-1&&(u=Math.min(d,u)),u)},set:function(d){this._nextAutoLevel=d}}]),S}();C.default=s},"./src/controller/base-playlist-controller.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return A});var F=h("./src/polyfills/number.ts"),O=h("./src/types/level.ts"),D=h("./src/controller/level-helper.ts"),M=h("./src/utils/logger.ts"),R=h("./src/errors.ts"),A=function(){function c(l,s){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=M.logger.log.bind(M.logger,s+":"),this.warn=M.logger.warn.bind(M.logger,s+":"),this.hls=l}var a=c.prototype;return a.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},a.onError=function(s,S){S.fatal&&S.type===R.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},a.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},a.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},a.stopLoad=function(){this.canLoad=!1,this.clearTimer()},a.switchParams=function(s,S){var v=S==null?void 0:S.renditionReports;if(v)for(var p=0;p<v.length;p++){var d=v[p],n=""+d.URI;if(n===s.slice(-n.length)){var u=parseInt(d["LAST-MSN"]),f=parseInt(d["LAST-PART"]);if(S&&this.hls.config.lowLatencyMode){var E=Math.min(S.age-S.partTarget,S.targetduration);f!==void 0&&E>S.partTarget&&(f+=1)}if(Object(F.isFiniteNumber)(u))return new O.HlsUrlParameters(u,Object(F.isFiniteNumber)(f)?f:void 0,O.HlsSkip.No)}}},a.loadPlaylist=function(s){},a.shouldLoadTrack=function(s){return this.canLoad&&s&&!!s.url&&(!s.details||s.details.live)},a.playlistLoaded=function(s,S,v){var p=this,d=S.details,n=S.stats,u=n.loading.end?Math.max(0,self.performance.now()-n.loading.end):0;if(d.advancedDateTime=Date.now()-u,d.live||v!=null&&v.live){if(d.reloaded(v),v&&this.log("live playlist "+s+" "+(d.advanced?"REFRESHED "+d.lastPartSn+"-"+d.lastPartIndex:"MISSED")),v&&d.fragments.length>0&&Object(D.mergeDetails)(v,d),!this.canLoad||!d.live)return;var f,E=void 0,r=void 0;if(d.canBlockReload&&d.endSN&&d.advanced){var e=this.hls.config.lowLatencyMode,t=d.lastPartSn,i=d.endSN,o=d.lastPartIndex,m=o!==-1,L=t===i,P=e?0:o;m?(E=L?i+1:t,r=L?P:o+1):E=i+1;var y=d.age,T=y+d.ageHeader,g=Math.min(T-d.partTarget,d.targetduration*1.5);if(g>0){if(v&&g>v.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+v.tuneInGoal+" to: "+g+" with playlist age: "+d.age),g=0;else{var x=Math.floor(g/d.targetduration);if(E+=x,r!==void 0){var I=Math.round(g%d.targetduration/d.partTarget);r+=I}this.log("CDN Tune-in age: "+d.ageHeader+"s last advanced "+y.toFixed(2)+"s goal: "+g+" skip sn "+x+" to part "+r)}d.tuneInGoal=g}if(f=this.getDeliveryDirectives(d,S.deliveryDirectives,E,r),e||!L){this.loadPlaylist(f);return}}else f=this.getDeliveryDirectives(d,S.deliveryDirectives,E,r);var U=Object(D.computeReloadInterval)(d,n);E!==void 0&&d.canBlockReload&&(U-=d.partTarget||1),this.log("reload live playlist "+s+" in "+Math.round(U)+" ms"),this.timer=self.setTimeout(function(){return p.loadPlaylist(f)},U)}else this.clearTimer()},a.getDeliveryDirectives=function(s,S,v,p){var d=Object(O.getSkipValue)(s,v);return S!=null&&S.skip&&s.deltaUpdateFailed&&(v=S.msn,p=S.part,d=O.HlsSkip.No),new O.HlsUrlParameters(v,p,d)},a.retryLoadingOrFail=function(s){var S=this,v=this.hls.config,p=this.retryCount<v.levelLoadingMaxRetry;if(p){var d;if(this.retryCount++,s.details.indexOf("LoadTimeOut")>-1&&(d=s.context)!==null&&d!==void 0&&d.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+s.details+'"'),this.loadPlaylist();else{var n=Math.min(Math.pow(2,this.retryCount)*v.levelLoadingRetryDelay,v.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return S.loadPlaylist()},n),this.warn("retry playlist loading #"+this.retryCount+" in "+n+' ms after "'+s.details+'"')}}else this.warn('cannot recover from error "'+s.details+'"'),this.clearTimer(),s.fatal=!0;return p},c}()},"./src/controller/base-stream-controller.ts":function(w,C,h){h.r(C),h.d(C,"State",function(){return i}),h.d(C,"default",function(){return o});var F=h("./src/polyfills/number.ts"),O=h("./src/task-loop.ts"),D=h("./src/controller/fragment-tracker.ts"),M=h("./src/utils/buffer-helper.ts"),R=h("./src/utils/logger.ts"),A=h("./src/events.ts"),c=h("./src/errors.ts"),a=h("./src/types/transmuxer.ts"),l=h("./src/utils/mp4-tools.ts"),s=h("./src/utils/discontinuities.ts"),S=h("./src/controller/fragment-finders.ts"),v=h("./src/controller/level-helper.ts"),p=h("./src/loader/fragment-loader.ts"),d=h("./src/crypt/decrypter.ts"),n=h("./src/utils/time-ranges.ts"),u=h("./src/types/loader.ts");function f(m,L){for(var P=0;P<L.length;P++){var y=L[P];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(m,y.key,y)}}function E(m,L,P){return L&&f(m.prototype,L),P&&f(m,P),Object.defineProperty(m,"prototype",{writable:!1}),m}function r(m){if(m===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return m}function e(m,L){m.prototype=Object.create(L.prototype),m.prototype.constructor=m,t(m,L)}function t(m,L){return t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(y,T){return y.__proto__=T,y},t(m,L)}var i={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},o=function(m){e(L,m);function L(y,T,g){var x;return x=m.call(this)||this,x.hls=void 0,x.fragPrevious=null,x.fragCurrent=null,x.fragmentTracker=void 0,x.transmuxer=null,x._state=i.STOPPED,x.media=null,x.mediaBuffer=null,x.config=void 0,x.bitrateTest=!1,x.lastCurrentTime=0,x.nextLoadPosition=0,x.startPosition=0,x.loadedmetadata=!1,x.fragLoadError=0,x.retryDate=0,x.levels=null,x.fragmentLoader=void 0,x.levelLastLoaded=null,x.startFragRequested=!1,x.decrypter=void 0,x.initPTS=[],x.onvseeking=null,x.onvended=null,x.logPrefix="",x.log=void 0,x.warn=void 0,x.logPrefix=g,x.log=R.logger.log.bind(R.logger,g+":"),x.warn=R.logger.warn.bind(R.logger,g+":"),x.hls=y,x.fragmentLoader=new p.default(y.config),x.fragmentTracker=T,x.config=y.config,x.decrypter=new d.default(y,y.config),y.on(A.Events.KEY_LOADED,x.onKeyLoaded,r(x)),y.on(A.Events.LEVEL_SWITCHING,x.onLevelSwitching,r(x)),x}var P=L.prototype;return P.doTick=function(){this.onTickEnd()},P.onTickEnd=function(){},P.startLoad=function(T){},P.stopLoad=function(){this.fragmentLoader.abort();var T=this.fragCurrent;T&&this.fragmentTracker.removeFragment(T),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=i.STOPPED},P._streamEnded=function(T,g){var x=this.fragCurrent,I=this.fragmentTracker;if(!g.live&&x&&this.media&&x.sn>=g.endSN&&!T.nextStart){var U=g.partList;if(U!=null&&U.length){var b=U[U.length-1],B=M.BufferHelper.isBuffered(this.media,b.start+b.duration/2);return B}var _=I.getState(x);return _===D.FragmentState.PARTIAL||_===D.FragmentState.OK}return!1},P.onMediaAttached=function(T,g){var x=this.media=this.mediaBuffer=g.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),x.addEventListener("seeking",this.onvseeking),x.addEventListener("ended",this.onvended);var I=this.config;this.levels&&I.autoStartLoad&&this.state===i.STOPPED&&this.startLoad(I.startPosition)},P.onMediaDetaching=function(){var T=this.media;T!=null&&T.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),T&&this.onvseeking&&this.onvended&&(T.removeEventListener("seeking",this.onvseeking),T.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},P.onMediaSeeking=function(){var T=this.config,g=this.fragCurrent,x=this.media,I=this.mediaBuffer,U=this.state,b=x?x.currentTime:0,B=M.BufferHelper.bufferInfo(I||x,b,T.maxBufferHole);if(this.log("media seeking to "+(Object(F.isFiniteNumber)(b)?b.toFixed(3):b)+", state: "+U),U===i.ENDED)this.resetLoadingState();else if(g&&!B.len){var _=T.maxFragLookUpTolerance,k=g.start-_,N=g.start+g.duration+_,K=b>N;(b<k||K)&&(K&&g.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),g.loader.abort()),this.resetLoadingState())}x&&(this.lastCurrentTime=b),!this.loadedmetadata&&!B.len&&(this.nextLoadPosition=this.startPosition=b),this.tickImmediate()},P.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},P.onKeyLoaded=function(T,g){if(!(this.state!==i.KEY_LOADING||g.frag!==this.fragCurrent||!this.levels)){this.state=i.IDLE;var x=this.levels[g.frag.level].details;x&&this.loadFragment(g.frag,x,g.frag.start)}},P.onLevelSwitching=function(T,g){this.fragLoadError=0},P.onHandlerDestroying=function(){this.stopLoad(),m.prototype.onHandlerDestroying.call(this)},P.onHandlerDestroyed=function(){this.state=i.STOPPED,this.hls.off(A.Events.KEY_LOADED,this.onKeyLoaded,this),this.hls.off(A.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,m.prototype.onHandlerDestroyed.call(this)},P.loadKey=function(T,g){this.log("Loading key for "+T.sn+" of ["+g.startSN+"-"+g.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+T.level),this.state=i.KEY_LOADING,this.fragCurrent=T,this.hls.trigger(A.Events.KEY_LOADING,{frag:T})},P.loadFragment=function(T,g,x){this._loadFragForPlayback(T,g,x)},P._loadFragForPlayback=function(T,g,x){var I=this,U=function(B){if(I.fragContextChanged(T)){I.warn("Fragment "+T.sn+(B.part?" p: "+B.part.index:"")+" of level "+T.level+" was dropped during download."),I.fragmentTracker.removeFragment(T);return}T.stats.chunkCount++,I._handleFragmentLoadProgress(B)};this._doFragLoad(T,g,x,U).then(function(b){if(!!b){I.fragLoadError=0;var B=I.state;if(I.fragContextChanged(T)){(B===i.FRAG_LOADING||!I.fragCurrent&&B===i.PARSING)&&(I.fragmentTracker.removeFragment(T),I.state=i.IDLE);return}"payload"in b&&(I.log("Loaded fragment "+T.sn+" of level "+T.level),I.hls.trigger(A.Events.FRAG_LOADED,b)),I._handleFragmentLoadComplete(b)}}).catch(function(b){I.state===i.STOPPED||I.state===i.ERROR||(I.warn(b),I.resetFragmentLoading(T))})},P.flushMainBuffer=function(T,g,x){if(x===void 0&&(x=null),!!(T-g)){var I={startOffset:T,endOffset:g,type:x};this.fragLoadError=0,this.hls.trigger(A.Events.BUFFER_FLUSHING,I)}},P._loadInitSegment=function(T){var g=this;this._doFragLoad(T).then(function(x){if(!x||g.fragContextChanged(T)||!g.levels)throw new Error("init load aborted");return x}).then(function(x){var I=g.hls,U=x.payload,b=T.decryptdata;if(U&&U.byteLength>0&&b&&b.key&&b.iv&&b.method==="AES-128"){var B=self.performance.now();return g.decrypter.webCryptoDecrypt(new Uint8Array(U),b.key.buffer,b.iv.buffer).then(function(_){var k=self.performance.now();return I.trigger(A.Events.FRAG_DECRYPTED,{frag:T,payload:_,stats:{tstart:B,tdecrypt:k}}),x.payload=_,x})}return x}).then(function(x){var I=g.fragCurrent,U=g.hls,b=g.levels;if(!b)throw new Error("init load aborted, missing levels");var B=b[T.level].details;console.assert(B,"Level details are defined when init segment is loaded");var _=T.stats;g.state=i.IDLE,g.fragLoadError=0,T.data=new Uint8Array(x.payload),_.parsing.start=_.buffering.start=self.performance.now(),_.parsing.end=_.buffering.end=self.performance.now(),x.frag===I&&U.trigger(A.Events.FRAG_BUFFERED,{stats:_,frag:I,part:null,id:T.type}),g.tick()}).catch(function(x){g.state===i.STOPPED||g.state===i.ERROR||(g.warn(x),g.resetFragmentLoading(T))})},P.fragContextChanged=function(T){var g=this.fragCurrent;return!T||!g||T.level!==g.level||T.sn!==g.sn||T.urlId!==g.urlId},P.fragBufferedComplete=function(T,g){var x=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+T.type+" sn: "+T.sn+(g?" part: "+g.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+T.level+" "+(x?n.default.toString(M.BufferHelper.getBuffered(x)):"(detached)")),this.state=i.IDLE,x&&(!this.loadedmetadata&&x.buffered.length&&this.fragCurrent===this.fragPrevious&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},P.seekToStartPos=function(){},P._handleFragmentLoadComplete=function(T){var g=this.transmuxer;if(!!g){var x=T.frag,I=T.part,U=T.partsLoaded,b=!U||U.length===0||U.some(function(_){return!_}),B=new a.ChunkMetadata(x.level,x.sn,x.stats.chunkCount+1,0,I?I.index:-1,!b);g.flush(B)}},P._handleFragmentLoadProgress=function(T){},P._doFragLoad=function(T,g,x,I){var U=this;if(x===void 0&&(x=null),!this.levels)throw new Error("frag load aborted, missing levels");if(x=Math.max(T.start,x||0),this.config.lowLatencyMode&&g){var b=g.partList;if(b&&I){x>T.end&&g.fragmentHint&&(T=g.fragmentHint);var B=this.getNextPart(b,T,x);if(B>-1){var _=b[B];return this.log("Loading part sn: "+T.sn+" p: "+_.index+" cc: "+T.cc+" of playlist ["+g.startSN+"-"+g.endSN+"] parts [0-"+B+"-"+(b.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+T.level+", target: "+parseFloat(x.toFixed(3))),this.nextLoadPosition=_.start+_.duration,this.state=i.FRAG_LOADING,this.hls.trigger(A.Events.FRAG_LOADING,{frag:T,part:b[B],targetBufferTime:x}),this.doFragPartsLoad(T,b,B,I).catch(function(k){return U.handleFragLoadError(k)})}else if(!T.url||this.loadedEndOfParts(b,x))return Promise.resolve(null)}}return this.log("Loading fragment "+T.sn+" cc: "+T.cc+" "+(g?"of ["+g.startSN+"-"+g.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+T.level+", target: "+parseFloat(x.toFixed(3))),Object(F.isFiniteNumber)(T.sn)&&!this.bitrateTest&&(this.nextLoadPosition=T.start+T.duration),this.state=i.FRAG_LOADING,this.hls.trigger(A.Events.FRAG_LOADING,{frag:T,targetBufferTime:x}),this.fragmentLoader.load(T,I).catch(function(k){return U.handleFragLoadError(k)})},P.doFragPartsLoad=function(T,g,x,I){var U=this;return new Promise(function(b,B){var _=[],k=function N(K){var W=g[K];U.fragmentLoader.loadPart(T,W,I).then(function(j){_[W.index]=j;var H=j.part;U.hls.trigger(A.Events.FRAG_LOADED,j);var Y=g[K+1];if(Y&&Y.fragment===T)N(K+1);else return b({frag:T,part:H,partsLoaded:_})}).catch(B)};k(x)})},P.handleFragLoadError=function(T){var g=T.data;return g&&g.details===c.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(g.frag,g.part):this.hls.trigger(A.Events.ERROR,g),null},P._handleTransmuxerFlush=function(T){var g=this.getCurrentContext(T);if(!g||this.state!==i.PARSING){this.fragCurrent||(this.state=i.IDLE);return}var x=g.frag,I=g.part,U=g.level,b=self.performance.now();x.stats.parsing.end=b,I&&(I.stats.parsing.end=b),this.updateLevelTiming(x,I,U,T.partial)},P.getCurrentContext=function(T){var g=this.levels,x=T.level,I=T.sn,U=T.part;if(!g||!g[x])return this.warn("Levels object was unset while buffering fragment "+I+" of level "+x+". The current chunk will not be buffered."),null;var b=g[x],B=U>-1?Object(v.getPartWith)(b,I,U):null,_=B?B.fragment:Object(v.getFragmentWithSN)(b,I,this.fragCurrent);return _?{frag:_,part:B,level:b}:null},P.bufferFragmentData=function(T,g,x,I){if(!(!T||this.state!==i.PARSING)){var U=T.data1,b=T.data2,B=U;if(U&&b&&(B=Object(l.appendUint8Array)(U,b)),!(!B||!B.length)){var _={type:T.type,frag:g,part:x,chunkMeta:I,parent:g.type,data:B};this.hls.trigger(A.Events.BUFFER_APPENDING,_),T.dropped&&T.independent&&!x&&this.flushBufferGap(g)}}},P.flushBufferGap=function(T){var g=this.media;if(!!g){if(!M.BufferHelper.isBuffered(g,g.currentTime)){this.flushMainBuffer(0,T.start);return}var x=g.currentTime,I=M.BufferHelper.bufferInfo(g,x,0),U=T.duration,b=Math.min(this.config.maxFragLookUpTolerance*2,U*.25),B=Math.max(Math.min(T.start-b,I.end-b),x+b);T.start-B>b&&this.flushMainBuffer(B,T.start)}},P.getFwdBufferInfo=function(T,g){var x=this.config,I=this.getLoadPosition();if(!Object(F.isFiniteNumber)(I))return null;var U=M.BufferHelper.bufferInfo(T,I,x.maxBufferHole);if(U.len===0&&U.nextStart!==void 0){var b=this.fragmentTracker.getBufferedFrag(I,g);if(b&&U.nextStart<b.end)return M.BufferHelper.bufferInfo(T,I,Math.max(U.nextStart,x.maxBufferHole))}return U},P.getMaxBufferLength=function(T){var g=this.config,x;return T?x=Math.max(8*g.maxBufferSize/T,g.maxBufferLength):x=g.maxBufferLength,Math.min(x,g.maxMaxBufferLength)},P.reduceMaxBufferLength=function(T){var g=this.config,x=T||g.maxBufferLength;return g.maxMaxBufferLength>=x?(g.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+g.maxMaxBufferLength+"s"),!0):!1},P.getNextFragment=function(T,g){var x=g.fragments,I=x.length;if(!I)return null;var U=this.config,b=x[0].start,B;if(g.live){var _=U.initialLiveManifestSize;if(I<_)return this.warn("Not enough fragments to start playback (have: "+I+", need: "+_+")"),null;!g.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(B=this.getInitialLiveFragment(g,x),this.startPosition=B?this.hls.liveSyncPosition||B.start:T)}else T<=b&&(B=x[0]);if(!B){var k=U.lowLatencyMode?g.partEnd:g.fragmentEnd;B=this.getFragmentAtPosition(T,k,g)}return this.mapToInitFragWhenRequired(B)},P.mapToInitFragWhenRequired=function(T){return T!=null&&T.initSegment&&!(T!=null&&T.initSegment.data)&&!this.bitrateTest?T.initSegment:T},P.getNextPart=function(T,g,x){for(var I=-1,U=!1,b=!0,B=0,_=T.length;B<_;B++){var k=T[B];if(b=b&&!k.independent,I>-1&&x<k.start)break;var N=k.loaded;!N&&(U||k.independent||b)&&k.fragment===g&&(I=B),U=N}return I},P.loadedEndOfParts=function(T,g){var x=T[T.length-1];return x&&g>x.start&&x.loaded},P.getInitialLiveFragment=function(T,g){var x=this.fragPrevious,I=null;if(x){if(T.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+x.programDateTime),I=Object(S.findFragmentByPDT)(g,x.endProgramDateTime,this.config.maxFragLookUpTolerance)),!I){var U=x.sn+1;if(U>=T.startSN&&U<=T.endSN){var b=g[U-T.startSN];x.cc===b.cc&&(I=b,this.log("Live playlist, switching playlist, load frag with next SN: "+I.sn))}I||(I=Object(S.findFragWithCC)(g,x.cc),I&&this.log("Live playlist, switching playlist, load frag with same CC: "+I.sn))}}else{var B=this.hls.liveSyncPosition;B!==null&&(I=this.getFragmentAtPosition(B,this.bitrateTest?T.fragmentEnd:T.edge,T))}return I},P.getFragmentAtPosition=function(T,g,x){var I=this.config,U=this.fragPrevious,b=x.fragments,B=x.endSN,_=x.fragmentHint,k=I.maxFragLookUpTolerance,N=!!(I.lowLatencyMode&&x.partList&&_);N&&_&&!this.bitrateTest&&(b=b.concat(_),B=_.sn);var K;if(T<g){var W=T>g-k?0:k;K=Object(S.findFragmentByPTS)(U,b,T,W)}else K=b[b.length-1];if(K){var j=K.sn-x.startSN;if(U&&K.sn===U.sn&&!N){var H=U&&K.level===U.level;if(H){var Y=b[j+1];K.sn<B&&this.fragmentTracker.getState(Y)!==D.FragmentState.OK?(this.log("SN "+K.sn+" just loaded, load next one: "+Y.sn),K=Y):K=null}}}return K},P.synchronizeToLiveEdge=function(T){var g=this.config,x=this.media;if(!!x){var I=this.hls.liveSyncPosition,U=x.currentTime,b=T.fragments[0].start,B=T.edge,_=U>=b-g.maxFragLookUpTolerance&&U<=B;if(I!==null&&x.duration>I&&(U<I||!_)){var k=g.liveMaxLatencyDuration!==void 0?g.liveMaxLatencyDuration:g.liveMaxLatencyDurationCount*T.targetduration;(!_&&x.readyState<4||U<B-k)&&(this.loadedmetadata||(this.nextLoadPosition=I),x.readyState&&(this.warn("Playback: "+U.toFixed(3)+" is located too far from the end of live sliding playlist: "+B+", reset currentTime to : "+I.toFixed(3)),x.currentTime=I))}}},P.alignPlaylists=function(T,g){var x=this.levels,I=this.levelLastLoaded,U=this.fragPrevious,b=I!==null?x[I]:null,B=T.fragments.length;if(!B)return this.warn("No fragments in live playlist"),0;var _=T.fragments[0].start,k=!g,N=T.alignedSliding&&Object(F.isFiniteNumber)(_);if(k||!N&&!_){Object(s.alignStream)(U,b,T);var K=T.fragments[0].start;return this.log("Live playlist sliding: "+K.toFixed(2)+" start-sn: "+(g?g.startSN:"na")+"->"+T.startSN+" prev-sn: "+(U?U.sn:"na")+" fragments: "+B),K}return _},P.waitForCdnTuneIn=function(T){var g=3;return T.live&&T.canBlockReload&&T.partTarget&&T.tuneInGoal>Math.max(T.partHoldBack,T.partTarget*g)},P.setStartPosition=function(T,g){var x=this.startPosition;if(x<g&&(x=-1),x===-1||this.lastCurrentTime===-1){var I=T.startTimeOffset;Object(F.isFiniteNumber)(I)?(x=g+I,I<0&&(x+=T.totalduration),x=Math.min(Math.max(g,x),g+T.totalduration),this.log("Start time offset "+I+" found in playlist, adjust startPosition to "+x),this.startPosition=x):T.live?x=this.hls.liveSyncPosition||g:this.startPosition=x=0,this.lastCurrentTime=x}this.nextLoadPosition=x},P.getLoadPosition=function(){var T=this.media,g=0;return this.loadedmetadata&&T?g=T.currentTime:this.nextLoadPosition&&(g=this.nextLoadPosition),g},P.handleFragLoadAborted=function(T,g){this.transmuxer&&T.sn!=="initSegment"&&T.stats.aborted&&(this.warn("Fragment "+T.sn+(g?" part"+g.index:"")+" of level "+T.level+" was aborted"),this.resetFragmentLoading(T))},P.resetFragmentLoading=function(T){(!this.fragCurrent||!this.fragContextChanged(T)&&this.state!==i.FRAG_LOADING_WAITING_RETRY)&&(this.state=i.IDLE)},P.onFragmentOrKeyLoadError=function(T,g){if(!g.fatal){var x=g.frag;if(!(!x||x.type!==T)){var I=this.fragCurrent;console.assert(I&&x.sn===I.sn&&x.level===I.level&&x.urlId===I.urlId,"Frag load error must match current frag to retry");var U=this.config;if(this.fragLoadError+1<=U.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var b=Math.min(Math.pow(2,this.fragLoadError)*U.fragLoadingRetryDelay,U.fragLoadingMaxRetryTimeout);this.warn("Fragment "+x.sn+" of "+T+" "+x.level+" failed to load, retrying in "+b+"ms"),this.retryDate=self.performance.now()+b,this.fragLoadError++,this.state=i.FRAG_LOADING_WAITING_RETRY}else g.levelRetry?(T===u.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=i.IDLE):(R.logger.error(g.details+" reaches max retry, redispatch as fatal ..."),g.fatal=!0,this.hls.stopLoad(),this.state=i.ERROR)}}},P.afterBufferFlushed=function(T,g,x){if(!!T){var I=M.BufferHelper.getBuffered(T);this.fragmentTracker.detectEvictedFragments(g,I,x),this.state===i.ENDED&&this.resetLoadingState()}},P.resetLoadingState=function(){this.fragCurrent=null,this.fragPrevious=null,this.state=i.IDLE},P.resetStartWhenNotLoaded=function(T){if(!this.loadedmetadata){this.startFragRequested=!1;var g=this.levels?this.levels[T].details:null;g!=null&&g.live?(this.startPosition=-1,this.setStartPosition(g,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},P.updateLevelTiming=function(T,g,x,I){var U=this,b=x.details;console.assert(!!b,"level.details must be defined");var B=Object.keys(T.elementaryStreams).reduce(function(_,k){var N=T.elementaryStreams[k];if(N){var K=N.endPTS-N.startPTS;if(K<=0)return U.warn("Could not parse fragment "+T.sn+" "+k+" duration reliably ("+K+")"),_||!1;var W=I?0:Object(v.updateFragPTSDTS)(b,T,N.startPTS,N.endPTS,N.startDTS,N.endDTS);return U.hls.trigger(A.Events.LEVEL_PTS_UPDATED,{details:b,level:x,drift:W,type:k,frag:T,start:N.startPTS,end:N.endPTS}),!0}return _},!1);B||(this.warn("Found no media in fragment "+T.sn+" of level "+x.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=i.PARSED,this.hls.trigger(A.Events.FRAG_PARSED,{frag:T,part:g})},P.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},E(L,[{key:"state",get:function(){return this._state},set:function(T){var g=this._state;g!==T&&(this._state=T,this.log(g+"->"+T))}}]),L}(O.default)},"./src/controller/buffer-controller.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return S});var F=h("./src/polyfills/number.ts"),O=h("./src/events.ts"),D=h("./src/utils/logger.ts"),M=h("./src/errors.ts"),R=h("./src/utils/buffer-helper.ts"),A=h("./src/utils/mediasource-helper.ts"),c=h("./src/loader/fragment.ts"),a=h("./src/controller/buffer-operation-queue.ts"),l=Object(A.getMediaSource)(),s=/([ha]vc.)(?:\.[^.,]+)+/,S=function(){function v(d){var n=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var u=n.hls,f=n.media,E=n.mediaSource;D.logger.log("[buffer-controller]: Media source opened"),f&&(n.updateMediaElementDuration(),u.trigger(O.Events.MEDIA_ATTACHED,{media:f})),E&&E.removeEventListener("sourceopen",n._onMediaSourceOpen),n.checkPendingTracks()},this._onMediaSourceClose=function(){D.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){D.logger.log("[buffer-controller]: Media source ended")},this.hls=d,this._initSourceBuffer(),this.registerListeners()}var p=v.prototype;return p.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},p.destroy=function(){this.unregisterListeners(),this.details=null},p.registerListeners=function(){var n=this.hls;n.on(O.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.on(O.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(O.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.on(O.Events.BUFFER_RESET,this.onBufferReset,this),n.on(O.Events.BUFFER_APPENDING,this.onBufferAppending,this),n.on(O.Events.BUFFER_CODECS,this.onBufferCodecs,this),n.on(O.Events.BUFFER_EOS,this.onBufferEos,this),n.on(O.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.on(O.Events.LEVEL_UPDATED,this.onLevelUpdated,this),n.on(O.Events.FRAG_PARSED,this.onFragParsed,this),n.on(O.Events.FRAG_CHANGED,this.onFragChanged,this)},p.unregisterListeners=function(){var n=this.hls;n.off(O.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.off(O.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.off(O.Events.MANIFEST_PARSED,this.onManifestParsed,this),n.off(O.Events.BUFFER_RESET,this.onBufferReset,this),n.off(O.Events.BUFFER_APPENDING,this.onBufferAppending,this),n.off(O.Events.BUFFER_CODECS,this.onBufferCodecs,this),n.off(O.Events.BUFFER_EOS,this.onBufferEos,this),n.off(O.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.off(O.Events.LEVEL_UPDATED,this.onLevelUpdated,this),n.off(O.Events.FRAG_PARSED,this.onFragParsed,this),n.off(O.Events.FRAG_CHANGED,this.onFragChanged,this)},p._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new a.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},p.onManifestParsed=function(n,u){var f=2;(u.audio&&!u.video||!u.altAudio)&&(f=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=f,this.details=null,D.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},p.onMediaAttaching=function(n,u){var f=this.media=u.media;if(f&&l){var E=this.mediaSource=new l;E.addEventListener("sourceopen",this._onMediaSourceOpen),E.addEventListener("sourceended",this._onMediaSourceEnded),E.addEventListener("sourceclose",this._onMediaSourceClose),f.src=self.URL.createObjectURL(E),this._objectUrl=f.src}},p.onMediaDetaching=function(){var n=this.media,u=this.mediaSource,f=this._objectUrl;if(u){if(D.logger.log("[buffer-controller]: media source detaching"),u.readyState==="open")try{u.endOfStream()}catch(E){D.logger.warn("[buffer-controller]: onMediaDetaching: "+E.message+" while calling endOfStream")}this.onBufferReset(),u.removeEventListener("sourceopen",this._onMediaSourceOpen),u.removeEventListener("sourceended",this._onMediaSourceEnded),u.removeEventListener("sourceclose",this._onMediaSourceClose),n&&(f&&self.URL.revokeObjectURL(f),n.src===f?(n.removeAttribute("src"),n.load()):D.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(O.Events.MEDIA_DETACHED,void 0)},p.onBufferReset=function(){var n=this;this.getSourceBufferTypes().forEach(function(u){var f=n.sourceBuffer[u];try{f&&(n.removeBufferListeners(u),n.mediaSource&&n.mediaSource.removeSourceBuffer(f),n.sourceBuffer[u]=void 0)}catch(E){D.logger.warn("[buffer-controller]: Failed to reset the "+u+" buffer",E)}}),this._initSourceBuffer()},p.onBufferCodecs=function(n,u){var f=this,E=this.getSourceBufferTypes().length;Object.keys(u).forEach(function(r){if(E){var e=f.tracks[r];if(e&&typeof e.buffer.changeType=="function"){var t=u[r],i=t.id,o=t.codec,m=t.levelCodec,L=t.container,P=t.metadata,y=(e.levelCodec||e.codec).replace(s,"$1"),T=(m||o).replace(s,"$1");if(y!==T){var g=L+";codecs="+(m||o);f.appendChangeType(r,g),D.logger.log("[buffer-controller]: switching codec "+y+" to "+T),f.tracks[r]={buffer:e.buffer,codec:o,container:L,levelCodec:m,metadata:P,id:i}}}}else f.pendingTracks[r]=u[r]}),!E&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},p.appendChangeType=function(n,u){var f=this,E=this.operationQueue,r={execute:function(){var t=f.sourceBuffer[n];t&&(D.logger.log("[buffer-controller]: changing "+n+" sourceBuffer type to "+u),t.changeType(u)),E.shiftAndExecuteNext(n)},onStart:function(){},onComplete:function(){},onError:function(t){D.logger.warn("[buffer-controller]: Failed to change "+n+" SourceBuffer type",t)}};E.append(r,n)},p.onBufferAppending=function(n,u){var f=this,E=this.hls,r=this.operationQueue,e=this.tracks,t=u.data,i=u.type,o=u.frag,m=u.part,L=u.chunkMeta,P=L.buffering[i],y=self.performance.now();P.start=y;var T=o.stats.buffering,g=m?m.stats.buffering:null;T.start===0&&(T.start=y),g&&g.start===0&&(g.start=y);var x=e.audio,I=i==="audio"&&L.id===1&&(x==null?void 0:x.container)==="audio/mpeg",U={execute:function(){if(P.executeStart=self.performance.now(),I){var B=f.sourceBuffer[i];if(B){var _=o.start-B.timestampOffset;Math.abs(_)>=.1&&(D.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+o.start+" (delta: "+_+") sn: "+o.sn+")"),B.timestampOffset=o.start)}}f.appendExecutor(t,i)},onStart:function(){},onComplete:function(){var B=self.performance.now();P.executeEnd=P.end=B,T.first===0&&(T.first=B),g&&g.first===0&&(g.first=B);var _=f.sourceBuffer,k={};for(var N in _)k[N]=R.BufferHelper.getBuffered(_[N]);f.appendError=0,f.hls.trigger(O.Events.BUFFER_APPENDED,{type:i,frag:o,part:m,chunkMeta:L,parent:o.type,timeRanges:k})},onError:function(B){D.logger.error("[buffer-controller]: Error encountered while trying to append to the "+i+" SourceBuffer",B);var _={type:M.ErrorTypes.MEDIA_ERROR,parent:o.type,details:M.ErrorDetails.BUFFER_APPEND_ERROR,err:B,fatal:!1};B.code===DOMException.QUOTA_EXCEEDED_ERR?_.details=M.ErrorDetails.BUFFER_FULL_ERROR:(f.appendError++,_.details=M.ErrorDetails.BUFFER_APPEND_ERROR,f.appendError>E.config.appendErrorMaxRetry&&(D.logger.error("[buffer-controller]: Failed "+E.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),_.fatal=!0,E.stopLoad())),E.trigger(O.Events.ERROR,_)}};r.append(U,i)},p.onBufferFlushing=function(n,u){var f=this,E=this.operationQueue,r=function(t){return{execute:f.removeExecutor.bind(f,t,u.startOffset,u.endOffset),onStart:function(){},onComplete:function(){f.hls.trigger(O.Events.BUFFER_FLUSHED,{type:t})},onError:function(o){D.logger.warn("[buffer-controller]: Failed to remove from "+t+" SourceBuffer",o)}}};u.type?E.append(r(u.type),u.type):this.getSourceBufferTypes().forEach(function(e){E.append(r(e),e)})},p.onFragParsed=function(n,u){var f=this,E=u.frag,r=u.part,e=[],t=r?r.elementaryStreams:E.elementaryStreams;t[c.ElementaryStreamTypes.AUDIOVIDEO]?e.push("audiovideo"):(t[c.ElementaryStreamTypes.AUDIO]&&e.push("audio"),t[c.ElementaryStreamTypes.VIDEO]&&e.push("video"));var i=function(){var m=self.performance.now();E.stats.buffering.end=m,r&&(r.stats.buffering.end=m);var L=r?r.stats:E.stats;f.hls.trigger(O.Events.FRAG_BUFFERED,{frag:E,part:r,stats:L,id:E.type})};e.length===0&&D.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+E.type+" level: "+E.level+" sn: "+E.sn),this.blockBuffers(i,e)},p.onFragChanged=function(n,u){this.flushBackBuffer()},p.onBufferEos=function(n,u){var f=this,E=this.getSourceBufferTypes().reduce(function(r,e){var t=f.sourceBuffer[e];return(!u.type||u.type===e)&&t&&!t.ended&&(t.ended=!0,D.logger.log("[buffer-controller]: "+e+" sourceBuffer now EOS")),r&&!!(!t||t.ended)},!0);E&&this.blockBuffers(function(){var r=f.mediaSource;!r||r.readyState!=="open"||r.endOfStream()})},p.onLevelUpdated=function(n,u){var f=u.details;!f.fragments.length||(this.details=f,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},p.flushBackBuffer=function(){var n=this.hls,u=this.details,f=this.media,E=this.sourceBuffer;if(!(!f||u===null)){var r=this.getSourceBufferTypes();if(!!r.length){var e=u.live&&n.config.liveBackBufferLength!==null?n.config.liveBackBufferLength:n.config.backBufferLength;if(!(!Object(F.isFiniteNumber)(e)||e<0)){var t=f.currentTime,i=u.levelTargetDuration,o=Math.max(e,i),m=Math.floor(t/i)*i-o;r.forEach(function(L){var P=E[L];if(P){var y=R.BufferHelper.getBuffered(P);y.length>0&&m>y.start(0)&&(n.trigger(O.Events.BACK_BUFFER_REACHED,{bufferEnd:m}),u.live&&n.trigger(O.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:m}),n.trigger(O.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:m,type:L}))}})}}}},p.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")){var n=this.details,u=this.hls,f=this.media,E=this.mediaSource,r=n.fragments[0].start+n.totalduration,e=f.duration,t=Object(F.isFiniteNumber)(E.duration)?E.duration:0;n.live&&u.config.liveDurationInfinity?(D.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),E.duration=1/0,this.updateSeekableRange(n)):(r>t&&r>e||!Object(F.isFiniteNumber)(e))&&(D.logger.log("[buffer-controller]: Updating Media Source duration to "+r.toFixed(3)),E.duration=r)}},p.updateSeekableRange=function(n){var u=this.mediaSource,f=n.fragments,E=f.length;if(E&&n.live&&u!==null&&u!==void 0&&u.setLiveSeekableRange){var r=Math.max(0,f[0].start),e=Math.max(r,r+n.totalduration);u.setLiveSeekableRange(r,e)}},p.checkPendingTracks=function(){var n=this.bufferCodecEventsExpected,u=this.operationQueue,f=this.pendingTracks,E=Object.keys(f).length;if(E&&!n||E===2){this.createSourceBuffers(f),this.pendingTracks={};var r=this.getSourceBufferTypes();if(r.length===0){this.hls.trigger(O.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}r.forEach(function(e){u.executeNext(e)})}},p.createSourceBuffers=function(n){var u=this.sourceBuffer,f=this.mediaSource;if(!f)throw Error("createSourceBuffers called when mediaSource was null");var E=0;for(var r in n)if(!u[r]){var e=n[r];if(!e)throw Error("source buffer exists for track "+r+", however track does not");var t=e.levelCodec||e.codec,i=e.container+";codecs="+t;D.logger.log("[buffer-controller]: creating sourceBuffer("+i+")");try{var o=u[r]=f.addSourceBuffer(i),m=r;this.addBufferListener(m,"updatestart",this._onSBUpdateStart),this.addBufferListener(m,"updateend",this._onSBUpdateEnd),this.addBufferListener(m,"error",this._onSBUpdateError),this.tracks[r]={buffer:o,codec:t,container:e.container,levelCodec:e.levelCodec,metadata:e.metadata,id:e.id},E++}catch(L){D.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+L.message),this.hls.trigger(O.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:L,mimeType:i})}}E&&this.hls.trigger(O.Events.BUFFER_CREATED,{tracks:this.tracks})},p._onSBUpdateStart=function(n){var u=this.operationQueue,f=u.current(n);f.onStart()},p._onSBUpdateEnd=function(n){var u=this.operationQueue,f=u.current(n);f.onComplete(),u.shiftAndExecuteNext(n)},p._onSBUpdateError=function(n,u){D.logger.error("[buffer-controller]: "+n+" SourceBuffer error",u),this.hls.trigger(O.Events.ERROR,{type:M.ErrorTypes.MEDIA_ERROR,details:M.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var f=this.operationQueue.current(n);f&&f.onError(u)},p.removeExecutor=function(n,u,f){var E=this.media,r=this.mediaSource,e=this.operationQueue,t=this.sourceBuffer,i=t[n];if(!E||!r||!i){D.logger.warn("[buffer-controller]: Attempting to remove from the "+n+" SourceBuffer, but it does not exist"),e.shiftAndExecuteNext(n);return}var o=Object(F.isFiniteNumber)(E.duration)?E.duration:1/0,m=Object(F.isFiniteNumber)(r.duration)?r.duration:1/0,L=Math.max(0,u),P=Math.min(f,o,m);P>L?(D.logger.log("[buffer-controller]: Removing ["+L+","+P+"] from the "+n+" SourceBuffer"),console.assert(!i.updating,n+" sourceBuffer must not be updating"),i.remove(L,P)):e.shiftAndExecuteNext(n)},p.appendExecutor=function(n,u){var f=this.operationQueue,E=this.sourceBuffer,r=E[u];if(!r){D.logger.warn("[buffer-controller]: Attempting to append to the "+u+" SourceBuffer, but it does not exist"),f.shiftAndExecuteNext(u);return}r.ended=!1,console.assert(!r.updating,u+" sourceBuffer must not be updating"),r.appendBuffer(n)},p.blockBuffers=function(n,u){var f=this;if(u===void 0&&(u=this.getSourceBufferTypes()),!u.length){D.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(n);return}var E=this.operationQueue,r=u.map(function(e){return E.appendBlocker(e)});Promise.all(r).then(function(){n(),u.forEach(function(e){var t=f.sourceBuffer[e];(!t||!t.updating)&&E.shiftAndExecuteNext(e)})})},p.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},p.addBufferListener=function(n,u,f){var E=this.sourceBuffer[n];if(!!E){var r=f.bind(this,n);this.listeners[n].push({event:u,listener:r}),E.addEventListener(u,r)}},p.removeBufferListeners=function(n){var u=this.sourceBuffer[n];!u||this.listeners[n].forEach(function(f){u.removeEventListener(f.event,f.listener)})},v}()},"./src/controller/buffer-operation-queue.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return O});var F=h("./src/utils/logger.ts"),O=function(){function D(R){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=R}var M=D.prototype;return M.append=function(A,c){var a=this.queues[c];a.push(A),a.length===1&&this.buffers[c]&&this.executeNext(c)},M.insertAbort=function(A,c){var a=this.queues[c];a.unshift(A),this.executeNext(c)},M.appendBlocker=function(A){var c,a=new Promise(function(s){c=s}),l={execute:c,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(l,A),a},M.executeNext=function(A){var c=this.buffers,a=this.queues,l=c[A],s=a[A];if(s.length){var S=s[0];try{S.execute()}catch(v){F.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),S.onError(v),(!l||!l.updating)&&(s.shift(),this.executeNext(A))}}},M.shiftAndExecuteNext=function(A){this.queues[A].shift(),this.executeNext(A)},M.current=function(A){return this.queues[A][0]},D}()},"./src/controller/cap-level-controller.ts":function(w,C,h){h.r(C);var F=h("./src/events.ts");function O(R,A){for(var c=0;c<A.length;c++){var a=A[c];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(R,a.key,a)}}function D(R,A,c){return A&&O(R.prototype,A),c&&O(R,c),Object.defineProperty(R,"prototype",{writable:!1}),R}var M=function(){function R(c){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=c,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var A=R.prototype;return A.setStreamController=function(a){this.streamController=a},A.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},A.registerListeners=function(){var a=this.hls;a.on(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),a.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),a.on(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),a.on(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),a.on(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},A.unregisterListener=function(){var a=this.hls;a.off(F.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),a.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),a.off(F.Events.MANIFEST_PARSED,this.onManifestParsed,this),a.off(F.Events.BUFFER_CODECS,this.onBufferCodecs,this),a.off(F.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},A.onFpsDropLevelCapping=function(a,l){R.isLevelAllowed(l.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(l.droppedLevel)},A.onMediaAttaching=function(a,l){this.media=l.media instanceof HTMLVideoElement?l.media:null},A.onManifestParsed=function(a,l){var s=this.hls;this.restrictedLevels=[],this.firstLevel=l.firstLevel,s.config.capLevelToPlayerSize&&l.video&&this.startCapping()},A.onBufferCodecs=function(a,l){var s=this.hls;s.config.capLevelToPlayerSize&&l.video&&this.startCapping()},A.onMediaDetaching=function(){this.stopCapping()},A.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var a=this.hls.levels;if(a.length){var l=this.hls;l.autoLevelCapping=this.getMaxLevel(a.length-1),l.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=l.autoLevelCapping}}},A.getMaxLevel=function(a){var l=this,s=this.hls.levels;if(!s.length)return-1;var S=s.filter(function(v,p){return R.isLevelAllowed(p,l.restrictedLevels)&&p<=a});return this.clientRect=null,R.getMaxLevelByMediaSize(S,this.mediaWidth,this.mediaHeight)},A.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},A.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},A.getDimensions=function(){if(this.clientRect)return this.clientRect;var a=this.media,l={width:0,height:0};if(a){var s=a.getBoundingClientRect();l.width=s.width,l.height=s.height,!l.width&&!l.height&&(l.width=s.right-s.left||a.width||0,l.height=s.bottom-s.top||a.height||0)}return this.clientRect=l,l},R.isLevelAllowed=function(a,l){return l===void 0&&(l=[]),l.indexOf(a)===-1},R.getMaxLevelByMediaSize=function(a,l,s){if(!a||!a.length)return-1;for(var S=function(u,f){return f?u.width!==f.width||u.height!==f.height:!0},v=a.length-1,p=0;p<a.length;p+=1){var d=a[p];if((d.width>=l||d.height>=s)&&S(d,a[p+1])){v=p;break}}return v},D(R,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var a=1;if(!this.hls.config.ignoreDevicePixelRatio)try{a=self.devicePixelRatio}catch{}return a}}]),R}();C.default=M},"./src/controller/fps-controller.ts":function(w,C,h){h.r(C);var F=h("./src/events.ts"),O=h("./src/utils/logger.ts"),D=function(){function M(A){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=A,this.registerListeners()}var R=M.prototype;return R.setStreamController=function(c){this.streamController=c},R.registerListeners=function(){this.hls.on(F.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},R.unregisterListeners=function(){this.hls.off(F.Events.MEDIA_ATTACHING,this.onMediaAttaching)},R.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},R.onMediaAttaching=function(c,a){var l=this.hls.config;if(l.capLevelOnFPSDrop){var s=a.media instanceof self.HTMLVideoElement?a.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),l.fpsDroppedMonitoringPeriod)}},R.checkFPS=function(c,a,l){var s=performance.now();if(a){if(this.lastTime){var S=s-this.lastTime,v=l-this.lastDroppedFrames,p=a-this.lastDecodedFrames,d=1e3*v/S,n=this.hls;if(n.trigger(F.Events.FPS_DROP,{currentDropped:v,currentDecoded:p,totalDroppedFrames:l}),d>0&&v>n.config.fpsDroppedMonitoringThreshold*p){var u=n.currentLevel;O.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(n.autoLevelCapping===-1||n.autoLevelCapping>=u)&&(u=u-1,n.trigger(F.Events.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:n.currentLevel}),n.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=l,this.lastDecodedFrames=a}},R.checkFPSInterval=function(){var c=this.media;if(c)if(this.isVideoPlaybackQualityAvailable){var a=c.getVideoPlaybackQuality();this.checkFPS(c,a.totalVideoFrames,a.droppedVideoFrames)}else this.checkFPS(c,c.webkitDecodedFrameCount,c.webkitDroppedFrameCount)},M}();C.default=D},"./src/controller/fragment-finders.ts":function(w,C,h){h.r(C),h.d(C,"findFragmentByPDT",function(){return D}),h.d(C,"findFragmentByPTS",function(){return M}),h.d(C,"fragmentWithinToleranceTest",function(){return R}),h.d(C,"pdtWithinToleranceTest",function(){return A}),h.d(C,"findFragWithCC",function(){return c});var F=h("./src/polyfills/number.ts"),O=h("./src/utils/binary-search.ts");function D(a,l,s){if(l===null||!Array.isArray(a)||!a.length||!Object(F.isFiniteNumber)(l))return null;var S=a[0].programDateTime;if(l<(S||0))return null;var v=a[a.length-1].endProgramDateTime;if(l>=(v||0))return null;s=s||0;for(var p=0;p<a.length;++p){var d=a[p];if(A(l,s,d))return d}return null}function M(a,l,s,S){s===void 0&&(s=0),S===void 0&&(S=0);var v=null;if(a?v=l[a.sn-l[0].sn+1]||null:s===0&&l[0].start===0&&(v=l[0]),v&&R(s,S,v)===0)return v;var p=O.default.search(l,R.bind(null,s,S));return p||v}function R(a,l,s){a===void 0&&(a=0),l===void 0&&(l=0);var S=Math.min(l,s.duration+(s.deltaPTS?s.deltaPTS:0));return s.start+s.duration-S<=a?1:s.start-S>a&&s.start?-1:0}function A(a,l,s){var S=Math.min(l,s.duration+(s.deltaPTS?s.deltaPTS:0))*1e3,v=s.endProgramDateTime||0;return v-S>a}function c(a,l){return O.default.search(a,function(s){return s.cc<l?1:s.cc>l?-1:0})}},"./src/controller/fragment-tracker.ts":function(w,C,h){h.r(C),h.d(C,"FragmentState",function(){return D}),h.d(C,"FragmentTracker",function(){return M});var F=h("./src/events.ts"),O=h("./src/types/loader.ts"),D;(function(c){c.NOT_LOADED="NOT_LOADED",c.APPENDING="APPENDING",c.PARTIAL="PARTIAL",c.OK="OK"})(D||(D={}));var M=function(){function c(l){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=l,this._registerListeners()}var a=c.prototype;return a._registerListeners=function(){var s=this.hls;s.on(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),s.on(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.on(F.Events.FRAG_LOADED,this.onFragLoaded,this)},a._unregisterListeners=function(){var s=this.hls;s.off(F.Events.BUFFER_APPENDED,this.onBufferAppended,this),s.off(F.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.off(F.Events.FRAG_LOADED,this.onFragLoaded,this)},a.destroy=function(){this._unregisterListeners(),this.fragments=this.timeRanges=null},a.getAppendedFrag=function(s,S){if(S===O.PlaylistLevelType.MAIN){var v=this.activeFragment,p=this.activeParts;if(!v)return null;if(p)for(var d=p.length;d--;){var n=p[d],u=n?n.end:v.appendedPTS;if(n.start<=s&&u!==void 0&&s<=u)return d>9&&(this.activeParts=p.slice(d-9)),n}else if(v.start<=s&&v.appendedPTS!==void 0&&s<=v.appendedPTS)return v}return this.getBufferedFrag(s,S)},a.getBufferedFrag=function(s,S){for(var v=this.fragments,p=Object.keys(v),d=p.length;d--;){var n=v[p[d]];if((n==null?void 0:n.body.type)===S&&n.buffered){var u=n.body;if(u.start<=s&&s<=u.end)return u}}return null},a.detectEvictedFragments=function(s,S,v){var p=this;Object.keys(this.fragments).forEach(function(d){var n=p.fragments[d];if(!!n){if(!n.buffered){n.body.type===v&&p.removeFragment(n.body);return}var u=n.range[s];!u||u.time.some(function(f){var E=!p.isTimeBuffered(f.startPTS,f.endPTS,S);return E&&p.removeFragment(n.body),E})}})},a.detectPartialFragments=function(s){var S=this,v=this.timeRanges,p=s.frag,d=s.part;if(!(!v||p.sn==="initSegment")){var n=A(p),u=this.fragments[n];!u||(Object.keys(v).forEach(function(f){var E=p.elementaryStreams[f];if(!!E){var r=v[f],e=d!==null||E.partial===!0;u.range[f]=S.getBufferedTimes(p,d,e,r)}}),u.loaded=null,Object.keys(u.range).length?u.buffered=!0:this.removeFragment(u.body))}},a.fragBuffered=function(s){var S=A(s),v=this.fragments[S];v&&(v.loaded=null,v.buffered=!0)},a.getBufferedTimes=function(s,S,v,p){for(var d={time:[],partial:v},n=S?S.start:s.start,u=S?S.end:s.end,f=s.minEndPTS||u,E=s.maxStartPTS||n,r=0;r<p.length;r++){var e=p.start(r)-this.bufferPadding,t=p.end(r)+this.bufferPadding;if(E>=e&&f<=t){d.time.push({startPTS:Math.max(n,p.start(r)),endPTS:Math.min(u,p.end(r))});break}else if(n<t&&u>e)d.partial=!0,d.time.push({startPTS:Math.max(n,p.start(r)),endPTS:Math.min(u,p.end(r))});else if(u<=e)break}return d},a.getPartialFragment=function(s){var S=null,v,p,d,n=0,u=this.bufferPadding,f=this.fragments;return Object.keys(f).forEach(function(E){var r=f[E];!r||R(r)&&(p=r.body.start-u,d=r.body.end+u,s>=p&&s<=d&&(v=Math.min(s-p,d-s),n<=v&&(S=r.body,n=v)))}),S},a.getState=function(s){var S=A(s),v=this.fragments[S];return v?v.buffered?R(v)?D.PARTIAL:D.OK:D.APPENDING:D.NOT_LOADED},a.isTimeBuffered=function(s,S,v){for(var p,d,n=0;n<v.length;n++){if(p=v.start(n)-this.bufferPadding,d=v.end(n)+this.bufferPadding,s>=p&&S<=d)return!0;if(S<=p)return!1}return!1},a.onFragLoaded=function(s,S){var v=S.frag,p=S.part;if(!(v.sn==="initSegment"||v.bitrateTest||p)){var d=A(v);this.fragments[d]={body:v,loaded:S,buffered:!1,range:Object.create(null)}}},a.onBufferAppended=function(s,S){var v=this,p=S.frag,d=S.part,n=S.timeRanges;if(p.type===O.PlaylistLevelType.MAIN)if(this.activeFragment=p,d){var u=this.activeParts;u||(this.activeParts=u=[]),u.push(d)}else this.activeParts=null;this.timeRanges=n,Object.keys(n).forEach(function(f){var E=n[f];if(v.detectEvictedFragments(f,E),!d)for(var r=0;r<E.length;r++)p.appendedPTS=Math.max(E.end(r),p.appendedPTS||0)})},a.onFragBuffered=function(s,S){this.detectPartialFragments(S)},a.hasFragment=function(s){var S=A(s);return!!this.fragments[S]},a.removeFragmentsInRange=function(s,S,v){var p=this;Object.keys(this.fragments).forEach(function(d){var n=p.fragments[d];if(!!n&&n.buffered){var u=n.body;u.type===v&&u.start<S&&u.end>s&&p.removeFragment(u)}})},a.removeFragment=function(s){var S=A(s);s.stats.loaded=0,s.clearElementaryStreamInfo(),delete this.fragments[S]},a.removeAllFragments=function(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},c}();function R(c){var a,l;return c.buffered&&(((a=c.range.video)===null||a===void 0?void 0:a.partial)||((l=c.range.audio)===null||l===void 0?void 0:l.partial))}function A(c){return c.type+"_"+c.level+"_"+c.urlId+"_"+c.sn}},"./src/controller/gap-controller.ts":function(w,C,h){h.r(C),h.d(C,"STALL_MINIMUM_DURATION_MS",function(){return R}),h.d(C,"MAX_START_GAP_JUMP",function(){return A}),h.d(C,"SKIP_BUFFER_HOLE_STEP_SECONDS",function(){return c}),h.d(C,"SKIP_BUFFER_RANGE_START",function(){return a}),h.d(C,"default",function(){return l});var F=h("./src/utils/buffer-helper.ts"),O=h("./src/errors.ts"),D=h("./src/events.ts"),M=h("./src/utils/logger.ts"),R=250,A=2,c=.1,a=.05,l=function(){function s(v,p,d,n){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=v,this.media=p,this.fragmentTracker=d,this.hls=n}var S=s.prototype;return S.destroy=function(){this.media=null,this.hls=this.fragmentTracker=null},S.poll=function(p,d){var n=this.config,u=this.media,f=this.stalled;if(u!==null){var E=u.currentTime,r=u.seeking,e=this.seeking&&!r,t=!this.seeking&&r;if(this.seeking=r,E!==p){if(this.moved=!0,f!==null){if(this.stallReported){var i=self.performance.now()-f;M.logger.warn("playback not stuck anymore @"+E+", after "+Math.round(i)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((t||e)&&(this.stalled=null),!(u.paused&&!r||u.ended||u.playbackRate===0||!F.BufferHelper.getBuffered(u).length)){var o=F.BufferHelper.bufferInfo(u,E,0),m=o.len>0,L=o.nextStart||0;if(!(!m&&!L)){if(r){var P=o.len>A,y=!L||d&&d.start<=E||L-E>A&&!this.fragmentTracker.getPartialFragment(E);if(P||y)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var T,g=Math.max(L,o.start||0)-E,x=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,I=x==null||(T=x.details)===null||T===void 0?void 0:T.live,U=I?x.details.targetduration*2:A;if(g>0&&g<=U){this._trySkipBufferHole(null);return}}var b=self.performance.now();if(f===null){this.stalled=b;return}var B=b-f;if(!(!r&&B>=R&&(this._reportStall(o),!this.media))){var _=F.BufferHelper.bufferInfo(u,E,n.maxBufferHole);this._tryFixBufferStall(_,B)}}}}},S._tryFixBufferStall=function(p,d){var n=this.config,u=this.fragmentTracker,f=this.media;if(f!==null){var E=f.currentTime,r=u.getPartialFragment(E);if(r){var e=this._trySkipBufferHole(r);if(e||!this.media)return}p.len>n.maxBufferHole&&d>n.highBufferWatchdogPeriod*1e3&&(M.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},S._reportStall=function(p){var d=this.hls,n=this.media,u=this.stallReported;!u&&n&&(this.stallReported=!0,M.logger.warn("Playback stalling at @"+n.currentTime+" due to low buffer ("+JSON.stringify(p)+")"),d.trigger(D.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:p.len}))},S._trySkipBufferHole=function(p){var d=this.config,n=this.hls,u=this.media;if(u===null)return 0;for(var f=u.currentTime,E=0,r=F.BufferHelper.getBuffered(u),e=0;e<r.length;e++){var t=r.start(e);if(f+d.maxBufferHole>=E&&f<t){var i=Math.max(t+a,u.currentTime+c);return M.logger.warn("skipping hole, adjusting currentTime from "+f+" to "+i),this.moved=!0,this.stalled=null,u.currentTime=i,p&&n.trigger(D.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+f+" to "+i,frag:p}),i}E=r.end(e)}return 0},S._tryNudgeBuffer=function(){var p=this.config,d=this.hls,n=this.media,u=this.nudgeRetry;if(n!==null){var f=n.currentTime;if(this.nudgeRetry++,u<p.nudgeMaxRetry){var E=f+(u+1)*p.nudgeOffset;M.logger.warn("Nudging 'currentTime' from "+f+" to "+E),n.currentTime=E,d.trigger(D.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else M.logger.error("Playhead still not moving while enough data buffered @"+f+" after "+p.nudgeMaxRetry+" nudges"),d.trigger(D.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},s}()},"./src/controller/id3-track-controller.ts":function(w,C,h){h.r(C);var F=h("./src/polyfills/number.ts"),O=h("./src/events.ts"),D=h("./src/utils/texttrack-utils.ts"),M=h("./src/demux/id3.ts"),R=h("./src/loader/date-range.ts"),A=h("./src/types/demuxer.ts"),c=.25;function a(){return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}function l(v,p){return v.getTime()/1e3-p}function s(v){return Uint8Array.from(v.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var S=function(){function v(d){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=d,this._registerListeners()}var p=v.prototype;return p.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},p._registerListeners=function(){var n=this.hls;n.on(O.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.on(O.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(O.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(O.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.on(O.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.on(O.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},p._unregisterListeners=function(){var n=this.hls;n.off(O.Events.MEDIA_ATTACHED,this.onMediaAttached,this),n.off(O.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.off(O.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(O.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),n.off(O.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),n.off(O.Events.LEVEL_UPDATED,this.onLevelUpdated,this)},p.onMediaAttached=function(n,u){this.media=u.media},p.onMediaDetaching=function(){!this.id3Track||(Object(D.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},p.onManifestLoading=function(){this.dateRangeCuesAppended={}},p.createTrack=function(n){var u=this.getID3Track(n.textTracks);return u.mode="hidden",u},p.getID3Track=function(n){if(!!this.media){for(var u=0;u<n.length;u++){var f=n[u];if(f.kind==="metadata"&&f.label==="id3")return Object(D.sendAddTrackEvent)(f,this.media),f}return this.media.addTextTrack("metadata","id3")}},p.onFragParsingMetadata=function(n,u){if(!!this.media){var f=this.hls.config,E=f.enableEmsgMetadataCues,r=f.enableID3MetadataCues;if(!(!E&&!r)){var e=u.frag,t=u.samples,i=u.details;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var o=i.edge||e.end,m=a(),L=!1,P={},y=0;y<t.length;y++){var T=t[y].type;if(!(T===A.MetadataSchema.emsg&&!E||!r)){var g=M.getID3Frames(t[y].data);if(g){var x=t[y].pts,I=o,U=I-x;U<=0&&(I=x+c);for(var b=0;b<g.length;b++){var B=g[b];if(!M.isTimeStampFrame(B)){var _=new m(x,I,"");_.value=B,T&&(_.type=T),this.id3Track.addCue(_),P[B.key]=null,L=!0}}}}}L&&this.updateId3CueEnds(P)}}},p.updateId3CueEnds=function(n){var u,f=(u=this.id3Track)===null||u===void 0?void 0:u.cues;if(f)for(var E=f.length;E--;){var r,e=f[E],t=(r=e.value)===null||r===void 0?void 0:r.key;if(t&&t in n){var i=n[t];i&&e.endTime!==i&&(e.endTime=i),n[t]=e.startTime}}},p.onBufferFlushing=function(n,u){var f=u.startOffset,E=u.endOffset,r=u.type,e=this.id3Track,t=this.hls;if(!!t){var i=t.config,o=i.enableEmsgMetadataCues,m=i.enableID3MetadataCues;if(e&&(o||m)){var L;r==="audio"?L=function(y){return y.type===A.MetadataSchema.audioId3&&m}:r==="video"?L=function(y){return y.type===A.MetadataSchema.emsg&&o}:L=function(y){return y.type===A.MetadataSchema.audioId3&&m||y.type===A.MetadataSchema.emsg&&o},Object(D.removeCuesInRange)(e,f,E,L)}}},p.onLevelUpdated=function(n,u){var f=this,E=u.details;if(!(!this.media||!E.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)){var r=this.dateRangeCuesAppended,e=this.id3Track,t=E.dateRanges,i=Object.keys(t);if(e)for(var o=Object.keys(r).filter(function(U){return!i.includes(U)}),m=function(b){var B=o[b];Object.keys(r[B].cues).forEach(function(_){e.removeCue(r[B].cues[_])}),delete r[B]},L=o.length;L--;)m(L);var P=E.fragments[E.fragments.length-1];if(!(i.length===0||!Object(F.isFiniteNumber)(P==null?void 0:P.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var y=P.programDateTime/1e3-P.start,T=E.edge||P.end,g=a(),x=function(b){var B=i[b],_=t[B],k=r[B],N=(k==null?void 0:k.cues)||{},K=(k==null?void 0:k.durationKnown)||!1,W=l(_.startDate,y),j=T,H=_.endDate;if(H)j=l(H,y),K=!0;else if(_.endOnNext&&!K){var Y=i.reduce(function(X,ee){var J=t[ee];return J.class===_.class&&J.id!==ee&&J.startDate>_.startDate&&X.push(J),X},[]).sort(function(X,ee){return X.startDate.getTime()-ee.startDate.getTime()})[0];Y&&(j=l(Y.startDate,y),K=!0)}for(var Z=Object.keys(_.attr),$=0;$<Z.length;$++){var V=Z[$];if(!(V===R.DateRangeAttribute.ID||V===R.DateRangeAttribute.CLASS||V===R.DateRangeAttribute.START_DATE||V===R.DateRangeAttribute.DURATION||V===R.DateRangeAttribute.END_DATE||V===R.DateRangeAttribute.END_ON_NEXT)){var Q=N[V];if(Q)K&&!k.durationKnown&&(Q.endTime=j);else{var z=_.attr[V];Q=new g(W,j,""),(V===R.DateRangeAttribute.SCTE35_OUT||V===R.DateRangeAttribute.SCTE35_IN)&&(z=s(z)),Q.value={key:V,data:z},Q.type=A.MetadataSchema.dateRange,f.id3Track.addCue(Q),N[V]=Q}}}r[B]={cues:N,dateRange:_,durationKnown:K}},I=0;I<i.length;I++)x(I)}}},v}();C.default=S},"./src/controller/latency-controller.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return A});var F=h("./src/errors.ts"),O=h("./src/events.ts"),D=h("./src/utils/logger.ts");function M(c,a){for(var l=0;l<a.length;l++){var s=a[l];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(c,s.key,s)}}function R(c,a,l){return a&&M(c.prototype,a),l&&M(c,l),Object.defineProperty(c,"prototype",{writable:!1}),c}var A=function(){function c(l){var s=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return s.timeupdate()},this.hls=l,this.config=l.config,this.registerListeners()}var a=c.prototype;return a.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},a.registerListeners=function(){this.hls.on(O.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(O.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(O.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(O.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(O.Events.ERROR,this.onError,this)},a.unregisterListeners=function(){this.hls.off(O.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(O.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(O.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(O.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(O.Events.ERROR,this.onError)},a.onMediaAttached=function(s,S){this.media=S.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},a.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},a.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},a.onLevelUpdated=function(s,S){var v=S.details;this.levelDetails=v,v.advanced&&this.timeupdate(),!v.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},a.onError=function(s,S){S.details===F.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,D.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},a.timeupdate=function(){var s=this.media,S=this.levelDetails;if(!(!s||!S)){this.currentTime=s.currentTime;var v=this.computeLatency();if(v!==null){this._latency=v;var p=this.config,d=p.lowLatencyMode,n=p.maxLiveSyncPlaybackRate;if(!(!d||n===1)){var u=this.targetLatency;if(u!==null){var f=v-u,E=Math.min(this.maxLatency,u+S.targetduration),r=f<E;if(S.live&&r&&f>.05&&this.forwardBufferLength>1){var e=Math.min(2,Math.max(1,n)),t=Math.round(2/(1+Math.exp(-.75*f-this.edgeStalled))*20)/20;s.playbackRate=Math.min(e,Math.max(1,t))}else s.playbackRate!==1&&s.playbackRate!==0&&(s.playbackRate=1)}}}}},a.estimateLiveEdge=function(){var s=this.levelDetails;return s===null?null:s.edge+s.age},a.computeLatency=function(){var s=this.estimateLiveEdge();return s===null?null:s-this.currentTime},R(c,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var s=this.config,S=this.levelDetails;return s.liveMaxLatencyDuration!==void 0?s.liveMaxLatencyDuration:S?s.liveMaxLatencyDurationCount*S.targetduration:0}},{key:"targetLatency",get:function(){var s=this.levelDetails;if(s===null)return null;var S=s.holdBack,v=s.partHoldBack,p=s.targetduration,d=this.config,n=d.liveSyncDuration,u=d.liveSyncDurationCount,f=d.lowLatencyMode,E=this.hls.userConfig,r=f&&v||S;(E.liveSyncDuration||E.liveSyncDurationCount||r===0)&&(r=n!==void 0?n:u*p);var e=p,t=1;return r+Math.min(this.stallCount*t,e)}},{key:"liveSyncPosition",get:function(){var s=this.estimateLiveEdge(),S=this.targetLatency,v=this.levelDetails;if(s===null||S===null||v===null)return null;var p=v.edge,d=s-S-this.edgeStalled,n=p-v.totalduration,u=p-(this.config.lowLatencyMode&&v.partTarget||v.targetduration);return Math.min(Math.max(n,d),u)}},{key:"drift",get:function(){var s=this.levelDetails;return s===null?1:s.drift}},{key:"edgeStalled",get:function(){var s=this.levelDetails;if(s===null)return 0;var S=(this.config.lowLatencyMode&&s.partTarget||s.targetduration)*3;return Math.max(s.age-S,0)}},{key:"forwardBufferLength",get:function(){var s=this.media,S=this.levelDetails;if(!s||!S)return 0;var v=s.buffered.length;return(v?s.buffered.end(v-1):S.edge)-this.currentTime}}]),c}()},"./src/controller/level-controller.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return d});var F=h("./src/types/level.ts"),O=h("./src/events.ts"),D=h("./src/errors.ts"),M=h("./src/utils/codecs.ts"),R=h("./src/controller/level-helper.ts"),A=h("./src/controller/base-playlist-controller.ts"),c=h("./src/types/loader.ts");function a(){return a=Object.assign?Object.assign.bind():function(n){for(var u=1;u<arguments.length;u++){var f=arguments[u];for(var E in f)Object.prototype.hasOwnProperty.call(f,E)&&(n[E]=f[E])}return n},a.apply(this,arguments)}function l(n,u){for(var f=0;f<u.length;f++){var E=u[f];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(n,E.key,E)}}function s(n,u,f){return u&&l(n.prototype,u),f&&l(n,f),Object.defineProperty(n,"prototype",{writable:!1}),n}function S(n,u){n.prototype=Object.create(u.prototype),n.prototype.constructor=n,v(n,u)}function v(n,u){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(E,r){return E.__proto__=r,E},v(n,u)}var p=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),d=function(n){S(u,n);function u(E){var r;return r=n.call(this,E,"[level-controller]")||this,r._levels=[],r._firstLevel=-1,r._startLevel=void 0,r.currentLevelIndex=-1,r.manualLevelIndex=-1,r.onParsedComplete=void 0,r._registerListeners(),r}var f=u.prototype;return f._registerListeners=function(){var r=this.hls;r.on(O.Events.MANIFEST_LOADED,this.onManifestLoaded,this),r.on(O.Events.LEVEL_LOADED,this.onLevelLoaded,this),r.on(O.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),r.on(O.Events.FRAG_LOADED,this.onFragLoaded,this),r.on(O.Events.ERROR,this.onError,this)},f._unregisterListeners=function(){var r=this.hls;r.off(O.Events.MANIFEST_LOADED,this.onManifestLoaded,this),r.off(O.Events.LEVEL_LOADED,this.onLevelLoaded,this),r.off(O.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),r.off(O.Events.FRAG_LOADED,this.onFragLoaded,this),r.off(O.Events.ERROR,this.onError,this)},f.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,n.prototype.destroy.call(this)},f.startLoad=function(){var r=this._levels;r.forEach(function(e){e.loadError=0}),n.prototype.startLoad.call(this)},f.onManifestLoaded=function(r,e){var t=[],i=[],o=[],m,L={},P,y=!1,T=!1,g=!1;if(e.levels.forEach(function(b){var B=b.attrs;y=y||!!(b.width&&b.height),T=T||!!b.videoCodec,g=g||!!b.audioCodec,p&&b.audioCodec&&b.audioCodec.indexOf("mp4a.40.34")!==-1&&(b.audioCodec=void 0);var _=b.bitrate+"-"+b.attrs.RESOLUTION+"-"+b.attrs.CODECS;P=L[_],P?P.url.push(b.url):(P=new F.Level(b),L[_]=P,t.push(P)),B&&(B.AUDIO&&Object(R.addGroupId)(P,"audio",B.AUDIO),B.SUBTITLES&&Object(R.addGroupId)(P,"text",B.SUBTITLES))}),(y||T)&&g&&(t=t.filter(function(b){var B=b.videoCodec,_=b.width,k=b.height;return!!B||!!(_&&k)})),t=t.filter(function(b){var B=b.audioCodec,_=b.videoCodec;return(!B||Object(M.isCodecSupportedInMp4)(B,"audio"))&&(!_||Object(M.isCodecSupportedInMp4)(_,"video"))}),e.audioTracks&&(i=e.audioTracks.filter(function(b){return!b.audioCodec||Object(M.isCodecSupportedInMp4)(b.audioCodec,"audio")}),Object(R.assignTrackIdsByGroup)(i)),e.subtitles&&(o=e.subtitles,Object(R.assignTrackIdsByGroup)(o)),t.length>0){m=t[0].bitrate,t.sort(function(b,B){return b.bitrate-B.bitrate}),this._levels=t;for(var x=0;x<t.length;x++)if(t[x].bitrate===m){this._firstLevel=x,this.log("manifest loaded, "+t.length+" level(s) found, first bitrate: "+m);break}var I=g&&!T,U={levels:t,audioTracks:i,subtitleTracks:o,firstLevel:this._firstLevel,stats:e.stats,audio:g,video:T,altAudio:!I&&i.some(function(b){return!!b.url})};this.hls.trigger(O.Events.MANIFEST_PARSED,U),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(O.Events.ERROR,{type:D.ErrorTypes.MEDIA_ERROR,details:D.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,reason:"no level with compatible codecs found in manifest"})},f.onError=function(r,e){var t;if(n.prototype.onError.call(this,r,e),!e.fatal){var i=e.context,o=this._levels[this.currentLevelIndex];if(i&&(i.type===c.PlaylistContextType.AUDIO_TRACK&&o.audioGroupIds&&i.groupId===o.audioGroupIds[o.urlId]||i.type===c.PlaylistContextType.SUBTITLE_TRACK&&o.textGroupIds&&i.groupId===o.textGroupIds[o.urlId])){this.redundantFailover(this.currentLevelIndex);return}var m=!1,L=!0,P;switch(e.details){case D.ErrorDetails.FRAG_LOAD_ERROR:case D.ErrorDetails.FRAG_LOAD_TIMEOUT:case D.ErrorDetails.KEY_LOAD_ERROR:case D.ErrorDetails.KEY_LOAD_TIMEOUT:if(e.frag){var y=e.frag.type===c.PlaylistLevelType.MAIN?e.frag.level:this.currentLevelIndex,T=this._levels[y];T?(T.fragmentError++,T.fragmentError>this.hls.config.fragLoadingMaxRetry&&(P=y)):P=y}break;case D.ErrorDetails.LEVEL_LOAD_ERROR:case D.ErrorDetails.LEVEL_LOAD_TIMEOUT:i&&(i.deliveryDirectives&&(L=!1),P=i.level),m=!0;break;case D.ErrorDetails.REMUX_ALLOC_ERROR:P=(t=e.level)!=null?t:this.currentLevelIndex,m=!0;break}P!==void 0&&this.recoverLevel(e,P,m,L)}},f.recoverLevel=function(r,e,t,i){var o=r.details,m=this._levels[e];if(m.loadError++,t){var L=this.retryLoadingOrFail(r);if(L)r.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(i){var P=m.url.length;if(P>1&&m.loadError<P)r.levelRetry=!0,this.redundantFailover(e);else if(this.manualLevelIndex===-1){for(var y=-1,T=this._levels,g=T.length;g--;){var x=(g+this.currentLevelIndex)%T.length;if(x!==this.currentLevelIndex&&T[x].loadError===0){y=x;break}}y>-1&&this.currentLevelIndex!==y&&(this.warn(o+": switch to "+y),r.levelRetry=!0,this.hls.nextAutoLevel=y)}}},f.redundantFailover=function(r){var e=this._levels[r],t=e.url.length;if(t>1){var i=(e.urlId+1)%t;this.warn("Switching to redundant URL-id "+i),this._levels.forEach(function(o){o.urlId=i}),this.level=r}},f.onFragLoaded=function(r,e){var t=e.frag;if(t!==void 0&&t.type===c.PlaylistLevelType.MAIN){var i=this._levels[t.level];i!==void 0&&(i.fragmentError=0,i.loadError=0)}},f.onLevelLoaded=function(r,e){var t,i=e.level,o=e.details,m=this._levels[i];if(!m){var L;this.warn("Invalid level index "+i),(L=e.deliveryDirectives)!==null&&L!==void 0&&L.skip&&(o.deltaUpdateFailed=!0);return}i===this.currentLevelIndex?(m.fragmentError===0&&(m.loadError=0,this.retryCount=0),this.playlistLoaded(i,e,m.details)):(t=e.deliveryDirectives)!==null&&t!==void 0&&t.skip&&(o.deltaUpdateFailed=!0)},f.onAudioTrackSwitched=function(r,e){var t=this.hls.levels[this.currentLevelIndex];if(!!t&&t.audioGroupIds){for(var i=-1,o=this.hls.audioTracks[e.id].groupId,m=0;m<t.audioGroupIds.length;m++)if(t.audioGroupIds[m]===o){i=m;break}i!==t.urlId&&(t.urlId=i,this.startLoad())}},f.loadPlaylist=function(r){var e=this.currentLevelIndex,t=this._levels[e];if(this.canLoad&&t&&t.url.length>0){var i=t.urlId,o=t.url[i];if(r)try{o=r.addDirectives(o)}catch(m){this.warn("Could not construct new URL with HLS Delivery Directives: "+m)}this.log("Attempt loading level index "+e+(r?" at sn "+r.msn+" part "+r.part:"")+" with URL-id "+i+" "+o),this.clearTimer(),this.hls.trigger(O.Events.LEVEL_LOADING,{url:o,level:e,id:i,deliveryDirectives:r||null})}},f.removeLevel=function(r,e){var t=function(m,L){return L!==e},i=this._levels.filter(function(o,m){return m!==r?!0:o.url.length>1&&e!==void 0?(o.url=o.url.filter(t),o.audioGroupIds&&(o.audioGroupIds=o.audioGroupIds.filter(t)),o.textGroupIds&&(o.textGroupIds=o.textGroupIds.filter(t)),o.urlId=0,!0):!1}).map(function(o,m){var L=o.details;return L!=null&&L.fragments&&L.fragments.forEach(function(P){P.level=m}),o});this._levels=i,this.hls.trigger(O.Events.LEVELS_UPDATED,{levels:i})},s(u,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(r){var e,t=this._levels;if(t.length!==0&&!(this.currentLevelIndex===r&&(e=t[r])!==null&&e!==void 0&&e.details)){if(r<0||r>=t.length){var i=r<0;if(this.hls.trigger(O.Events.ERROR,{type:D.ErrorTypes.OTHER_ERROR,details:D.ErrorDetails.LEVEL_SWITCH_ERROR,level:r,fatal:i,reason:"invalid level idx"}),i)return;r=Math.min(r,t.length-1)}this.clearTimer();var o=this.currentLevelIndex,m=t[o],L=t[r];this.log("switching to level "+r+" from "+o),this.currentLevelIndex=r;var P=a({},L,{level:r,maxBitrate:L.maxBitrate,uri:L.uri,urlId:L.urlId});delete P._urlId,this.hls.trigger(O.Events.LEVEL_SWITCHING,P);var y=L.details;if(!y||y.live){var T=this.switchParams(L.uri,m==null?void 0:m.details);this.loadPlaylist(T)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(r){this.manualLevelIndex=r,this._startLevel===void 0&&(this._startLevel=r),r!==-1&&(this.level=r)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(r){this._firstLevel=r}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var r=this.hls.config.startLevel;return r!==void 0?r:this._firstLevel}else return this._startLevel},set:function(r){this._startLevel=r}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(r){this.level=r,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=r)}}]),u}(A.default)},"./src/controller/level-helper.ts":function(w,C,h){h.r(C),h.d(C,"addGroupId",function(){return R}),h.d(C,"assignTrackIdsByGroup",function(){return A}),h.d(C,"updatePTS",function(){return c}),h.d(C,"updateFragPTSDTS",function(){return l}),h.d(C,"mergeDetails",function(){return s}),h.d(C,"mapPartIntersection",function(){return v}),h.d(C,"mapFragmentIntersection",function(){return p}),h.d(C,"adjustSliding",function(){return d}),h.d(C,"addSliding",function(){return n}),h.d(C,"computeReloadInterval",function(){return u}),h.d(C,"getFragmentWithSN",function(){return f}),h.d(C,"getPartWith",function(){return E});var F=h("./src/polyfills/number.ts"),O=h("./src/utils/logger.ts"),D=h("./src/loader/date-range.ts");function M(){return M=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},M.apply(this,arguments)}function R(r,e,t){switch(e){case"audio":r.audioGroupIds||(r.audioGroupIds=[]),r.audioGroupIds.push(t);break;case"text":r.textGroupIds||(r.textGroupIds=[]),r.textGroupIds.push(t);break}}function A(r){var e={};r.forEach(function(t){var i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function c(r,e,t){var i=r[e],o=r[t];a(i,o)}function a(r,e){var t=e.startPTS;if(Object(F.isFiniteNumber)(t)){var i=0,o;e.sn>r.sn?(i=t-r.start,o=r):(i=r.start-t,o=e),o.duration!==i&&(o.duration=i)}else if(e.sn>r.sn){var m=r.cc===e.cc;m&&r.minEndPTS?e.start=r.start+(r.minEndPTS-r.start):e.start=r.start+r.duration}else e.start=Math.max(r.start-e.duration,0)}function l(r,e,t,i,o,m){var L=i-t;L<=0&&(O.logger.warn("Fragment should have a positive duration",e),i=t+e.duration,m=o+e.duration);var P=t,y=i,T=e.startPTS,g=e.endPTS;if(Object(F.isFiniteNumber)(T)){var x=Math.abs(T-t);Object(F.isFiniteNumber)(e.deltaPTS)?e.deltaPTS=Math.max(x,e.deltaPTS):e.deltaPTS=x,P=Math.max(t,T),t=Math.min(t,T),o=Math.min(o,e.startDTS),y=Math.min(i,g),i=Math.max(i,g),m=Math.max(m,e.endDTS)}e.duration=i-t;var I=t-e.start;e.appendedPTS=i,e.start=e.startPTS=t,e.maxStartPTS=P,e.startDTS=o,e.endPTS=i,e.minEndPTS=y,e.endDTS=m;var U=e.sn;if(!r||U<r.startSN||U>r.endSN)return 0;var b,B=U-r.startSN,_=r.fragments;for(_[B]=e,b=B;b>0;b--)a(_[b],_[b-1]);for(b=B;b<_.length-1;b++)a(_[b],_[b+1]);return r.fragmentHint&&a(_[_.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=!0,I}function s(r,e){for(var t=null,i=r.fragments,o=i.length-1;o>=0;o--){var m=i[o].initSegment;if(m){t=m;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;var L=0,P;if(p(r,e,function(b,B){b.relurl&&(L=b.cc-B.cc),Object(F.isFiniteNumber)(b.startPTS)&&Object(F.isFiniteNumber)(b.endPTS)&&(B.start=B.startPTS=b.startPTS,B.startDTS=b.startDTS,B.appendedPTS=b.appendedPTS,B.maxStartPTS=b.maxStartPTS,B.endPTS=b.endPTS,B.endDTS=b.endDTS,B.minEndPTS=b.minEndPTS,B.duration=b.endPTS-b.startPTS,B.duration&&(P=B),e.PTSKnown=e.alignedSliding=!0),B.elementaryStreams=b.elementaryStreams,B.loader=b.loader,B.stats=b.stats,B.urlId=b.urlId,b.initSegment&&(B.initSegment=b.initSegment,t=b.initSegment)}),t){var y=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;y.forEach(function(b){var B;(!b.initSegment||b.initSegment.relurl===((B=t)===null||B===void 0?void 0:B.relurl))&&(b.initSegment=t)})}if(e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some(function(b){return!b}),e.deltaUpdateFailed){O.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var T=e.skippedSegments;T--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=S(r.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));var g=e.fragments;if(L){O.logger.warn("discontinuity sliding from playlist, take drift into account");for(var x=0;x<g.length;x++)g[x].cc+=L}e.skippedSegments&&(e.startCC=e.fragments[0].cc),v(r.partList,e.partList,function(b,B){B.elementaryStreams=b.elementaryStreams,B.stats=b.stats}),P?l(e,P,P.startPTS,P.endPTS,P.startDTS,P.endDTS):d(r,e),g.length&&(e.totalduration=e.edge-g[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;var I=e.advancedDateTime;if(e.advanced&&I){var U=e.edge;e.driftStart||(e.driftStartTime=I,e.driftStart=U),e.driftEndTime=I,e.driftEnd=U}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime}function S(r,e,t){var i=M({},r);return t&&t.forEach(function(o){delete i[o]}),Object.keys(e).forEach(function(o){var m=new D.DateRange(e[o].attr,i[o]);m.isValid?i[o]=m:O.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(e[o].attr)+'"')}),i}function v(r,e,t){if(r&&e)for(var i=0,o=0,m=r.length;o<=m;o++){var L=r[o],P=e[o+i];L&&P&&L.index===P.index&&L.fragment.sn===P.fragment.sn?t(L,P):i--}}function p(r,e,t){for(var i=e.skippedSegments,o=Math.max(r.startSN,e.startSN)-e.startSN,m=(r.fragmentHint?1:0)+(i?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,L=e.startSN-r.startSN,P=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,y=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments,T=o;T<=m;T++){var g=y[L+T],x=P[T];i&&!x&&T<i&&(x=e.fragments[T]=g),g&&x&&t(g,x)}}function d(r,e){var t=e.startSN+e.skippedSegments-r.startSN,i=r.fragments;t<0||t>=i.length||n(e,i[t].start)}function n(r,e){if(e){for(var t=r.fragments,i=r.skippedSegments;i<t.length;i++)t[i].start+=e;r.fragmentHint&&(r.fragmentHint.start+=e)}}function u(r,e){var t=1e3*r.levelTargetDuration,i=t/2,o=r.age,m=o>0&&o<t*3,L=e.loading.end-e.loading.start,P,y=r.availabilityDelay;if(r.updated===!1)if(m){var T=333*r.misses;P=Math.max(Math.min(i,L*2),T),r.availabilityDelay=(r.availabilityDelay||0)+P}else P=i;else m?(y=Math.min(y||t/2,o),r.availabilityDelay=y,P=y+t-o):P=t-L;return Math.round(P)}function f(r,e,t){if(!r||!r.details)return null;var i=r.details,o=i.fragments[e-i.startSN];return o||(o=i.fragmentHint,o&&o.sn===e)?o:e<i.startSN&&t&&t.sn===e?t:null}function E(r,e,t){if(!r||!r.details)return null;var i=r.details.partList;if(i)for(var o=i.length;o--;){var m=i[o];if(m.index===t&&m.fragment.sn===e)return m}return null}},"./src/controller/stream-controller.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return E});var F=h("./src/polyfills/number.ts"),O=h("./src/controller/base-stream-controller.ts"),D=h("./src/is-supported.ts"),M=h("./src/events.ts"),R=h("./src/utils/buffer-helper.ts"),A=h("./src/controller/fragment-tracker.ts"),c=h("./src/types/loader.ts"),a=h("./src/loader/fragment.ts"),l=h("./src/demux/transmuxer-interface.ts"),s=h("./src/types/transmuxer.ts"),S=h("./src/controller/gap-controller.ts"),v=h("./src/errors.ts");function p(r,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,i.key,i)}}function d(r,e,t){return e&&p(r.prototype,e),t&&p(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function n(r,e){r.prototype=Object.create(e.prototype),r.prototype.constructor=r,u(r,e)}function u(r,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,o){return i.__proto__=o,i},u(r,e)}var f=100,E=function(r){n(e,r);function e(i,o){var m;return m=r.call(this,i,o,"[stream-controller]")||this,m.audioCodecSwap=!1,m.gapController=null,m.level=-1,m._forceStartLoad=!1,m.altAudio=!1,m.audioOnly=!1,m.fragPlaying=null,m.onvplaying=null,m.onvseeked=null,m.fragLastKbps=0,m.couldBacktrack=!1,m.backtrackFragment=null,m.audioCodecSwitch=!1,m.videoBuffer=null,m._registerListeners(),m}var t=e.prototype;return t._registerListeners=function(){var o=this.hls;o.on(M.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.on(M.Events.MEDIA_DETACHING,this.onMediaDetaching,this),o.on(M.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.on(M.Events.MANIFEST_PARSED,this.onManifestParsed,this),o.on(M.Events.LEVEL_LOADING,this.onLevelLoading,this),o.on(M.Events.LEVEL_LOADED,this.onLevelLoaded,this),o.on(M.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),o.on(M.Events.ERROR,this.onError,this),o.on(M.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),o.on(M.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),o.on(M.Events.BUFFER_CREATED,this.onBufferCreated,this),o.on(M.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),o.on(M.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),o.on(M.Events.FRAG_BUFFERED,this.onFragBuffered,this)},t._unregisterListeners=function(){var o=this.hls;o.off(M.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.off(M.Events.MEDIA_DETACHING,this.onMediaDetaching,this),o.off(M.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.off(M.Events.MANIFEST_PARSED,this.onManifestParsed,this),o.off(M.Events.LEVEL_LOADED,this.onLevelLoaded,this),o.off(M.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),o.off(M.Events.ERROR,this.onError,this),o.off(M.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),o.off(M.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),o.off(M.Events.BUFFER_CREATED,this.onBufferCreated,this),o.off(M.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),o.off(M.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),o.off(M.Events.FRAG_BUFFERED,this.onFragBuffered,this)},t.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},t.startLoad=function(o){if(this.levels){var m=this.lastCurrentTime,L=this.hls;if(this.stopLoad(),this.setInterval(f),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var P=L.startLevel;P===-1&&(L.config.testBandwidth&&this.levels.length>1?(P=0,this.bitrateTest=!0):P=L.nextAutoLevel),this.level=L.nextLoadLevel=P,this.loadedmetadata=!1}m>0&&o===-1&&(this.log("Override startPosition with lastCurrentTime @"+m.toFixed(3)),o=m),this.state=O.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=o,this.tick()}else this._forceStartLoad=!0,this.state=O.State.STOPPED},t.stopLoad=function(){this._forceStartLoad=!1,r.prototype.stopLoad.call(this)},t.doTick=function(){switch(this.state){case O.State.IDLE:this.doTickIdle();break;case O.State.WAITING_LEVEL:{var o,m=this.levels,L=this.level,P=m==null||(o=m[L])===null||o===void 0?void 0:o.details;if(P&&(!P.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(P))break;this.state=O.State.IDLE;break}break}case O.State.FRAG_LOADING_WAITING_RETRY:{var y,T=self.performance.now(),g=this.retryDate;(!g||T>=g||(y=this.media)!==null&&y!==void 0&&y.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=O.State.IDLE)}break}this.onTickEnd()},t.onTickEnd=function(){r.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},t.doTickIdle=function(){var o,m,L=this.hls,P=this.levelLastLoaded,y=this.levels,T=this.media,g=L.config,x=L.nextLoadLevel;if(!(P===null||!T&&(this.startFragRequested||!g.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!y||!y[x])){var I=y[x];this.level=L.nextLoadLevel=x;var U=I.details;if(!U||this.state===O.State.WAITING_LEVEL||U.live&&this.levelLastLoaded!==x){this.state=O.State.WAITING_LEVEL;return}var b=this.getMainFwdBufferInfo();if(b!==null){var B=b.len,_=this.getMaxBufferLength(I.maxBitrate);if(!(B>=_)){if(this._streamEnded(b,U)){var k={};this.altAudio&&(k.type="video"),this.hls.trigger(M.Events.BUFFER_EOS,k),this.state=O.State.ENDED;return}this.backtrackFragment&&this.backtrackFragment.start>b.end&&(this.backtrackFragment=null);var N=this.backtrackFragment?this.backtrackFragment.start:b.end,K=this.getNextFragment(N,U);if(this.couldBacktrack&&!this.fragPrevious&&K&&K.sn!=="initSegment"&&this.fragmentTracker.getState(K)!==A.FragmentState.OK){var W,j=((W=this.backtrackFragment)!=null?W:K).sn,H=j-U.startSN,Y=U.fragments[H-1];Y&&K.cc===Y.cc&&(K=Y,this.fragmentTracker.removeFragment(Y))}else this.backtrackFragment&&b.len&&(this.backtrackFragment=null);if(K&&this.fragmentTracker.getState(K)===A.FragmentState.OK&&this.nextLoadPosition>N){var Z=this.audioOnly&&!this.altAudio?a.ElementaryStreamTypes.AUDIO:a.ElementaryStreamTypes.VIDEO;T&&this.afterBufferFlushed(T,Z,c.PlaylistLevelType.MAIN),K=this.getNextFragment(this.nextLoadPosition,U)}!K||(K.initSegment&&!K.initSegment.data&&!this.bitrateTest&&(K=K.initSegment),((o=K.decryptdata)===null||o===void 0?void 0:o.keyFormat)==="identity"&&!((m=K.decryptdata)!==null&&m!==void 0&&m.key)?this.loadKey(K,U):this.loadFragment(K,U,N))}}}},t.loadFragment=function(o,m,L){var P,y=this.fragmentTracker.getState(o);this.fragCurrent=o,y===A.FragmentState.NOT_LOADED?o.sn==="initSegment"?this._loadInitSegment(o):this.bitrateTest?(this.log("Fragment "+o.sn+" of level "+o.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(o)):(this.startFragRequested=!0,r.prototype.loadFragment.call(this,o,m,L)):y===A.FragmentState.APPENDING?this.reduceMaxBufferLength(o.duration)&&this.fragmentTracker.removeFragment(o):((P=this.media)===null||P===void 0?void 0:P.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},t.getAppendedFrag=function(o){var m=this.fragmentTracker.getAppendedFrag(o,c.PlaylistLevelType.MAIN);return m&&"fragment"in m?m.fragment:m},t.getBufferedFrag=function(o){return this.fragmentTracker.getBufferedFrag(o,c.PlaylistLevelType.MAIN)},t.followingBufferedFrag=function(o){return o?this.getBufferedFrag(o.end+.5):null},t.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},t.nextLevelSwitch=function(){var o=this.levels,m=this.media;if(m!=null&&m.readyState){var L,P=this.getAppendedFrag(m.currentTime);if(P&&P.start>1&&this.flushMainBuffer(0,P.start-1),!m.paused&&o){var y=this.hls.nextLoadLevel,T=o[y],g=this.fragLastKbps;g&&this.fragCurrent?L=this.fragCurrent.duration*T.maxBitrate/(1e3*g)+1:L=0}else L=0;var x=this.getBufferedFrag(m.currentTime+L);if(x){var I=this.followingBufferedFrag(x);if(I){this.abortCurrentFrag();var U=I.maxStartPTS?I.maxStartPTS:I.start,b=I.duration,B=Math.max(x.end,U+Math.min(Math.max(b-this.config.maxFragLookUpTolerance,b*.5),b*.75));this.flushMainBuffer(B,Number.POSITIVE_INFINITY)}}}},t.abortCurrentFrag=function(){var o=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,o!=null&&o.loader&&o.loader.abort(),this.state){case O.State.KEY_LOADING:case O.State.FRAG_LOADING:case O.State.FRAG_LOADING_WAITING_RETRY:case O.State.PARSING:case O.State.PARSED:this.state=O.State.IDLE;break}this.nextLoadPosition=this.getLoadPosition()},t.flushMainBuffer=function(o,m){r.prototype.flushMainBuffer.call(this,o,m,this.altAudio?"video":null)},t.onMediaAttached=function(o,m){r.prototype.onMediaAttached.call(this,o,m);var L=m.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),L.addEventListener("playing",this.onvplaying),L.addEventListener("seeked",this.onvseeked),this.gapController=new S.default(this.config,L,this.fragmentTracker,this.hls)},t.onMediaDetaching=function(){var o=this.media;o&&this.onvplaying&&this.onvseeked&&(o.removeEventListener("playing",this.onvplaying),o.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),r.prototype.onMediaDetaching.call(this)},t.onMediaPlaying=function(){this.tick()},t.onMediaSeeked=function(){var o=this.media,m=o?o.currentTime:null;Object(F.isFiniteNumber)(m)&&this.log("Media seeked to "+m.toFixed(3)),this.tick()},t.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(M.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},t.onManifestParsed=function(o,m){var L=!1,P=!1,y;m.levels.forEach(function(T){y=T.audioCodec,y&&(y.indexOf("mp4a.40.2")!==-1&&(L=!0),y.indexOf("mp4a.40.5")!==-1&&(P=!0))}),this.audioCodecSwitch=L&&P&&!Object(D.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=m.levels,this.startFragRequested=!1},t.onLevelLoading=function(o,m){var L=this.levels;if(!(!L||this.state!==O.State.IDLE)){var P=L[m.level];(!P.details||P.details.live&&this.levelLastLoaded!==m.level||this.waitForCdnTuneIn(P.details))&&(this.state=O.State.WAITING_LEVEL)}},t.onLevelLoaded=function(o,m){var L,P=this.levels,y=m.level,T=m.details,g=T.totalduration;if(!P){this.warn("Levels were reset while loading level "+y);return}this.log("Level "+y+" loaded ["+T.startSN+","+T.endSN+"], cc ["+T.startCC+", "+T.endCC+"] duration:"+g);var x=this.fragCurrent;x&&(this.state===O.State.FRAG_LOADING||this.state===O.State.FRAG_LOADING_WAITING_RETRY)&&x.level!==m.level&&x.loader&&(this.state=O.State.IDLE,this.backtrackFragment=null,x.loader.abort());var I=P[y],U=0;if(T.live||(L=I.details)!==null&&L!==void 0&&L.live){if(T.fragments[0]||(T.deltaUpdateFailed=!0),T.deltaUpdateFailed)return;U=this.alignPlaylists(T,I.details)}if(I.details=T,this.levelLastLoaded=y,this.hls.trigger(M.Events.LEVEL_UPDATED,{details:T,level:y}),this.state===O.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(T))return;this.state=O.State.IDLE}this.startFragRequested?T.live&&this.synchronizeToLiveEdge(T):this.setStartPosition(T,U),this.tick()},t._handleFragmentLoadProgress=function(o){var m,L=o.frag,P=o.part,y=o.payload,T=this.levels;if(!T){this.warn("Levels were reset while fragment load was in progress. Fragment "+L.sn+" of level "+L.level+" will not be buffered");return}var g=T[L.level],x=g.details;if(!x){this.warn("Dropping fragment "+L.sn+" of level "+L.level+" after level details were reset");return}var I=g.videoCodec,U=x.PTSKnown||!x.live,b=(m=L.initSegment)===null||m===void 0?void 0:m.data,B=this._getAudioCodec(g),_=this.transmuxer=this.transmuxer||new l.default(this.hls,c.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),k=P?P.index:-1,N=k!==-1,K=new s.ChunkMetadata(L.level,L.sn,L.stats.chunkCount,y.byteLength,k,N),W=this.initPTS[L.cc];_.push(y,b,B,I,L,P,x.totalduration,U,K,W)},t.onAudioTrackSwitching=function(o,m){var L=this.altAudio,P=!!m.url,y=m.id;if(!P){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var T=this.fragCurrent;T!=null&&T.loader&&(this.log("Switching to main audio track, cancel main fragment load"),T.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var g=this.hls;L&&g.trigger(M.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),g.trigger(M.Events.AUDIO_TRACK_SWITCHED,{id:y})}},t.onAudioTrackSwitched=function(o,m){var L=m.id,P=!!this.hls.audioTracks[L].url;if(P){var y=this.videoBuffer;y&&this.mediaBuffer!==y&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=y)}this.altAudio=P,this.tick()},t.onBufferCreated=function(o,m){var L=m.tracks,P,y,T=!1;for(var g in L){var x=L[g];if(x.id==="main"){if(y=g,P=x,g==="video"){var I=L[g];I&&(this.videoBuffer=I.buffer)}}else T=!0}T&&P?(this.log("Alternate track found, use "+y+".buffered to schedule main fragment loading"),this.mediaBuffer=P.buffer):this.mediaBuffer=this.media},t.onFragBuffered=function(o,m){var L=m.frag,P=m.part;if(!(L&&L.type!==c.PlaylistLevelType.MAIN)){if(this.fragContextChanged(L)){this.warn("Fragment "+L.sn+(P?" p: "+P.index:"")+" of level "+L.level+" finished buffering, but was aborted. state: "+this.state),this.state===O.State.PARSED&&(this.state=O.State.IDLE);return}var y=P?P.stats:L.stats;this.fragLastKbps=Math.round(8*y.total/(y.buffering.end-y.loading.first)),L.sn!=="initSegment"&&(this.fragPrevious=L),this.fragBufferedComplete(L,P)}},t.onError=function(o,m){switch(m.details){case v.ErrorDetails.FRAG_LOAD_ERROR:case v.ErrorDetails.FRAG_LOAD_TIMEOUT:case v.ErrorDetails.KEY_LOAD_ERROR:case v.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(c.PlaylistLevelType.MAIN,m);break;case v.ErrorDetails.LEVEL_LOAD_ERROR:case v.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==O.State.ERROR&&(m.fatal?(this.warn(""+m.details),this.state=O.State.ERROR):!m.levelRetry&&this.state===O.State.WAITING_LEVEL&&(this.state=O.State.IDLE));break;case v.ErrorDetails.BUFFER_FULL_ERROR:if(m.parent==="main"&&(this.state===O.State.PARSING||this.state===O.State.PARSED)){var L=!0,P=this.getFwdBufferInfo(this.media,c.PlaylistLevelType.MAIN);P&&P.len>.5&&(L=!this.reduceMaxBufferLength(P.len)),L&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}break}},t.checkBuffer=function(){var o=this.media,m=this.gapController;if(!(!o||!m||!o.readyState)){if(this.loadedmetadata||!R.BufferHelper.getBuffered(o).length){var L=this.state!==O.State.IDLE?this.fragCurrent:null;m.poll(this.lastCurrentTime,L)}this.lastCurrentTime=o.currentTime}},t.onFragLoadEmergencyAborted=function(){this.state=O.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},t.onBufferFlushed=function(o,m){var L=m.type;if(L!==a.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var P=(L===a.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(P,L,c.PlaylistLevelType.MAIN)}},t.onLevelsUpdated=function(o,m){this.levels=m.levels},t.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},t.seekToStartPos=function(){var o=this.media;if(!!o){var m=o.currentTime,L=this.startPosition;if(L>=0&&m<L){if(o.seeking){this.log("could not seek to "+L+", already seeking at "+m);return}var P=R.BufferHelper.getBuffered(o),y=P.length?P.start(0):0,T=y-L;T>0&&(T<this.config.maxBufferHole||T<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+T+" to match buffer start"),L+=T,this.startPosition=L),this.log("seek to target start position "+L+" from current time "+m),o.currentTime=L}}},t._getAudioCodec=function(o){var m=this.config.defaultAudioCodec||o.audioCodec;return this.audioCodecSwap&&m&&(this.log("Swapping audio codec"),m.indexOf("mp4a.40.5")!==-1?m="mp4a.40.2":m="mp4a.40.5"),m},t._loadBitrateTestFrag=function(o){var m=this;o.bitrateTest=!0,this._doFragLoad(o).then(function(L){var P=m.hls;if(!(!L||P.nextLoadLevel||m.fragContextChanged(o))){m.fragLoadError=0,m.state=O.State.IDLE,m.startFragRequested=!1,m.bitrateTest=!1;var y=o.stats;y.parsing.start=y.parsing.end=y.buffering.start=y.buffering.end=self.performance.now(),P.trigger(M.Events.FRAG_LOADED,L),o.bitrateTest=!1}})},t._handleTransmuxComplete=function(o){var m,L="main",P=this.hls,y=o.remuxResult,T=o.chunkMeta,g=this.getCurrentContext(T);if(!g){this.warn("The loading context changed while buffering fragment "+T.sn+" of level "+T.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(T.level);return}var x=g.frag,I=g.part,U=g.level,b=y.video,B=y.text,_=y.id3,k=y.initSegment,N=U.details,K=this.altAudio?void 0:y.audio;if(!this.fragContextChanged(x)){if(this.state=O.State.PARSING,k){k.tracks&&(this._bufferInitSegment(U,k.tracks,x,T),P.trigger(M.Events.FRAG_PARSING_INIT_SEGMENT,{frag:x,id:L,tracks:k.tracks}));var W=k.initPTS,j=k.timescale;Object(F.isFiniteNumber)(W)&&(this.initPTS[x.cc]=W,P.trigger(M.Events.INIT_PTS_FOUND,{frag:x,id:L,initPTS:W,timescale:j}))}if(b&&y.independent!==!1){if(N){var H=b.startPTS,Y=b.endPTS,Z=b.startDTS,$=b.endDTS;if(I)I.elementaryStreams[b.type]={startPTS:H,endPTS:Y,startDTS:Z,endDTS:$};else if(b.firstKeyFrame&&b.independent&&(this.couldBacktrack=!0),b.dropped&&b.independent){var V=this.getMainFwdBufferInfo(),Q=(V?V.end:this.getLoadPosition())+this.config.maxBufferHole,z=b.firstKeyFramePTS?b.firstKeyFramePTS:H;if(Q<z-this.config.maxBufferHole){this.backtrack(x);return}x.setElementaryStreamInfo(b.type,x.start,Y,x.start,$,!0)}x.setElementaryStreamInfo(b.type,H,Y,Z,$),this.backtrackFragment&&(this.backtrackFragment=x),this.bufferFragmentData(b,x,I,T)}}else if(y.independent===!1){this.backtrack(x);return}if(K){var X=K.startPTS,ee=K.endPTS,J=K.startDTS,te=K.endDTS;I&&(I.elementaryStreams[a.ElementaryStreamTypes.AUDIO]={startPTS:X,endPTS:ee,startDTS:J,endDTS:te}),x.setElementaryStreamInfo(a.ElementaryStreamTypes.AUDIO,X,ee,J,te),this.bufferFragmentData(K,x,I,T)}if(N&&_!==null&&_!==void 0&&(m=_.samples)!==null&&m!==void 0&&m.length){var se={id:L,frag:x,details:N,samples:_.samples};P.trigger(M.Events.FRAG_PARSING_METADATA,se)}if(N&&B){var re={id:L,frag:x,details:N,samples:B.samples};P.trigger(M.Events.FRAG_PARSING_USERDATA,re)}}},t._bufferInitSegment=function(o,m,L,P){var y=this;if(this.state===O.State.PARSING){this.audioOnly=!!m.audio&&!m.video,this.altAudio&&!this.audioOnly&&delete m.audio;var T=m.audio,g=m.video,x=m.audiovideo;if(T){var I=o.audioCodec,U=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(I&&(I.indexOf("mp4a.40.5")!==-1?I="mp4a.40.2":I="mp4a.40.5"),T.metadata.channelCount!==1&&U.indexOf("firefox")===-1&&(I="mp4a.40.5")),U.indexOf("android")!==-1&&T.container!=="audio/mpeg"&&(I="mp4a.40.2",this.log("Android: force audio codec to "+I)),o.audioCodec&&o.audioCodec!==I&&this.log('Swapping manifest audio codec "'+o.audioCodec+'" for "'+I+'"'),T.levelCodec=I,T.id="main",this.log("Init audio buffer, container:"+T.container+", codecs[selected/level/parsed]=["+(I||"")+"/"+(o.audioCodec||"")+"/"+T.codec+"]")}g&&(g.levelCodec=o.videoCodec,g.id="main",this.log("Init video buffer, container:"+g.container+", codecs[level/parsed]=["+(o.videoCodec||"")+"/"+g.codec+"]")),x&&this.log("Init audiovideo buffer, container:"+x.container+", codecs[level/parsed]=["+(o.attrs.CODECS||"")+"/"+x.codec+"]"),this.hls.trigger(M.Events.BUFFER_CODECS,m),Object.keys(m).forEach(function(b){var B=m[b],_=B.initSegment;_!=null&&_.byteLength&&y.hls.trigger(M.Events.BUFFER_APPENDING,{type:b,data:_,frag:L,part:null,chunkMeta:P,parent:L.type})}),this.tick()}},t.getMainFwdBufferInfo=function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,c.PlaylistLevelType.MAIN)},t.backtrack=function(o){this.couldBacktrack=!0,this.backtrackFragment=o,this.resetTransmuxer(),this.flushBufferGap(o),this.fragmentTracker.removeFragment(o),this.fragPrevious=null,this.nextLoadPosition=o.start,this.state=O.State.IDLE},t.checkFragmentChanged=function(){var o=this.media,m=null;if(o&&o.readyState>1&&o.seeking===!1){var L=o.currentTime;if(R.BufferHelper.isBuffered(o,L)?m=this.getAppendedFrag(L):R.BufferHelper.isBuffered(o,L+.1)&&(m=this.getAppendedFrag(L+.1)),m){this.backtrackFragment=null;var P=this.fragPlaying,y=m.level;(!P||m.sn!==P.sn||P.level!==y||m.urlId!==P.urlId)&&(this.hls.trigger(M.Events.FRAG_CHANGED,{frag:m}),(!P||P.level!==y)&&this.hls.trigger(M.Events.LEVEL_SWITCHED,{level:y}),this.fragPlaying=m)}}},d(e,[{key:"nextLevel",get:function(){var o=this.nextBufferedFrag;return o?o.level:-1}},{key:"currentFrag",get:function(){var o=this.media;return o?this.fragPlaying||this.getAppendedFrag(o.currentTime):null}},{key:"currentProgramDateTime",get:function(){var o=this.media;if(o){var m=o.currentTime,L=this.currentFrag;if(L&&Object(F.isFiniteNumber)(m)&&Object(F.isFiniteNumber)(L.programDateTime)){var P=L.programDateTime+(m-L.start)*1e3;return new Date(P)}}return null}},{key:"currentLevel",get:function(){var o=this.currentFrag;return o?o.level:-1}},{key:"nextBufferedFrag",get:function(){var o=this.currentFrag;return o?this.followingBufferedFrag(o):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),e}(O.default)},"./src/crypt/aes-crypto.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return F});var F=function(){function O(M,R){this.subtle=void 0,this.aesIV=void 0,this.subtle=M,this.aesIV=R}var D=O.prototype;return D.decrypt=function(R,A){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},A,R)},O}()},"./src/crypt/aes-decryptor.ts":function(w,C,h){h.r(C),h.d(C,"removePadding",function(){return O}),h.d(C,"default",function(){return D});var F=h("./src/utils/typed-array.ts");function O(M){var R=M.byteLength,A=R&&new DataView(M.buffer).getUint8(R-1);return A?Object(F.sliceUint8)(M,0,R-A):M}var D=function(){function M(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var R=M.prototype;return R.uint8ArrayToUint32Array_=function(c){for(var a=new DataView(c),l=new Uint32Array(4),s=0;s<4;s++)l[s]=a.getUint32(s*4);return l},R.initTable=function(){var c=this.sBox,a=this.invSBox,l=this.subMix,s=l[0],S=l[1],v=l[2],p=l[3],d=this.invSubMix,n=d[0],u=d[1],f=d[2],E=d[3],r=new Uint32Array(256),e=0,t=0,i=0;for(i=0;i<256;i++)i<128?r[i]=i<<1:r[i]=i<<1^283;for(i=0;i<256;i++){var o=t^t<<1^t<<2^t<<3^t<<4;o=o>>>8^o&255^99,c[e]=o,a[o]=e;var m=r[e],L=r[m],P=r[L],y=r[o]*257^o*16843008;s[e]=y<<24|y>>>8,S[e]=y<<16|y>>>16,v[e]=y<<8|y>>>24,p[e]=y,y=P*16843009^L*65537^m*257^e*16843008,n[o]=y<<24|y>>>8,u[o]=y<<16|y>>>16,f[o]=y<<8|y>>>24,E[o]=y,e?(e=m^r[r[r[P^m]]],t^=r[r[t]]):e=t=1}},R.expandKey=function(c){for(var a=this.uint8ArrayToUint32Array_(c),l=!0,s=0;s<a.length&&l;)l=a[s]===this.key[s],s++;if(!l){this.key=a;var S=this.keySize=a.length;if(S!==4&&S!==6&&S!==8)throw new Error("Invalid aes key size="+S);var v=this.ksRows=(S+6+1)*4,p,d,n=this.keySchedule=new Uint32Array(v),u=this.invKeySchedule=new Uint32Array(v),f=this.sBox,E=this.rcon,r=this.invSubMix,e=r[0],t=r[1],i=r[2],o=r[3],m,L;for(p=0;p<v;p++){if(p<S){m=n[p]=a[p];continue}L=m,p%S===0?(L=L<<8|L>>>24,L=f[L>>>24]<<24|f[L>>>16&255]<<16|f[L>>>8&255]<<8|f[L&255],L^=E[p/S|0]<<24):S>6&&p%S===4&&(L=f[L>>>24]<<24|f[L>>>16&255]<<16|f[L>>>8&255]<<8|f[L&255]),n[p]=m=(n[p-S]^L)>>>0}for(d=0;d<v;d++)p=v-d,d&3?L=n[p]:L=n[p-4],d<4||p<=4?u[d]=L:u[d]=e[f[L>>>24]]^t[f[L>>>16&255]]^i[f[L>>>8&255]]^o[f[L&255]],u[d]=u[d]>>>0}},R.networkToHostOrderSwap=function(c){return c<<24|(c&65280)<<8|(c&16711680)>>8|c>>>24},R.decrypt=function(c,a,l){for(var s=this.keySize+6,S=this.invKeySchedule,v=this.invSBox,p=this.invSubMix,d=p[0],n=p[1],u=p[2],f=p[3],E=this.uint8ArrayToUint32Array_(l),r=E[0],e=E[1],t=E[2],i=E[3],o=new Int32Array(c),m=new Int32Array(o.length),L,P,y,T,g,x,I,U,b,B,_,k,N,K,W=this.networkToHostOrderSwap;a<o.length;){for(b=W(o[a]),B=W(o[a+1]),_=W(o[a+2]),k=W(o[a+3]),g=b^S[0],x=k^S[1],I=_^S[2],U=B^S[3],N=4,K=1;K<s;K++)L=d[g>>>24]^n[x>>16&255]^u[I>>8&255]^f[U&255]^S[N],P=d[x>>>24]^n[I>>16&255]^u[U>>8&255]^f[g&255]^S[N+1],y=d[I>>>24]^n[U>>16&255]^u[g>>8&255]^f[x&255]^S[N+2],T=d[U>>>24]^n[g>>16&255]^u[x>>8&255]^f[I&255]^S[N+3],g=L,x=P,I=y,U=T,N=N+4;L=v[g>>>24]<<24^v[x>>16&255]<<16^v[I>>8&255]<<8^v[U&255]^S[N],P=v[x>>>24]<<24^v[I>>16&255]<<16^v[U>>8&255]<<8^v[g&255]^S[N+1],y=v[I>>>24]<<24^v[U>>16&255]<<16^v[g>>8&255]<<8^v[x&255]^S[N+2],T=v[U>>>24]<<24^v[g>>16&255]<<16^v[x>>8&255]<<8^v[I&255]^S[N+3],m[a]=W(L^r),m[a+1]=W(T^e),m[a+2]=W(y^t),m[a+3]=W(P^i),r=b,e=B,t=_,i=k,a=a+4}return m.buffer},M}()},"./src/crypt/decrypter.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return a});var F=h("./src/crypt/aes-crypto.ts"),O=h("./src/crypt/fast-aes-key.ts"),D=h("./src/crypt/aes-decryptor.ts"),M=h("./src/utils/logger.ts"),R=h("./src/utils/mp4-tools.ts"),A=h("./src/utils/typed-array.ts"),c=16,a=function(){function l(S,v,p){var d=p===void 0?{}:p,n=d.removePKCS7Padding,u=n===void 0?!0:n;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=S,this.config=v,this.removePKCS7Padding=u,u)try{var f=self.crypto;f&&(this.subtle=f.subtle||f.webkitSubtle)}catch{}this.subtle===null&&(this.config.enableSoftwareAES=!0)}var s=l.prototype;return s.destroy=function(){this.observer=null},s.isSync=function(){return this.config.enableSoftwareAES},s.flush=function(){var v=this.currentResult;if(!v){this.reset();return}var p=new Uint8Array(v);return this.reset(),this.removePKCS7Padding?Object(D.removePadding)(p):p},s.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},s.decrypt=function(v,p,d,n){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(v),p,d);var u=this.flush();u&&n(u.buffer)}else this.webCryptoDecrypt(new Uint8Array(v),p,d).then(n)},s.softwareDecrypt=function(v,p,d){var n=this.currentIV,u=this.currentResult,f=this.remainderData;this.logOnce("JS AES decrypt"),f&&(v=Object(R.appendUint8Array)(f,v),this.remainderData=null);var E=this.getValidChunk(v);if(!E.length)return null;n&&(d=n);var r=this.softwareDecrypter;r||(r=this.softwareDecrypter=new D.default),r.expandKey(p);var e=u;return this.currentResult=r.decrypt(E.buffer,0,d),this.currentIV=Object(A.sliceUint8)(E,-16).buffer,e||null},s.webCryptoDecrypt=function(v,p,d){var n=this,u=this.subtle;return(this.key!==p||!this.fastAesKey)&&(this.key=p,this.fastAesKey=new O.default(u,p)),this.fastAesKey.expandKey().then(function(f){if(!u)return Promise.reject(new Error("web crypto not initialized"));var E=new F.default(u,d);return E.decrypt(v.buffer,f)}).catch(function(f){return n.onWebCryptoError(f,v,p,d)})},s.onWebCryptoError=function(v,p,d,n){return M.logger.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",v),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(p,d,n)},s.getValidChunk=function(v){var p=v,d=v.length-v.length%c;return d!==v.length&&(p=Object(A.sliceUint8)(v,0,d),this.remainderData=Object(A.sliceUint8)(v,d)),p},s.logOnce=function(v){!this.logEnabled||(M.logger.log("[decrypter.ts]: "+v),this.logEnabled=!1)},l}()},"./src/crypt/fast-aes-key.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return F});var F=function(){function O(M,R){this.subtle=void 0,this.key=void 0,this.subtle=M,this.key=R}var D=O.prototype;return D.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},O}()},"./src/demux/aacdemuxer.ts":function(w,C,h){h.r(C);var F=h("./src/demux/base-audio-demuxer.ts"),O=h("./src/demux/adts.ts"),D=h("./src/utils/logger.ts"),M=h("./src/demux/id3.ts");function R(a,l){a.prototype=Object.create(l.prototype),a.prototype.constructor=a,A(a,l)}function A(a,l){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(S,v){return S.__proto__=v,S},A(a,l)}var c=function(a){R(l,a);function l(S,v){var p;return p=a.call(this)||this,p.observer=void 0,p.config=void 0,p.observer=S,p.config=v,p}var s=l.prototype;return s.resetInitSegment=function(v,p,d,n){a.prototype.resetInitSegment.call(this,v,p,d,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:p,duration:n,inputTimeScale:9e4,dropped:0}},l.probe=function(v){if(!v)return!1;for(var p=M.getID3Data(v,0)||[],d=p.length,n=v.length;d<n;d++)if(O.probe(v,d))return D.logger.log("ADTS sync word found !"),!0;return!1},s.canParse=function(v,p){return O.canParse(v,p)},s.appendFrame=function(v,p,d){O.initTrackConfig(v,this.observer,p,d,v.manifestCodec);var n=O.appendFrame(v,p,d,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n},l}(F.default);C.default=c},"./src/demux/adts.ts":function(w,C,h){h.r(C),h.d(C,"getAudioConfig",function(){return M}),h.d(C,"isHeaderPattern",function(){return R}),h.d(C,"getHeaderLength",function(){return A}),h.d(C,"getFullFrameLength",function(){return c}),h.d(C,"canGetFrameLength",function(){return a}),h.d(C,"isHeader",function(){return l}),h.d(C,"canParse",function(){return s}),h.d(C,"probe",function(){return S}),h.d(C,"initTrackConfig",function(){return v}),h.d(C,"getFrameDuration",function(){return p}),h.d(C,"parseFrameHeader",function(){return d}),h.d(C,"appendFrame",function(){return n});var F=h("./src/utils/logger.ts"),O=h("./src/errors.ts"),D=h("./src/events.ts");function M(u,f,E,r){var e,t,i,o,m=navigator.userAgent.toLowerCase(),L=r,P=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];e=((f[E+2]&192)>>>6)+1;var y=(f[E+2]&60)>>>2;if(y>P.length-1){u.trigger(D.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+y});return}return i=(f[E+2]&1)<<2,i|=(f[E+3]&192)>>>6,F.logger.log("manifest codec:"+r+", ADTS type:"+e+", samplingIndex:"+y),/firefox/i.test(m)?y>=6?(e=5,o=new Array(4),t=y-3):(e=2,o=new Array(2),t=y):m.indexOf("android")!==-1?(e=2,o=new Array(2),t=y):(e=5,o=new Array(4),r&&(r.indexOf("mp4a.40.29")!==-1||r.indexOf("mp4a.40.5")!==-1)||!r&&y>=6?t=y-3:((r&&r.indexOf("mp4a.40.2")!==-1&&(y>=6&&i===1||/vivaldi/i.test(m))||!r&&i===1)&&(e=2,o=new Array(2)),t=y)),o[0]=e<<3,o[0]|=(y&14)>>1,o[1]|=(y&1)<<7,o[1]|=i<<3,e===5&&(o[1]|=(t&14)>>1,o[2]=(t&1)<<7,o[2]|=2<<2,o[3]=0),{config:o,samplerate:P[y],channelCount:i,codec:"mp4a.40."+e,manifestCodec:L}}function R(u,f){return u[f]===255&&(u[f+1]&246)===240}function A(u,f){return u[f+1]&1?7:9}function c(u,f){return(u[f+3]&3)<<11|u[f+4]<<3|(u[f+5]&224)>>>5}function a(u,f){return f+5<u.length}function l(u,f){return f+1<u.length&&R(u,f)}function s(u,f){return a(u,f)&&R(u,f)&&c(u,f)<=u.length-f}function S(u,f){if(l(u,f)){var E=A(u,f);if(f+E>=u.length)return!1;var r=c(u,f);if(r<=E)return!1;var e=f+r;return e===u.length||l(u,e)}return!1}function v(u,f,E,r,e){if(!u.samplerate){var t=M(f,E,r,e);if(!t)return;u.config=t.config,u.samplerate=t.samplerate,u.channelCount=t.channelCount,u.codec=t.codec,u.manifestCodec=t.manifestCodec,F.logger.log("parsed codec:"+u.codec+", rate:"+t.samplerate+", channels:"+t.channelCount)}}function p(u){return 1024*9e4/u}function d(u,f){var E=A(u,f);if(f+E<=u.length){var r=c(u,f)-E;if(r>0)return{headerLength:E,frameLength:r}}}function n(u,f,E,r,e){var t=p(u.samplerate),i=r+e*t,o=d(f,E),m;if(o){var L=o.frameLength,P=o.headerLength,y=P+L,T=Math.max(0,E+y-f.length);T?(m=new Uint8Array(y-P),m.set(f.subarray(E+P,f.length),0)):m=f.subarray(E+P,E+y);var g={unit:m,pts:i};return T||u.samples.push(g),{sample:g,length:y,missing:T}}var x=f.length-E;m=new Uint8Array(x),m.set(f.subarray(E,f.length),0);var I={unit:m,pts:i};return{sample:I,length:x,missing:-1}}},"./src/demux/base-audio-demuxer.ts":function(w,C,h){h.r(C),h.d(C,"initPTSFn",function(){return a});var F=h("./src/polyfills/number.ts"),O=h("./src/demux/id3.ts"),D=h("./src/types/demuxer.ts"),M=h("./src/demux/dummy-demuxed-track.ts"),R=h("./src/utils/mp4-tools.ts"),A=h("./src/utils/typed-array.ts"),c=function(){function l(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null}var s=l.prototype;return s.resetInitSegment=function(v,p,d,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},s.resetTimeStamp=function(v){this.initPTS=v,this.resetContiguity()},s.resetContiguity=function(){this.basePTS=null,this.frameIndex=0},s.canParse=function(v,p){return!1},s.appendFrame=function(v,p,d){},s.demux=function(v,p){this.cachedData&&(v=Object(R.appendUint8Array)(this.cachedData,v),this.cachedData=null);var d=O.getID3Data(v,0),n=d?d.length:0,u,f,E=this._audioTrack,r=this._id3Track,e=d?O.getTimeStamp(d):void 0,t=v.length;for((this.basePTS===null||this.frameIndex===0&&Object(F.isFiniteNumber)(e))&&(this.basePTS=a(e,p,this.initPTS)),d&&d.length>0&&r.samples.push({pts:this.basePTS,dts:this.basePTS,data:d,type:D.MetadataSchema.audioId3}),f=this.basePTS;n<t;){if(this.canParse(v,n)){var i=this.appendFrame(E,v,n);i?(this.frameIndex++,f=i.sample.pts,n+=i.length,u=n):n=t}else O.canParse(v,n)?(d=O.getID3Data(v,n),r.samples.push({pts:f,dts:f,data:d,type:D.MetadataSchema.audioId3}),n+=d.length,u=n):n++;if(n===t&&u!==t){var o=Object(A.sliceUint8)(v,u);this.cachedData?this.cachedData=Object(R.appendUint8Array)(this.cachedData,o):this.cachedData=o}}return{audioTrack:E,videoTrack:Object(M.dummyTrack)(),id3Track:r,textTrack:Object(M.dummyTrack)()}},s.demuxSampleAes=function(v,p,d){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},s.flush=function(v){var p=this.cachedData;return p&&(this.cachedData=null,this.demux(p,0)),{audioTrack:this._audioTrack,videoTrack:Object(M.dummyTrack)(),id3Track:this._id3Track,textTrack:Object(M.dummyTrack)()}},s.destroy=function(){},l}(),a=function(s,S,v){return Object(F.isFiniteNumber)(s)?s*90:S*9e4+(v||0)};C.default=c},"./src/demux/chunk-cache.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return F});var F=function(){function D(){this.chunks=[],this.dataLength=0}var M=D.prototype;return M.push=function(A){this.chunks.push(A),this.dataLength+=A.length},M.flush=function(){var A=this.chunks,c=this.dataLength,a;if(A.length)A.length===1?a=A[0]:a=O(A,c);else return new Uint8Array(0);return this.reset(),a},M.reset=function(){this.chunks.length=0,this.dataLength=0},D}();function O(D,M){for(var R=new Uint8Array(M),A=0,c=0;c<D.length;c++){var a=D[c];R.set(a,A),A+=a.length}return R}},"./src/demux/dummy-demuxed-track.ts":function(w,C,h){h.r(C),h.d(C,"dummyTrack",function(){return F});function F(O,D){return O===void 0&&(O=""),D===void 0&&(D=9e4),{type:O,id:-1,pid:-1,inputTimeScale:D,sequenceNumber:-1,samples:[],dropped:0}}},"./src/demux/exp-golomb.ts":function(w,C,h){h.r(C);var F=h("./src/utils/logger.ts"),O=function(){function D(R){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=R,this.bytesAvailable=R.byteLength,this.word=0,this.bitsAvailable=0}var M=D.prototype;return M.loadWord=function(){var A=this.data,c=this.bytesAvailable,a=A.byteLength-c,l=new Uint8Array(4),s=Math.min(4,c);if(s===0)throw new Error("no bytes available");l.set(A.subarray(a,a+s)),this.word=new DataView(l.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s},M.skipBits=function(A){var c;this.bitsAvailable>A?(this.word<<=A,this.bitsAvailable-=A):(A-=this.bitsAvailable,c=A>>3,A-=c>>3,this.bytesAvailable-=c,this.loadWord(),this.word<<=A,this.bitsAvailable-=A)},M.readBits=function(A){var c=Math.min(this.bitsAvailable,A),a=this.word>>>32-c;return A>32&&F.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=c,this.bitsAvailable>0?this.word<<=c:this.bytesAvailable>0&&this.loadWord(),c=A-c,c>0&&this.bitsAvailable?a<<c|this.readBits(c):a},M.skipLZ=function(){var A;for(A=0;A<this.bitsAvailable;++A)if((this.word&2147483648>>>A)!==0)return this.word<<=A,this.bitsAvailable-=A,A;return this.loadWord(),A+this.skipLZ()},M.skipUEG=function(){this.skipBits(1+this.skipLZ())},M.skipEG=function(){this.skipBits(1+this.skipLZ())},M.readUEG=function(){var A=this.skipLZ();return this.readBits(A+1)-1},M.readEG=function(){var A=this.readUEG();return 1&A?1+A>>>1:-1*(A>>>1)},M.readBoolean=function(){return this.readBits(1)===1},M.readUByte=function(){return this.readBits(8)},M.readUShort=function(){return this.readBits(16)},M.readUInt=function(){return this.readBits(32)},M.skipScalingList=function(A){for(var c=8,a=8,l,s=0;s<A;s++)a!==0&&(l=this.readEG(),a=(c+l+256)%256),c=a===0?c:a},M.readSPS=function(){var A=0,c=0,a=0,l=0,s,S,v,p=this.readUByte.bind(this),d=this.readBits.bind(this),n=this.readUEG.bind(this),u=this.readBoolean.bind(this),f=this.skipBits.bind(this),E=this.skipEG.bind(this),r=this.skipUEG.bind(this),e=this.skipScalingList.bind(this);p();var t=p();if(d(5),f(3),p(),r(),t===100||t===110||t===122||t===244||t===44||t===83||t===86||t===118||t===128){var i=n();if(i===3&&f(1),r(),r(),f(1),u())for(S=i!==3?8:12,v=0;v<S;v++)u()&&(v<6?e(16):e(64))}r();var o=n();if(o===0)n();else if(o===1)for(f(1),E(),E(),s=n(),v=0;v<s;v++)E();r(),f(1);var m=n(),L=n(),P=d(1);P===0&&f(1),f(1),u()&&(A=n(),c=n(),a=n(),l=n());var y=[1,1];if(u()&&u()){var T=p();switch(T){case 1:y=[1,1];break;case 2:y=[12,11];break;case 3:y=[10,11];break;case 4:y=[16,11];break;case 5:y=[40,33];break;case 6:y=[24,11];break;case 7:y=[20,11];break;case 8:y=[32,11];break;case 9:y=[80,33];break;case 10:y=[18,11];break;case 11:y=[15,11];break;case 12:y=[64,33];break;case 13:y=[160,99];break;case 14:y=[4,3];break;case 15:y=[3,2];break;case 16:y=[2,1];break;case 255:{y=[p()<<8|p(),p()<<8|p()];break}}}return{width:Math.ceil((m+1)*16-A*2-c*2),height:(2-P)*(L+1)*16-(P?2:4)*(a+l),pixelRatio:y}},M.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},D}();C.default=O},"./src/demux/id3.ts":function(w,C,h){h.r(C),h.d(C,"isHeader",function(){return F}),h.d(C,"isFooter",function(){return O}),h.d(C,"getID3Data",function(){return D}),h.d(C,"canParse",function(){return R}),h.d(C,"getTimeStamp",function(){return A}),h.d(C,"isTimeStampFrame",function(){return c}),h.d(C,"getID3Frames",function(){return l}),h.d(C,"decodeFrame",function(){return s}),h.d(C,"utf8ArrayToStr",function(){return n}),h.d(C,"testables",function(){return u});var F=function(e,t){return t+10<=e.length&&e[t]===73&&e[t+1]===68&&e[t+2]===51&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128},O=function(e,t){return t+10<=e.length&&e[t]===51&&e[t+1]===68&&e[t+2]===73&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128},D=function(e,t){for(var i=t,o=0;F(e,t);){o+=10;var m=M(e,t+6);o+=m,O(e,t+10)&&(o+=10),t+=o}if(o>0)return e.subarray(i,i+o)},M=function(e,t){var i=0;return i=(e[t]&127)<<21,i|=(e[t+1]&127)<<14,i|=(e[t+2]&127)<<7,i|=e[t+3]&127,i},R=function(e,t){return F(e,t)&&M(e,t+6)+10<=e.length-t},A=function(e){for(var t=l(e),i=0;i<t.length;i++){var o=t[i];if(c(o))return d(o)}},c=function(e){return e&&e.key==="PRIV"&&e.info==="com.apple.streaming.transportStreamTimestamp"},a=function(e){var t=String.fromCharCode(e[0],e[1],e[2],e[3]),i=M(e,4),o=10;return{type:t,size:i,data:e.subarray(o,o+i)}},l=function(e){for(var t=0,i=[];F(e,t);){var o=M(e,t+6);t+=10;for(var m=t+o;t+8<m;){var L=a(e.subarray(t)),P=s(L);P&&i.push(P),t+=L.size+10}O(e,t)&&(t+=10)}return i},s=function(e){return e.type==="PRIV"?S(e):e.type[0]==="W"?p(e):v(e)},S=function(e){if(!(e.size<2)){var t=n(e.data,!0),i=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:i.buffer}}},v=function(e){if(!(e.size<2)){if(e.type==="TXXX"){var t=1,i=n(e.data.subarray(t),!0);t+=i.length+1;var o=n(e.data.subarray(t));return{key:e.type,info:i,data:o}}var m=n(e.data.subarray(1));return{key:e.type,data:m}}},p=function(e){if(e.type==="WXXX"){if(e.size<2)return;var t=1,i=n(e.data.subarray(t),!0);t+=i.length+1;var o=n(e.data.subarray(t));return{key:e.type,info:i,data:o}}var m=n(e.data);return{key:e.type,data:m}},d=function(e){if(e.data.byteLength===8){var t=new Uint8Array(e.data),i=t[3]&1,o=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return o/=45,i&&(o+=4772185884e-2),Math.round(o)}},n=function(e,t){t===void 0&&(t=!1);var i=E();if(i){var o=i.decode(e);if(t){var m=o.indexOf("\0");return m!==-1?o.substring(0,m):o}return o.replace(/\0/g,"")}for(var L=e.length,P,y,T,g="",x=0;x<L;){if(P=e[x++],P===0&&t)return g;if(P===0||P===3)continue;switch(P>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:g+=String.fromCharCode(P);break;case 12:case 13:y=e[x++],g+=String.fromCharCode((P&31)<<6|y&63);break;case 14:y=e[x++],T=e[x++],g+=String.fromCharCode((P&15)<<12|(y&63)<<6|(T&63)<<0);break}}return g},u={decodeTextFrame:v},f;function E(){return!f&&typeof self.TextDecoder!="undefined"&&(f=new self.TextDecoder("utf-8")),f}},"./src/demux/mp3demuxer.ts":function(w,C,h){h.r(C);var F=h("./src/demux/base-audio-demuxer.ts"),O=h("./src/demux/id3.ts"),D=h("./src/utils/logger.ts"),M=h("./src/demux/mpegaudio.ts");function R(a,l){a.prototype=Object.create(l.prototype),a.prototype.constructor=a,A(a,l)}function A(a,l){return A=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(S,v){return S.__proto__=v,S},A(a,l)}var c=function(a){R(l,a);function l(){return a.apply(this,arguments)||this}var s=l.prototype;return s.resetInitSegment=function(v,p,d,n){a.prototype.resetInitSegment.call(this,v,p,d,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:p,duration:n,inputTimeScale:9e4,dropped:0}},l.probe=function(v){if(!v)return!1;for(var p=O.getID3Data(v,0)||[],d=p.length,n=v.length;d<n;d++)if(M.probe(v,d))return D.logger.log("MPEG Audio sync word found !"),!0;return!1},s.canParse=function(v,p){return M.canParse(v,p)},s.appendFrame=function(v,p,d){if(this.basePTS!==null)return M.appendFrame(v,p,d,this.basePTS,this.frameIndex)},l}(F.default);C.default=c},"./src/demux/mp4demuxer.ts":function(w,C,h){h.r(C);var F=h("./src/polyfills/number.ts"),O=h("./src/types/demuxer.ts"),D=h("./src/utils/mp4-tools.ts"),M=h("./src/demux/dummy-demuxed-track.ts"),R=/\/emsg[-/]ID3/i,A=function(){function c(l,s){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=s}var a=c.prototype;return a.resetTimeStamp=function(){},a.resetInitSegment=function(s,S,v,p){var d=Object(D.parseInitSegment)(s),n=this.videoTrack=Object(M.dummyTrack)("video",1),u=this.audioTrack=Object(M.dummyTrack)("audio",1),f=this.txtTrack=Object(M.dummyTrack)("text",1);if(this.id3Track=Object(M.dummyTrack)("id3",1),this.timeOffset=0,d.video){var E=d.video,r=E.id,e=E.timescale,t=E.codec;n.id=r,n.timescale=f.timescale=e,n.codec=t}if(d.audio){var i=d.audio,o=i.id,m=i.timescale,L=i.codec;u.id=o,u.timescale=m,u.codec=L}f.id=D.RemuxerTrackIdConfig.text,n.sampleDuration=0,n.duration=u.duration=p},a.resetContiguity=function(){},c.probe=function(s){return s=s.length>16384?s.subarray(0,16384):s,Object(D.findBox)(s,["moof"]).length>0},a.demux=function(s,S){this.timeOffset=S;var v=s,p=this.videoTrack,d=this.txtTrack;if(this.config.progressive){this.remainderData&&(v=Object(D.appendUint8Array)(this.remainderData,s));var n=Object(D.segmentValidRange)(v);this.remainderData=n.remainder,p.samples=n.valid||new Uint8Array}else p.samples=v;var u=this.extractID3Track(p,S);return d.samples=Object(D.parseSamples)(S,p),{videoTrack:p,audioTrack:this.audioTrack,id3Track:u,textTrack:this.txtTrack}},a.flush=function(){var s=this.timeOffset,S=this.videoTrack,v=this.txtTrack;S.samples=this.remainderData||new Uint8Array,this.remainderData=null;var p=this.extractID3Track(S,this.timeOffset);return v.samples=Object(D.parseSamples)(s,S),{videoTrack:S,audioTrack:Object(M.dummyTrack)(),id3Track:p,textTrack:Object(M.dummyTrack)()}},a.extractID3Track=function(s,S){var v=this.id3Track;if(s.samples.length){var p=Object(D.findBox)(s.samples,["emsg"]);p&&p.forEach(function(d){var n=Object(D.parseEmsg)(d);if(R.test(n.schemeIdUri)){var u=Object(F.isFiniteNumber)(n.presentationTime)?n.presentationTime/n.timeScale:S+n.presentationTimeDelta/n.timeScale,f=n.payload;v.samples.push({data:f,len:f.byteLength,dts:u,pts:u,type:O.MetadataSchema.emsg})}})}return v},a.demuxSampleAes=function(s,S,v){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},a.destroy=function(){},c}();C.default=A},"./src/demux/mpegaudio.ts":function(w,C,h){h.r(C),h.d(C,"appendFrame",function(){return A}),h.d(C,"parseHeader",function(){return c}),h.d(C,"isHeaderPattern",function(){return a}),h.d(C,"isHeader",function(){return l}),h.d(C,"canParse",function(){return s}),h.d(C,"probe",function(){return S});var F=null,O=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],D=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],M=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],R=[0,1,1,4];function A(v,p,d,n,u){if(!(d+24>p.length)){var f=c(p,d);if(f&&d+f.frameLength<=p.length){var E=f.samplesPerFrame*9e4/f.sampleRate,r=n+u*E,e={unit:p.subarray(d,d+f.frameLength),pts:r,dts:r};return v.config=[],v.channelCount=f.channelCount,v.samplerate=f.sampleRate,v.samples.push(e),{sample:e,length:f.frameLength,missing:0}}}}function c(v,p){var d=v[p+1]>>3&3,n=v[p+1]>>1&3,u=v[p+2]>>4&15,f=v[p+2]>>2&3;if(d!==1&&u!==0&&u!==15&&f!==3){var E=v[p+2]>>1&1,r=v[p+3]>>6,e=d===3?3-n:n===3?3:4,t=O[e*14+u-1]*1e3,i=d===3?0:d===2?1:2,o=D[i*3+f],m=r===3?1:2,L=M[d][n],P=R[n],y=L*8*P,T=Math.floor(L*t/o+E)*P;if(F===null){var g=navigator.userAgent||"",x=g.match(/Chrome\/(\d+)/i);F=x?parseInt(x[1]):0}var I=!!F&&F<=87;return I&&n===2&&t>=224e3&&r===0&&(v[p+3]=v[p+3]|128),{sampleRate:o,channelCount:m,frameLength:T,samplesPerFrame:y}}}function a(v,p){return v[p]===255&&(v[p+1]&224)===224&&(v[p+1]&6)!==0}function l(v,p){return p+1<v.length&&a(v,p)}function s(v,p){var d=4;return a(v,p)&&d<=v.length-p}function S(v,p){if(p+1<v.length&&a(v,p)){var d=4,n=c(v,p),u=d;n!=null&&n.frameLength&&(u=n.frameLength);var f=p+u;return f===v.length||l(v,f)}return!1}},"./src/demux/sample-aes.ts":function(w,C,h){h.r(C);var F=h("./src/crypt/decrypter.ts"),O=h("./src/demux/tsdemuxer.ts"),D=function(){function M(A,c,a){this.keyData=void 0,this.decrypter=void 0,this.keyData=a,this.decrypter=new F.default(A,c,{removePKCS7Padding:!1})}var R=M.prototype;return R.decryptBuffer=function(c,a){this.decrypter.decrypt(c,this.keyData.key.buffer,this.keyData.iv.buffer,a)},R.decryptAacSample=function(c,a,l,s){var S=c[a].unit;if(!(S.length<=16)){var v=S.subarray(16,S.length-S.length%16),p=v.buffer.slice(v.byteOffset,v.byteOffset+v.length),d=this;this.decryptBuffer(p,function(n){var u=new Uint8Array(n);S.set(u,16),s||d.decryptAacSamples(c,a+1,l)})}},R.decryptAacSamples=function(c,a,l){for(;;a++){if(a>=c.length){l();return}if(!(c[a].unit.length<32)){var s=this.decrypter.isSync();if(this.decryptAacSample(c,a,l,s),!s)return}}},R.getAvcEncryptedData=function(c){for(var a=Math.floor((c.length-48)/160)*16+16,l=new Int8Array(a),s=0,S=32;S<c.length-16;S+=160,s+=16)l.set(c.subarray(S,S+16),s);return l},R.getAvcDecryptedUnit=function(c,a){for(var l=new Uint8Array(a),s=0,S=32;S<c.length-16;S+=160,s+=16)c.set(l.subarray(s,s+16),S);return c},R.decryptAvcSample=function(c,a,l,s,S,v){var p=Object(O.discardEPB)(S.data),d=this.getAvcEncryptedData(p),n=this;this.decryptBuffer(d.buffer,function(u){S.data=n.getAvcDecryptedUnit(p,u),v||n.decryptAvcSamples(c,a,l+1,s)})},R.decryptAvcSamples=function(c,a,l,s){if(c instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;a++,l=0){if(a>=c.length){s();return}for(var S=c[a].units;!(l>=S.length);l++){var v=S[l];if(!(v.data.length<=48||v.type!==1&&v.type!==5)){var p=this.decrypter.isSync();if(this.decryptAvcSample(c,a,l,s,v,p),!p)return}}}},M}();C.default=D},"./src/demux/transmuxer-interface.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return l});var F=h("./node_modules/webworkify-webpack/index.js"),O=h("./src/events.ts"),D=h("./src/demux/transmuxer.ts"),M=h("./src/utils/logger.ts"),R=h("./src/errors.ts"),A=h("./src/utils/mediasource-helper.ts"),c=h("./node_modules/eventemitter3/index.js"),a=Object(A.getMediaSource)()||{isTypeSupported:function(){return!1}},l=function(){function s(v,p,d,n){var u=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.hls=v,this.id=p,this.onTransmuxComplete=d,this.onFlush=n;var f=v.config,E=function(o,m){m=m||{},m.frag=u.frag,m.id=u.id,v.trigger(o,m)};this.observer=new c.EventEmitter,this.observer.on(O.Events.FRAG_DECRYPTED,E),this.observer.on(O.Events.ERROR,E);var r={mp4:a.isTypeSupported("video/mp4"),mpeg:a.isTypeSupported("audio/mpeg"),mp3:a.isTypeSupported('audio/mp4; codecs="mp3"')},e=navigator.vendor;if(f.enableWorker&&typeof Worker!="undefined"){M.logger.log("demuxing in webworker");var t;try{t=this.worker=F("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),t.addEventListener("message",this.onwmsg),t.onerror=function(i){v.trigger(O.Events.ERROR,{type:R.ErrorTypes.OTHER_ERROR,details:R.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",error:new Error(i.message+"  ("+i.filename+":"+i.lineno+")")})},t.postMessage({cmd:"init",typeSupported:r,vendor:e,id:p,config:JSON.stringify(f)})}catch(i){M.logger.warn("Error in worker:",i),M.logger.error("Error while initializing DemuxerWorker, fallback to inline"),t&&self.URL.revokeObjectURL(t.objectURL),this.transmuxer=new D.default(this.observer,r,f,e,p),this.worker=null}}else this.transmuxer=new D.default(this.observer,r,f,e,p)}var S=s.prototype;return S.destroy=function(){var p=this.worker;if(p)p.removeEventListener("message",this.onwmsg),p.terminate(),this.worker=null,this.onwmsg=void 0;else{var d=this.transmuxer;d&&(d.destroy(),this.transmuxer=null)}var n=this.observer;n&&n.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},S.push=function(p,d,n,u,f,E,r,e,t,i){var o,m,L=this;t.transmuxing.start=self.performance.now();var P=this.transmuxer,y=this.worker,T=E?E.start:f.start,g=f.decryptdata,x=this.frag,I=!(x&&f.cc===x.cc),U=!(x&&t.level===x.level),b=x?t.sn-x.sn:-1,B=this.part?t.part-this.part.index:-1,_=b===0&&t.id>1&&t.id===(x==null?void 0:x.stats.chunkCount),k=!U&&(b===1||b===0&&(B===1||_&&B<=0)),N=self.performance.now();(U||b||f.stats.parsing.start===0)&&(f.stats.parsing.start=N),E&&(B||!k)&&(E.stats.parsing.start=N);var K=!(x&&((o=f.initSegment)===null||o===void 0?void 0:o.url)===((m=x.initSegment)===null||m===void 0?void 0:m.url)),W=new D.TransmuxState(I,k,e,U,T,K);if(!k||I||K){M.logger.log("[transmuxer-interface, "+f.type+"]: Starting new transmux session for sn: "+t.sn+" p: "+t.part+" level: "+t.level+" id: "+t.id+`
        discontinuity: `+I+`
        trackSwitch: `+U+`
        contiguous: `+k+`
        accurateTimeOffset: `+e+`
        timeOffset: `+T+`
        initSegmentChange: `+K);var j=new D.TransmuxConfig(n,u,d,r,i);this.configureTransmuxer(j)}if(this.frag=f,this.part=E,y)y.postMessage({cmd:"demux",data:p,decryptdata:g,chunkMeta:t,state:W},p instanceof ArrayBuffer?[p]:[]);else if(P){var H=P.push(p,g,t,W);Object(D.isPromise)(H)?H.then(function(Y){L.handleTransmuxComplete(Y)}):this.handleTransmuxComplete(H)}},S.flush=function(p){var d=this;p.transmuxing.start=self.performance.now();var n=this.transmuxer,u=this.worker;if(u)u.postMessage({cmd:"flush",chunkMeta:p});else if(n){var f=n.flush(p);Object(D.isPromise)(f)?f.then(function(E){d.handleFlushResult(E,p)}):this.handleFlushResult(f,p)}},S.handleFlushResult=function(p,d){var n=this;p.forEach(function(u){n.handleTransmuxComplete(u)}),this.onFlush(d)},S.onWorkerMessage=function(p){var d=p.data,n=this.hls;switch(d.event){case"init":{self.URL.revokeObjectURL(this.worker.objectURL);break}case"transmuxComplete":{this.handleTransmuxComplete(d.data);break}case"flush":{this.onFlush(d.data);break}case"workerLog":M.logger[d.data.logType]&&M.logger[d.data.logType](d.data.message);break;default:{d.data=d.data||{},d.data.frag=this.frag,d.data.id=this.id,n.trigger(d.event,d.data);break}}},S.configureTransmuxer=function(p){var d=this.worker,n=this.transmuxer;d?d.postMessage({cmd:"configure",config:p}):n&&n.configure(p)},S.handleTransmuxComplete=function(p){p.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(p)},s}()},"./src/demux/transmuxer-worker.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return R});var F=h("./src/demux/transmuxer.ts"),O=h("./src/events.ts"),D=h("./src/utils/logger.ts"),M=h("./node_modules/eventemitter3/index.js");function R(s){var S=new M.EventEmitter,v=function(n,u){s.postMessage({event:n,data:u})};S.on(O.Events.FRAG_DECRYPTED,v),S.on(O.Events.ERROR,v);var p=function(){var n=function(E){var r=function(t){v("workerLog",{logType:E,message:t})};D.logger[E]=r};for(var u in D.logger)n(u)};s.addEventListener("message",function(d){var n=d.data;switch(n.cmd){case"init":{var u=JSON.parse(n.config);s.transmuxer=new F.default(S,n.typeSupported,u,n.vendor,n.id),Object(D.enableLogs)(u.debug),p(),v("init",null);break}case"configure":{s.transmuxer.configure(n.config);break}case"demux":{var f=s.transmuxer.push(n.data,n.decryptdata,n.chunkMeta,n.state);Object(F.isPromise)(f)?f.then(function(e){A(s,e)}):A(s,f);break}case"flush":{var E=n.chunkMeta,r=s.transmuxer.flush(E);Object(F.isPromise)(r)?r.then(function(e){a(s,e,E)}):a(s,r,E);break}}})}function A(s,S){if(l(S.remuxResult))return!1;var v=[],p=S.remuxResult,d=p.audio,n=p.video;return d&&c(v,d),n&&c(v,n),s.postMessage({event:"transmuxComplete",data:S},v),!0}function c(s,S){S.data1&&s.push(S.data1.buffer),S.data2&&s.push(S.data2.buffer)}function a(s,S,v){var p=S.reduce(function(d,n){return A(s,n)||d},!1);p||s.postMessage({event:"transmuxComplete",data:S[0]}),s.postMessage({event:"flush",data:v})}function l(s){return!s.audio&&!s.video&&!s.text&&!s.id3&&!s.initSegment}},"./src/demux/transmuxer.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return p}),h.d(C,"isPromise",function(){return u}),h.d(C,"TransmuxConfig",function(){return f}),h.d(C,"TransmuxState",function(){return E});var F=h("./src/events.ts"),O=h("./src/errors.ts"),D=h("./src/crypt/decrypter.ts"),M=h("./src/demux/aacdemuxer.ts"),R=h("./src/demux/mp4demuxer.ts"),A=h("./src/demux/tsdemuxer.ts"),c=h("./src/demux/mp3demuxer.ts"),a=h("./src/remux/mp4-remuxer.ts"),l=h("./src/remux/passthrough-remuxer.ts"),s=h("./src/utils/logger.ts"),S;try{S=self.performance.now.bind(self.performance)}catch{s.logger.debug("Unable to use Performance API on this environment"),S=self.Date.now}var v=[{demux:A.default,remux:a.default},{demux:R.default,remux:l.default},{demux:M.default,remux:a.default},{demux:c.default,remux:a.default}],p=function(){function r(t,i,o,m,L){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=i,this.config=o,this.vendor=m,this.id=L}var e=r.prototype;return e.configure=function(i){this.transmuxConfig=i,this.decrypter&&this.decrypter.reset()},e.push=function(i,o,m,L){var P=this,y=m.transmuxing;y.executeStart=S();var T=new Uint8Array(i),g=this.config,x=this.currentTransmuxState,I=this.transmuxConfig;L&&(this.currentTransmuxState=L);var U=L||x,b=U.contiguous,B=U.discontinuity,_=U.trackSwitch,k=U.accurateTimeOffset,N=U.timeOffset,K=U.initSegmentChange,W=I.audioCodec,j=I.videoCodec,H=I.defaultInitPts,Y=I.duration,Z=I.initSegmentData;(B||_||K)&&this.resetInitSegment(Z,W,j,Y),(B||K)&&this.resetInitialTimestamp(H),b||this.resetContiguity();var $=d(T,o);if($&&$.method==="AES-128"){var V=this.getDecrypter();if(g.enableSoftwareAES){var Q=V.softwareDecrypt(T,$.key.buffer,$.iv.buffer);if(!Q)return y.executeEnd=S(),n(m);T=new Uint8Array(Q)}else return this.decryptionPromise=V.webCryptoDecrypt(T,$.key.buffer,$.iv.buffer).then(function(ee){var J=P.push(ee,null,m);return P.decryptionPromise=null,J}),this.decryptionPromise}this.needsProbing(T,B,_)&&this.configureTransmuxer(T,I);var z=this.transmux(T,$,N,k,m),X=this.currentTransmuxState;return X.contiguous=!0,X.discontinuity=!1,X.trackSwitch=!1,y.executeEnd=S(),z},e.flush=function(i){var o=this,m=i.transmuxing;m.executeStart=S();var L=this.decrypter,P=this.currentTransmuxState,y=this.decryptionPromise;if(y)return y.then(function(){return o.flush(i)});var T=[],g=P.timeOffset;if(L){var x=L.flush();x&&T.push(this.push(x,null,i))}var I=this.demuxer,U=this.remuxer;if(!I||!U)return this.observer.emit(F.Events.ERROR,F.Events.ERROR,{type:O.ErrorTypes.MEDIA_ERROR,details:O.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),m.executeEnd=S(),[n(i)];var b=I.flush(g);return u(b)?b.then(function(B){return o.flushRemux(T,B,i),T}):(this.flushRemux(T,b,i),T)},e.flushRemux=function(i,o,m){var L=o.audioTrack,P=o.videoTrack,y=o.id3Track,T=o.textTrack,g=this.currentTransmuxState,x=g.accurateTimeOffset,I=g.timeOffset;s.logger.log("[transmuxer.ts]: Flushed fragment "+m.sn+(m.part>-1?" p: "+m.part:"")+" of level "+m.level);var U=this.remuxer.remux(L,P,y,T,I,x,!0,this.id);i.push({remuxResult:U,chunkMeta:m}),m.transmuxing.executeEnd=S()},e.resetInitialTimestamp=function(i){var o=this.demuxer,m=this.remuxer;!o||!m||(o.resetTimeStamp(i),m.resetTimeStamp(i))},e.resetContiguity=function(){var i=this.demuxer,o=this.remuxer;!i||!o||(i.resetContiguity(),o.resetNextTimestamp())},e.resetInitSegment=function(i,o,m,L){var P=this.demuxer,y=this.remuxer;!P||!y||(P.resetInitSegment(i,o,m,L),y.resetInitSegment(i,o,m))},e.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},e.transmux=function(i,o,m,L,P){var y;return o&&o.method==="SAMPLE-AES"?y=this.transmuxSampleAes(i,o,m,L,P):y=this.transmuxUnencrypted(i,m,L,P),y},e.transmuxUnencrypted=function(i,o,m,L){var P=this.demuxer.demux(i,o,!1,!this.config.progressive),y=P.audioTrack,T=P.videoTrack,g=P.id3Track,x=P.textTrack,I=this.remuxer.remux(y,T,g,x,o,m,!1,this.id);return{remuxResult:I,chunkMeta:L}},e.transmuxSampleAes=function(i,o,m,L,P){var y=this;return this.demuxer.demuxSampleAes(i,o,m).then(function(T){var g=y.remuxer.remux(T.audioTrack,T.videoTrack,T.id3Track,T.textTrack,m,L,!1,y.id);return{remuxResult:g,chunkMeta:P}})},e.configureTransmuxer=function(i,o){for(var m=this.config,L=this.observer,P=this.typeSupported,y=this.vendor,T=o.audioCodec,g=o.defaultInitPts,x=o.duration,I=o.initSegmentData,U=o.videoCodec,b,B=0,_=v.length;B<_;B++)if(v[B].demux.probe(i)){b=v[B];break}b||(s.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),b={demux:R.default,remux:l.default});var k=this.demuxer,N=this.remuxer,K=b.remux,W=b.demux;(!N||!(N instanceof K))&&(this.remuxer=new K(L,m,P,y)),(!k||!(k instanceof W))&&(this.demuxer=new W(L,m,P),this.probe=W.probe),this.resetInitSegment(I,T,U,x),this.resetInitialTimestamp(g)},e.needsProbing=function(i,o,m){return!this.demuxer||!this.remuxer||o||m},e.getDecrypter=function(){var i=this.decrypter;return i||(i=this.decrypter=new D.default(this.observer,this.config)),i},r}();function d(r,e){var t=null;return r.byteLength>0&&e!=null&&e.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}var n=function(e){return{remuxResult:{},chunkMeta:e}};function u(r){return"then"in r&&r.then instanceof Function}var f=function(e,t,i,o,m){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=o,this.defaultInitPts=m},E=function(e,t,i,o,m,L){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=o,this.timeOffset=m,this.initSegmentChange=L}},"./src/demux/tsdemuxer.ts":function(w,C,h){h.r(C),h.d(C,"discardEPB",function(){return f});var F=h("./src/demux/adts.ts"),O=h("./src/demux/mpegaudio.ts"),D=h("./src/demux/exp-golomb.ts"),M=h("./src/demux/sample-aes.ts"),R=h("./src/events.ts"),A=h("./src/utils/mp4-tools.ts"),c=h("./src/utils/logger.ts"),a=h("./src/errors.ts"),l=h("./src/types/demuxer.ts");function s(){return s=Object.assign?Object.assign.bind():function(E){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(E[t]=e[t])}return E},s.apply(this,arguments)}var S=function(){function E(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=i}E.probe=function(t){return t[0]===71&&t[188]===71},E.createTrack=function(t,i){return{container:t==="video"||t==="audio"?"video/mp2t":void 0,type:t,id:A.RemuxerTrackIdConfig[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:t==="audio"?i:void 0}};var r=E.prototype;return r.resetInitSegment=function(t,i,o,m){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=E.createTrack("video"),this._audioTrack=E.createTrack("audio",m),this._id3Track=E.createTrack("id3"),this._txtTrack=E.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=i,this.videoCodec=o,this._duration=m},r.resetTimeStamp=function(){},r.resetContiguity=function(){var t=this._audioTrack,i=this._avcTrack,o=this._id3Track;t&&(t.pesData=null),i&&(i.pesData=null),o&&(o.pesData=null),this.aacOverFlow=null},r.demux=function(t,i,o,m){o===void 0&&(o=!1),m===void 0&&(m=!1),o||(this.sampleAes=null);var L,P=this._avcTrack,y=this._audioTrack,T=this._id3Track,g=this._txtTrack,x=P.pid,I=P.pesData,U=y.pid,b=T.pid,B=y.pesData,_=T.pesData,k=null,N=this.pmtParsed,K=this._pmtId,W=t.length;if(this.remainderData&&(t=Object(A.appendUint8Array)(this.remainderData,t),W=t.length,this.remainderData=null),W<188&&!m)return this.remainderData=t,{audioTrack:y,videoTrack:P,id3Track:T,textTrack:g};W-=W%188,W<t.byteLength&&!m&&(this.remainderData=new Uint8Array(t.buffer,W,t.buffer.byteLength-W));for(var j=0,H=0;H<W;H+=188)if(t[H]===71){var Y=!!(t[H+1]&64),Z=((t[H+1]&31)<<8)+t[H+2],$=(t[H+3]&48)>>4,V=void 0;if($>1){if(V=H+5+t[H+4],V===H+188)continue}else V=H+4;switch(Z){case x:Y&&(I&&(L=n(I))&&this.parseAVCPES(P,g,L,!1),I={data:[],size:0}),I&&(I.data.push(t.subarray(V,H+188)),I.size+=H+188-V);break;case U:if(Y){if(B&&(L=n(B)))switch(y.segmentCodec){case"aac":this.parseAACPES(y,L);break;case"mp3":this.parseMPEGPES(y,L);break}B={data:[],size:0}}B&&(B.data.push(t.subarray(V,H+188)),B.size+=H+188-V);break;case b:Y&&(_&&(L=n(_))&&this.parseID3PES(T,L),_={data:[],size:0}),_&&(_.data.push(t.subarray(V,H+188)),_.size+=H+188-V);break;case 0:Y&&(V+=t[V]+1),K=this._pmtId=p(t,V);break;case K:{Y&&(V+=t[V]+1);var Q=d(t,V,this.typeSupported,o);x=Q.avc,x>0&&(P.pid=x),U=Q.audio,U>0&&(y.pid=U,y.segmentCodec=Q.segmentCodec),b=Q.id3,b>0&&(T.pid=b),k!==null&&!N&&(c.logger.log("unknown PID '"+k+"' in TS found"),k=null),N=this.pmtParsed=!0;break}case 17:case 8191:break;default:k=Z;break}}else j++;j>0&&this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:a.ErrorTypes.MEDIA_ERROR,details:a.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+j+" TS packet/s that do not start with 0x47"}),P.pesData=I,y.pesData=B,T.pesData=_;var z={audioTrack:y,videoTrack:P,id3Track:T,textTrack:g};return m&&this.extractRemainingSamples(z),z},r.flush=function(){var t=this.remainderData;this.remainderData=null;var i;return t?i=this.demux(t,-1,!1,!0):i={videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(i),this.sampleAes?this.decrypt(i,this.sampleAes):i},r.extractRemainingSamples=function(t){var i=t.audioTrack,o=t.videoTrack,m=t.id3Track,L=t.textTrack,P=o.pesData,y=i.pesData,T=m.pesData,g;if(P&&(g=n(P))?(this.parseAVCPES(o,L,g,!0),o.pesData=null):o.pesData=P,y&&(g=n(y))){switch(i.segmentCodec){case"aac":this.parseAACPES(i,g);break;case"mp3":this.parseMPEGPES(i,g);break}i.pesData=null}else y!=null&&y.size&&c.logger.log("last AAC PES packet truncated,might overlap between fragments"),i.pesData=y;T&&(g=n(T))?(this.parseID3PES(m,g),m.pesData=null):m.pesData=T},r.demuxSampleAes=function(t,i,o){var m=this.demux(t,o,!0,!this.config.progressive),L=this.sampleAes=new M.default(this.observer,this.config,i);return this.decrypt(m,L)},r.decrypt=function(t,i){return new Promise(function(o){var m=t.audioTrack,L=t.videoTrack;m.samples&&m.segmentCodec==="aac"?i.decryptAacSamples(m.samples,0,function(){L.samples?i.decryptAvcSamples(L.samples,0,0,function(){o(t)}):o(t)}):L.samples&&i.decryptAvcSamples(L.samples,0,0,function(){o(t)})})},r.destroy=function(){this._duration=0},r.parseAVCPES=function(t,i,o,m){var L=this,P=this.parseAVCNALu(t,o.data),y=this.avcSample,T,g=!1;o.data=null,y&&P.length&&!t.audFound&&(u(y,t),y=this.avcSample=v(!1,o.pts,o.dts,"")),P.forEach(function(x){switch(x.type){case 1:{T=!0,y||(y=L.avcSample=v(!0,o.pts,o.dts,"")),y.frame=!0;var I=x.data;if(g&&I.length>4){var U=new D.default(I).readSliceType();(U===2||U===4||U===7||U===9)&&(y.key=!0)}break}case 5:T=!0,y||(y=L.avcSample=v(!0,o.pts,o.dts,"")),y.key=!0,y.frame=!0;break;case 6:{T=!0,Object(A.parseSEIMessageFromNALu)(f(x.data),o.pts,i.samples);break}case 7:if(T=!0,g=!0,!t.sps){var b=new D.default(x.data),B=b.readSPS();t.width=B.width,t.height=B.height,t.pixelRatio=B.pixelRatio,t.sps=[x.data],t.duration=L._duration;for(var _=x.data.subarray(1,4),k="avc1.",N=0;N<3;N++){var K=_[N].toString(16);K.length<2&&(K="0"+K),k+=K}t.codec=k}break;case 8:T=!0,t.pps||(t.pps=[x.data]);break;case 9:T=!1,t.audFound=!0,y&&u(y,t),y=L.avcSample=v(!1,o.pts,o.dts,"");break;case 12:T=!0;break;default:T=!1,y&&(y.debug+="unknown NAL "+x.type+" ");break}if(y&&T){var W=y.units;W.push(x)}}),m&&y&&(u(y,t),this.avcSample=null)},r.getLastNalUnit=function(t){var i,o=this.avcSample,m;if((!o||o.units.length===0)&&(o=t[t.length-1]),(i=o)!==null&&i!==void 0&&i.units){var L=o.units;m=L[L.length-1]}return m},r.parseAVCNALu=function(t,i){var o=i.byteLength,m=t.naluState||0,L=m,P=[],y=0,T,g,x,I=-1,U=0;for(m===-1&&(I=0,U=i[0]&31,m=0,y=1);y<o;){if(T=i[y++],!m){m=T?0:1;continue}if(m===1){m=T?0:2;continue}if(!T)m=3;else if(T===1){if(I>=0){var b={data:i.subarray(I,y-m-1),type:U};P.push(b)}else{var B=this.getLastNalUnit(t.samples);if(B&&(L&&y<=4-L&&B.state&&(B.data=B.data.subarray(0,B.data.byteLength-L)),g=y-m-1,g>0)){var _=new Uint8Array(B.data.byteLength+g);_.set(B.data,0),_.set(i.subarray(0,g),B.data.byteLength),B.data=_,B.state=0}}y<o?(x=i[y]&31,I=y,U=x,m=0):m=-1}else m=0}if(I>=0&&m>=0){var k={data:i.subarray(I,o),type:U,state:m};P.push(k)}if(P.length===0){var N=this.getLastNalUnit(t.samples);if(N){var K=new Uint8Array(N.data.byteLength+i.byteLength);K.set(N.data,0),K.set(i,N.data.byteLength),N.data=K}}return t.naluState=m,P},r.parseAACPES=function(t,i){var o=0,m=this.aacOverFlow,L=i.data;if(m){this.aacOverFlow=null;var P=m.missing,y=m.sample.unit.byteLength;if(P===-1){var T=new Uint8Array(y+L.byteLength);T.set(m.sample.unit,0),T.set(L,y),L=T}else{var g=y-P;m.sample.unit.set(L.subarray(0,P),g),t.samples.push(m.sample),o=m.missing}}var x,I;for(x=o,I=L.length;x<I-1&&!F.isHeader(L,x);x++);if(x!==o){var U,b;if(x<I-1?(U="AAC PES did not start with ADTS header,offset:"+x,b=!1):(U="no ADTS header found in AAC PES",b=!0),c.logger.warn("parsing error:"+U),this.observer.emit(R.Events.ERROR,R.Events.ERROR,{type:a.ErrorTypes.MEDIA_ERROR,details:a.ErrorDetails.FRAG_PARSING_ERROR,fatal:b,reason:U}),b)return}F.initTrackConfig(t,this.observer,L,x,this.audioCodec);var B;if(i.pts!==void 0)B=i.pts;else if(m){var _=F.getFrameDuration(t.samplerate);B=m.sample.pts+_}else{c.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var k=0,N;x<I;)if(N=F.appendFrame(t,L,x,B,k),x+=N.length,N.missing){this.aacOverFlow=N;break}else for(k++;x<I-1&&!F.isHeader(L,x);x++);},r.parseMPEGPES=function(t,i){var o=i.data,m=o.length,L=0,P=0,y=i.pts;if(y===void 0){c.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;P<m;)if(O.isHeader(o,P)){var T=O.appendFrame(t,o,P,y,L);if(T)P+=T.length,L++;else break}else P++},r.parseID3PES=function(t,i){if(i.pts===void 0){c.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var o=s({},i,{type:this._avcTrack?l.MetadataSchema.emsg:l.MetadataSchema.audioId3});t.samples.push(o)},E}();function v(E,r,e,t){return{key:E,frame:!1,pts:r,dts:e,units:[],debug:t,length:0}}function p(E,r){return(E[r+10]&31)<<8|E[r+11]}function d(E,r,e,t){var i={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},o=(E[r+1]&15)<<8|E[r+2],m=r+3+o-4,L=(E[r+10]&15)<<8|E[r+11];for(r+=12+L;r<m;){var P=(E[r+1]&31)<<8|E[r+2];switch(E[r]){case 207:if(!t){c.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:i.audio===-1&&(i.audio=P);break;case 21:i.id3===-1&&(i.id3=P);break;case 219:if(!t){c.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:i.avc===-1&&(i.avc=P);break;case 3:case 4:e.mpeg!==!0&&e.mp3!==!0?c.logger.log("MPEG audio found, not supported in this browser"):i.audio===-1&&(i.audio=P,i.segmentCodec="mp3");break;case 36:c.logger.warn("Unsupported HEVC stream type found");break}r+=((E[r+3]&15)<<8|E[r+4])+5}return i}function n(E){var r=0,e,t,i,o,m,L=E.data;if(!E||E.size===0)return null;for(;L[0].length<19&&L.length>1;){var P=new Uint8Array(L[0].length+L[1].length);P.set(L[0]),P.set(L[1],L[0].length),L[0]=P,L.splice(1,1)}e=L[0];var y=(e[0]<<16)+(e[1]<<8)+e[2];if(y===1){if(t=(e[4]<<8)+e[5],t&&t>E.size-6)return null;var T=e[7];T&192&&(o=(e[9]&14)*536870912+(e[10]&255)*4194304+(e[11]&254)*16384+(e[12]&255)*128+(e[13]&254)/2,T&64?(m=(e[14]&14)*536870912+(e[15]&255)*4194304+(e[16]&254)*16384+(e[17]&255)*128+(e[18]&254)/2,o-m>60*9e4&&(c.logger.warn(Math.round((o-m)/9e4)+"s delta between PTS and DTS, align them"),o=m)):m=o),i=e[8];var g=i+9;if(E.size<=g)return null;E.size-=g;for(var x=new Uint8Array(E.size),I=0,U=L.length;I<U;I++){e=L[I];var b=e.byteLength;if(g)if(g>b){g-=b;continue}else e=e.subarray(g),b-=g,g=0;x.set(e,r),r+=b}return t&&(t-=i+3),{data:x,pts:o,dts:m,len:t}}return null}function u(E,r){if(E.units.length&&E.frame){if(E.pts===void 0){var e=r.samples,t=e.length;if(t){var i=e[t-1];E.pts=i.pts,E.dts=i.dts}else{r.dropped++;return}}r.samples.push(E)}E.debug.length&&c.logger.log(E.pts+"/"+E.dts+":"+E.debug)}function f(E){for(var r=E.byteLength,e=[],t=1;t<r-2;)E[t]===0&&E[t+1]===0&&E[t+2]===3?(e.push(t+2),t+=2):t++;if(e.length===0)return E;var i=r-e.length,o=new Uint8Array(i),m=0;for(t=0;t<i;m++,t++)m===e[0]&&(m++,e.shift()),o[t]=E[m];return o}C.default=S},"./src/empty.js":function(w,C){w.exports=void 0},"./src/errors.ts":function(w,C,h){h.r(C),h.d(C,"ErrorTypes",function(){return F}),h.d(C,"ErrorDetails",function(){return O});var F;(function(D){D.NETWORK_ERROR="networkError",D.MEDIA_ERROR="mediaError",D.KEY_SYSTEM_ERROR="keySystemError",D.MUX_ERROR="muxError",D.OTHER_ERROR="otherError"})(F||(F={}));var O;(function(D){D.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",D.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",D.KEY_SYSTEM_NO_SESSION="keySystemNoSession",D.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",D.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",D.MANIFEST_LOAD_ERROR="manifestLoadError",D.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",D.MANIFEST_PARSING_ERROR="manifestParsingError",D.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",D.LEVEL_EMPTY_ERROR="levelEmptyError",D.LEVEL_LOAD_ERROR="levelLoadError",D.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",D.LEVEL_SWITCH_ERROR="levelSwitchError",D.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",D.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",D.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",D.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",D.FRAG_LOAD_ERROR="fragLoadError",D.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",D.FRAG_DECRYPT_ERROR="fragDecryptError",D.FRAG_PARSING_ERROR="fragParsingError",D.REMUX_ALLOC_ERROR="remuxAllocError",D.KEY_LOAD_ERROR="keyLoadError",D.KEY_LOAD_TIMEOUT="keyLoadTimeOut",D.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",D.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",D.BUFFER_APPEND_ERROR="bufferAppendError",D.BUFFER_APPENDING_ERROR="bufferAppendingError",D.BUFFER_STALLED_ERROR="bufferStalledError",D.BUFFER_FULL_ERROR="bufferFullError",D.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",D.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",D.INTERNAL_EXCEPTION="internalException",D.INTERNAL_ABORTED="aborted",D.UNKNOWN="unknown"})(O||(O={}))},"./src/events.ts":function(w,C,h){h.r(C),h.d(C,"Events",function(){return F});var F;(function(O){O.MEDIA_ATTACHING="hlsMediaAttaching",O.MEDIA_ATTACHED="hlsMediaAttached",O.MEDIA_DETACHING="hlsMediaDetaching",O.MEDIA_DETACHED="hlsMediaDetached",O.BUFFER_RESET="hlsBufferReset",O.BUFFER_CODECS="hlsBufferCodecs",O.BUFFER_CREATED="hlsBufferCreated",O.BUFFER_APPENDING="hlsBufferAppending",O.BUFFER_APPENDED="hlsBufferAppended",O.BUFFER_EOS="hlsBufferEos",O.BUFFER_FLUSHING="hlsBufferFlushing",O.BUFFER_FLUSHED="hlsBufferFlushed",O.MANIFEST_LOADING="hlsManifestLoading",O.MANIFEST_LOADED="hlsManifestLoaded",O.MANIFEST_PARSED="hlsManifestParsed",O.LEVEL_SWITCHING="hlsLevelSwitching",O.LEVEL_SWITCHED="hlsLevelSwitched",O.LEVEL_LOADING="hlsLevelLoading",O.LEVEL_LOADED="hlsLevelLoaded",O.LEVEL_UPDATED="hlsLevelUpdated",O.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",O.LEVELS_UPDATED="hlsLevelsUpdated",O.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",O.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",O.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",O.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",O.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",O.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",O.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",O.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",O.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",O.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",O.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",O.CUES_PARSED="hlsCuesParsed",O.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",O.INIT_PTS_FOUND="hlsInitPtsFound",O.FRAG_LOADING="hlsFragLoading",O.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",O.FRAG_LOADED="hlsFragLoaded",O.FRAG_DECRYPTED="hlsFragDecrypted",O.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",O.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",O.FRAG_PARSING_METADATA="hlsFragParsingMetadata",O.FRAG_PARSED="hlsFragParsed",O.FRAG_BUFFERED="hlsFragBuffered",O.FRAG_CHANGED="hlsFragChanged",O.FPS_DROP="hlsFpsDrop",O.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",O.ERROR="hlsError",O.DESTROYING="hlsDestroying",O.KEY_LOADING="hlsKeyLoading",O.KEY_LOADED="hlsKeyLoaded",O.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",O.BACK_BUFFER_REACHED="hlsBackBufferReached"})(F||(F={}))},"./src/hls.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return f});var F=h("./node_modules/url-toolkit/src/url-toolkit.js"),O=h("./src/loader/playlist-loader.ts"),D=h("./src/loader/key-loader.ts"),M=h("./src/controller/id3-track-controller.ts"),R=h("./src/controller/latency-controller.ts"),A=h("./src/controller/level-controller.ts"),c=h("./src/controller/fragment-tracker.ts"),a=h("./src/controller/stream-controller.ts"),l=h("./src/is-supported.ts"),s=h("./src/utils/logger.ts"),S=h("./src/config.ts"),v=h("./node_modules/eventemitter3/index.js"),p=h("./src/events.ts"),d=h("./src/errors.ts");function n(E,r){for(var e=0;e<r.length;e++){var t=r[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(E,t.key,t)}}function u(E,r,e){return r&&n(E.prototype,r),e&&n(E,e),Object.defineProperty(E,"prototype",{writable:!1}),E}var f=function(){E.isSupported=function(){return Object(l.isSupported)()};function E(e){e===void 0&&(e={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new v.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var t=this.config=Object(S.mergeConfig)(E.DefaultConfig,e);this.userConfig=e,Object(s.enableLogs)(t.debug),this._autoLevelCapping=-1,t.progressive&&Object(S.enableStreamingMode)(t);var i=t.abrController,o=t.bufferController,m=t.capLevelController,L=t.fpsController,P=this.abrController=new i(this),y=this.bufferController=new o(this),T=this.capLevelController=new m(this),g=new L(this),x=new O.default(this),I=new D.default(this),U=new M.default(this),b=this.levelController=new A.default(this),B=new c.FragmentTracker(this),_=this.streamController=new a.default(this,B);T.setStreamController(_),g.setStreamController(_);var k=[x,I,b,_];this.networkControllers=k;var N=[P,y,T,g,U,B];this.audioTrackController=this.createController(t.audioTrackController,null,k),this.createController(t.audioStreamController,B,k),this.subtitleTrackController=this.createController(t.subtitleTrackController,null,k),this.createController(t.subtitleStreamController,B,k),this.createController(t.timelineController,null,N),this.emeController=this.createController(t.emeController,null,N),this.cmcdController=this.createController(t.cmcdController,null,N),this.latencyController=this.createController(R.default,null,N),this.coreComponents=N}var r=E.prototype;return r.createController=function(t,i,o){if(t){var m=i?new t(this,i):new t(this);return o&&o.push(m),m}return null},r.on=function(t,i,o){o===void 0&&(o=this),this._emitter.on(t,i,o)},r.once=function(t,i,o){o===void 0&&(o=this),this._emitter.once(t,i,o)},r.removeAllListeners=function(t){this._emitter.removeAllListeners(t)},r.off=function(t,i,o,m){o===void 0&&(o=this),this._emitter.off(t,i,o,m)},r.listeners=function(t){return this._emitter.listeners(t)},r.emit=function(t,i,o){return this._emitter.emit(t,i,o)},r.trigger=function(t,i){if(this.config.debug)return this.emit(t,t,i);try{return this.emit(t,t,i)}catch(o){s.logger.error("An internal error happened while handling event "+t+'. Error message: "'+o.message+'". Here is a stacktrace:',o),this.trigger(p.Events.ERROR,{type:d.ErrorTypes.OTHER_ERROR,details:d.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:t,error:o})}return!1},r.listenerCount=function(t){return this._emitter.listenerCount(t)},r.destroy=function(){s.logger.log("destroy"),this.trigger(p.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(t){return t.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(t){return t.destroy()}),this.coreComponents.length=0},r.attachMedia=function(t){s.logger.log("attachMedia"),this._media=t,this.trigger(p.Events.MEDIA_ATTACHING,{media:t})},r.detachMedia=function(){s.logger.log("detachMedia"),this.trigger(p.Events.MEDIA_DETACHING,void 0),this._media=null},r.loadSource=function(t){this.stopLoad();var i=this.media,o=this.url,m=this.url=F.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});s.logger.log("loadSource:"+m),i&&o&&o!==m&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(i)),this.trigger(p.Events.MANIFEST_LOADING,{url:t})},r.startLoad=function(t){t===void 0&&(t=-1),s.logger.log("startLoad("+t+")"),this.networkControllers.forEach(function(i){i.startLoad(t)})},r.stopLoad=function(){s.logger.log("stopLoad"),this.networkControllers.forEach(function(t){t.stopLoad()})},r.swapAudioCodec=function(){s.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},r.recoverMediaError=function(){s.logger.log("recoverMediaError");var t=this._media;this.detachMedia(),t&&this.attachMedia(t)},r.removeLevel=function(t,i){i===void 0&&(i=0),this.levelController.removeLevel(t,i)},u(E,[{key:"levels",get:function(){var t=this.levelController.levels;return t||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(t){s.logger.log("set currentLevel:"+t),this.loadLevel=t,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(t){s.logger.log("set nextLevel:"+t),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(t){s.logger.log("set loadLevel:"+t),this.levelController.manualLevel=t}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(t){this.levelController.nextLoadLevel=t}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(t){s.logger.log("set firstLevel:"+t),this.levelController.firstLevel=t}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(t){s.logger.log("set startLevel:"+t),t!==-1&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(t){var i=!!t;i!==this.config.capLevelToPlayerSize&&(i?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=i)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(t){this._autoLevelCapping!==t&&(s.logger.log("set autoLevelCapping:"+t),this._autoLevelCapping=t)}},{key:"bandwidthEstimate",get:function(){var t=this.abrController.bwEstimator;return t?t.getEstimate():NaN}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var t=this.levels,i=this.config.minAutoBitrate;if(!t)return 0;for(var o=t.length,m=0;m<o;m++)if(t[m].maxBitrate>=i)return m;return 0}},{key:"maxAutoLevel",get:function(){var t=this.levels,i=this.autoLevelCapping,o;return i===-1&&t&&t.length?o=t.length-1:o=i,o}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(t){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,t)}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"audioTracks",get:function(){var t=this.audioTrackController;return t?t.audioTracks:[]}},{key:"audioTrack",get:function(){var t=this.audioTrackController;return t?t.audioTrack:-1},set:function(t){var i=this.audioTrackController;i&&(i.audioTrack=t)}},{key:"subtitleTracks",get:function(){var t=this.subtitleTrackController;return t?t.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var t=this.subtitleTrackController;return t?t.subtitleTrack:-1},set:function(t){var i=this.subtitleTrackController;i&&(i.subtitleTrack=t)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var t=this.subtitleTrackController;return t?t.subtitleDisplay:!1},set:function(t){var i=this.subtitleTrackController;i&&(i.subtitleDisplay=t)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(t){this.config.lowLatencyMode=t}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.2.3"}},{key:"Events",get:function(){return p.Events}},{key:"ErrorTypes",get:function(){return d.ErrorTypes}},{key:"ErrorDetails",get:function(){return d.ErrorDetails}},{key:"DefaultConfig",get:function(){return E.defaultConfig?E.defaultConfig:S.hlsDefaultConfig},set:function(t){E.defaultConfig=t}}]),E}();f.defaultConfig=void 0},"./src/is-supported.ts":function(w,C,h){h.r(C),h.d(C,"isSupported",function(){return D}),h.d(C,"changeTypeSupported",function(){return M});var F=h("./src/utils/mediasource-helper.ts");function O(){return self.SourceBuffer||self.WebKitSourceBuffer}function D(){var R=Object(F.getMediaSource)();if(!R)return!1;var A=O(),c=R&&typeof R.isTypeSupported=="function"&&R.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),a=!A||A.prototype&&typeof A.prototype.appendBuffer=="function"&&typeof A.prototype.remove=="function";return!!c&&!!a}function M(){var R,A=O();return typeof(A==null||(R=A.prototype)===null||R===void 0?void 0:R.changeType)=="function"}},"./src/loader/date-range.ts":function(w,C,h){h.r(C),h.d(C,"DateRangeAttribute",function(){return c}),h.d(C,"DateRange",function(){return a});var F=h("./src/polyfills/number.ts"),O=h("./src/utils/attr-list.ts"),D=h("./src/utils/logger.ts");function M(){return M=Object.assign?Object.assign.bind():function(l){for(var s=1;s<arguments.length;s++){var S=arguments[s];for(var v in S)Object.prototype.hasOwnProperty.call(S,v)&&(l[v]=S[v])}return l},M.apply(this,arguments)}function R(l,s){for(var S=0;S<s.length;S++){var v=s[S];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(l,v.key,v)}}function A(l,s,S){return s&&R(l.prototype,s),S&&R(l,S),Object.defineProperty(l,"prototype",{writable:!1}),l}var c;(function(l){l.ID="ID",l.CLASS="CLASS",l.START_DATE="START-DATE",l.DURATION="DURATION",l.END_DATE="END-DATE",l.END_ON_NEXT="END-ON-NEXT",l.PLANNED_DURATION="PLANNED-DURATION",l.SCTE35_OUT="SCTE35-OUT",l.SCTE35_IN="SCTE35-IN"})(c||(c={}));var a=function(){function l(s,S){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,S){var v=S.attr;for(var p in v)if(Object.prototype.hasOwnProperty.call(s,p)&&s[p]!==v[p]){D.logger.warn('DATERANGE tag attribute: "'+p+'" does not match for tags with ID: "'+s.ID+'"'),this._badValueForSameId=p;break}s=M(new O.AttrList({}),v,s)}if(this.attr=s,this._startDate=new Date(s[c.START_DATE]),c.END_DATE in this.attr){var d=new Date(this.attr[c.END_DATE]);Object(F.isFiniteNumber)(d.getTime())&&(this._endDate=d)}}return A(l,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var S=this.duration;return S!==null?new Date(this._startDate.getTime()+S*1e3):null}},{key:"duration",get:function(){if(c.DURATION in this.attr){var S=this.attr.decimalFloatingPoint(c.DURATION);if(Object(F.isFiniteNumber)(S))return S}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return c.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(c.PLANNED_DURATION):null}},{key:"endOnNext",get:function(){return this.attr.bool(c.END_ON_NEXT)}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&Object(F.isFiniteNumber)(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}]),l}()},"./src/loader/fragment-loader.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return S}),h.d(C,"LoadError",function(){return p});var F=h("./src/polyfills/number.ts"),O=h("./src/errors.ts");function D(d,n){d.prototype=Object.create(n.prototype),d.prototype.constructor=d,a(d,n)}function M(d){var n=typeof Map=="function"?new Map:void 0;return M=function(f){if(f===null||!c(f))return f;if(typeof f!="function")throw new TypeError("Super expression must either be null or a function");if(typeof n!="undefined"){if(n.has(f))return n.get(f);n.set(f,E)}function E(){return R(f,arguments,l(this).constructor)}return E.prototype=Object.create(f.prototype,{constructor:{value:E,enumerable:!1,writable:!0,configurable:!0}}),a(E,f)},M(d)}function R(d,n,u){return A()?R=Reflect.construct.bind():R=function(E,r,e){var t=[null];t.push.apply(t,r);var i=Function.bind.apply(E,t),o=new i;return e&&a(o,e.prototype),o},R.apply(null,arguments)}function A(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function c(d){return Function.toString.call(d).indexOf("[native code]")!==-1}function a(d,n){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(f,E){return f.__proto__=E,f},a(d,n)}function l(d){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(u){return u.__proto__||Object.getPrototypeOf(u)},l(d)}var s=Math.pow(2,17),S=function(){function d(u){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=u}var n=d.prototype;return n.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},n.abort=function(){this.loader&&this.loader.abort()},n.load=function(f,E){var r=this,e=f.url;if(!e)return Promise.reject(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:f,networkDetails:null},"Fragment does not have a "+(e?"part list":"url")));this.abort();var t=this.config,i=t.fLoader,o=t.loader;return new Promise(function(m,L){r.loader&&r.loader.destroy();var P=r.loader=f.loader=i?new i(t):new o(t),y=v(f),T={timeout:t.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:t.fragLoadingMaxRetryTimeout,highWaterMark:f.sn==="initSegment"?1/0:s};f.stats=P.stats,P.load(y,T,{onSuccess:function(x,I,U,b){r.resetLoader(f,P),m({frag:f,part:null,payload:x.data,networkDetails:b})},onError:function(x,I,U){r.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:f,response:x,networkDetails:U}))},onAbort:function(x,I,U){r.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:f,networkDetails:U}))},onTimeout:function(x,I,U){r.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:f,networkDetails:U}))},onProgress:function(x,I,U,b){E&&E({frag:f,part:null,payload:U,networkDetails:b})}})})},n.loadPart=function(f,E,r){var e=this;this.abort();var t=this.config,i=t.fLoader,o=t.loader;return new Promise(function(m,L){e.loader&&e.loader.destroy();var P=e.loader=f.loader=i?new i(t):new o(t),y=v(f,E),T={timeout:t.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:t.fragLoadingMaxRetryTimeout,highWaterMark:s};E.stats=P.stats,P.load(y,T,{onSuccess:function(x,I,U,b){e.resetLoader(f,P),e.updateStatsFromPart(f,E);var B={frag:f,part:E,payload:x.data,networkDetails:b};r(B),m(B)},onError:function(x,I,U){e.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:f,part:E,response:x,networkDetails:U}))},onAbort:function(x,I,U){f.stats.aborted=E.stats.aborted,e.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:f,part:E,networkDetails:U}))},onTimeout:function(x,I,U){e.resetLoader(f,P),L(new p({type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:f,part:E,networkDetails:U}))}})})},n.updateStatsFromPart=function(f,E){var r=f.stats,e=E.stats,t=e.total;if(r.loaded+=e.loaded,t){var i=Math.round(f.duration/E.duration),o=Math.min(Math.round(r.loaded/t),i),m=i-o,L=m*Math.round(r.loaded/o);r.total=r.loaded+L}else r.total=Math.max(r.loaded,r.total);var P=r.loading,y=e.loading;P.start?P.first+=y.first-y.start:(P.start=y.start,P.first=y.first),P.end=y.end},n.resetLoader=function(f,E){f.loader=null,this.loader===E&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),E.destroy()},d}();function v(d,n){n===void 0&&(n=null);var u=n||d,f={frag:d,part:n,responseType:"arraybuffer",url:u.url,headers:{},rangeStart:0,rangeEnd:0},E=u.byteRangeStartOffset,r=u.byteRangeEndOffset;return Object(F.isFiniteNumber)(E)&&Object(F.isFiniteNumber)(r)&&(f.rangeStart=E,f.rangeEnd=r),f}var p=function(d){D(n,d);function n(u){for(var f,E=arguments.length,r=new Array(E>1?E-1:0),e=1;e<E;e++)r[e-1]=arguments[e];return f=d.call.apply(d,[this].concat(r))||this,f.data=void 0,f.data=u,f}return n}(M(Error))},"./src/loader/fragment.ts":function(w,C,h){h.r(C),h.d(C,"ElementaryStreamTypes",function(){return s}),h.d(C,"BaseSegment",function(){return S}),h.d(C,"Fragment",function(){return v}),h.d(C,"Part",function(){return p});var F=h("./src/polyfills/number.ts"),O=h("./node_modules/url-toolkit/src/url-toolkit.js"),D=h("./src/utils/logger.ts"),M=h("./src/loader/level-key.ts"),R=h("./src/loader/load-stats.ts");function A(d,n){d.prototype=Object.create(n.prototype),d.prototype.constructor=d,c(d,n)}function c(d,n){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(f,E){return f.__proto__=E,f},c(d,n)}function a(d,n){for(var u=0;u<n.length;u++){var f=n[u];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(d,f.key,f)}}function l(d,n,u){return n&&a(d.prototype,n),u&&a(d,u),Object.defineProperty(d,"prototype",{writable:!1}),d}var s;(function(d){d.AUDIO="audio",d.VIDEO="video",d.AUDIOVIDEO="audiovideo"})(s||(s={}));var S=function(){function d(u){var f;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(f={},f[s.AUDIO]=null,f[s.VIDEO]=null,f[s.AUDIOVIDEO]=null,f),this.baseurl=u}var n=d.prototype;return n.setByteRange=function(f,E){var r=f.split("@",2),e=[];r.length===1?e[0]=E?E.byteRangeEndOffset:0:e[0]=parseInt(r[1]),e[1]=parseInt(r[0])+e[0],this._byteRange=e},l(d,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Object(O.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(f){this._url=f}}]),d}(),v=function(d){A(n,d);function n(f,E){var r;return r=d.call(this,E)||this,r._decryptdata=null,r.rawProgramDateTime=null,r.programDateTime=null,r.tagList=[],r.duration=0,r.sn=0,r.levelkey=void 0,r.type=void 0,r.loader=null,r.level=-1,r.cc=0,r.startPTS=void 0,r.endPTS=void 0,r.appendedPTS=void 0,r.startDTS=void 0,r.endDTS=void 0,r.start=0,r.deltaPTS=void 0,r.maxStartPTS=void 0,r.minEndPTS=void 0,r.stats=new R.LoadStats,r.urlId=0,r.data=void 0,r.bitrateTest=!1,r.title=null,r.initSegment=null,r.type=f,r}var u=n.prototype;return u.createInitializationVector=function(E){for(var r=new Uint8Array(16),e=12;e<16;e++)r[e]=E>>8*(15-e)&255;return r},u.setDecryptDataFromLevelKey=function(E,r){var e=E;return(E==null?void 0:E.method)==="AES-128"&&E.uri&&!E.iv&&(e=M.LevelKey.fromURI(E.uri),e.method=E.method,e.iv=this.createInitializationVector(r),e.keyFormat="identity"),e},u.setElementaryStreamInfo=function(E,r,e,t,i,o){o===void 0&&(o=!1);var m=this.elementaryStreams,L=m[E];if(!L){m[E]={startPTS:r,endPTS:e,startDTS:t,endDTS:i,partial:o};return}L.startPTS=Math.min(L.startPTS,r),L.endPTS=Math.max(L.endPTS,e),L.startDTS=Math.min(L.startDTS,t),L.endDTS=Math.max(L.endDTS,i)},u.clearElementaryStreamInfo=function(){var E=this.elementaryStreams;E[s.AUDIO]=null,E[s.VIDEO]=null,E[s.AUDIOVIDEO]=null},l(n,[{key:"decryptdata",get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var E=this.sn;typeof E!="number"&&(this.levelkey&&this.levelkey.method==="AES-128"&&!this.levelkey.iv&&D.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),E=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,E)}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!Object(F.isFiniteNumber)(this.programDateTime))return null;var E=Object(F.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+E*1e3}},{key:"encrypted",get:function(){var E;return!!((E=this.decryptdata)!==null&&E!==void 0&&E.keyFormat&&this.decryptdata.uri)}}]),n}(S),p=function(d){A(n,d);function n(u,f,E,r,e){var t;t=d.call(this,E)||this,t.fragOffset=0,t.duration=0,t.gap=!1,t.independent=!1,t.relurl=void 0,t.fragment=void 0,t.index=void 0,t.stats=new R.LoadStats,t.duration=u.decimalFloatingPoint("DURATION"),t.gap=u.bool("GAP"),t.independent=u.bool("INDEPENDENT"),t.relurl=u.enumeratedString("URI"),t.fragment=f,t.index=r;var i=u.enumeratedString("BYTERANGE");return i&&t.setByteRange(i,e),e&&(t.fragOffset=e.fragOffset+e.duration),t}return l(n,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var f=this.elementaryStreams;return!!(f.audio||f.video||f.audiovideo)}}]),n}(S)},"./src/loader/key-loader.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return M});var F=h("./src/events.ts"),O=h("./src/errors.ts"),D=h("./src/utils/logger.ts"),M=function(){function R(c){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=c,this.registerListeners()}var A=R.prototype;return A.startLoad=function(a){},A.stopLoad=function(){this.destroyInternalLoaders()},A.registerListeners=function(){this.hls.on(F.Events.KEY_LOADING,this.onKeyLoading,this)},A.unregisterListeners=function(){this.hls.off(F.Events.KEY_LOADING,this.onKeyLoading)},A.destroyInternalLoaders=function(){for(var a in this.loaders){var l=this.loaders[a];l&&l.destroy()}this.loaders={}},A.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},A.onKeyLoading=function(a,l){var s=l.frag,S=s.type,v=this.loaders[S];if(!s.decryptdata){D.logger.warn("Missing decryption data on fragment in onKeyLoading");return}var p=s.decryptdata.uri;if(p!==this.decrypturl||this.decryptkey===null){var d=this.hls.config;if(v&&(D.logger.warn("abort previous key loader for type:"+S),v.abort()),!p){D.logger.warn("key uri is falsy");return}var n=d.loader,u=s.loader=this.loaders[S]=new n(d);this.decrypturl=p,this.decryptkey=null;var f={url:p,frag:s,responseType:"arraybuffer"},E={timeout:d.fragLoadingTimeOut,maxRetry:0,retryDelay:d.fragLoadingRetryDelay,maxRetryDelay:d.fragLoadingMaxRetryTimeout,highWaterMark:0},r={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};u.load(f,E,r)}else this.decryptkey&&(s.decryptdata.key=this.decryptkey,this.hls.trigger(F.Events.KEY_LOADED,{frag:s}))},A.loadsuccess=function(a,l,s){var S=s.frag;if(!S.decryptdata){D.logger.error("after key load, decryptdata unset");return}this.decryptkey=S.decryptdata.key=new Uint8Array(a.data),S.loader=null,delete this.loaders[S.type],this.hls.trigger(F.Events.KEY_LOADED,{frag:S})},A.loaderror=function(a,l){var s=l.frag,S=s.loader;S&&S.abort(),delete this.loaders[s.type],this.hls.trigger(F.Events.ERROR,{type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:s,response:a})},A.loadtimeout=function(a,l){var s=l.frag,S=s.loader;S&&S.abort(),delete this.loaders[s.type],this.hls.trigger(F.Events.ERROR,{type:O.ErrorTypes.NETWORK_ERROR,details:O.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:s})},R}()},"./src/loader/level-details.ts":function(w,C,h){h.r(C),h.d(C,"LevelDetails",function(){return R});var F=h("./src/polyfills/number.ts");function O(A,c){for(var a=0;a<c.length;a++){var l=c[a];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(A,l.key,l)}}function D(A,c,a){return c&&O(A.prototype,c),a&&O(A,a),Object.defineProperty(A,"prototype",{writable:!1}),A}var M=10,R=function(){function A(a){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.dateRanges={},this.url=a}var c=A.prototype;return c.reloaded=function(l){if(!l){this.advanced=!0,this.updated=!0;return}var s=this.lastPartSn-l.lastPartSn,S=this.lastPartIndex-l.lastPartIndex;this.updated=this.endSN!==l.endSN||!!S||!!s,this.advanced=this.endSN>l.endSN||s>0||s===0&&S>0,this.updated||this.advanced?this.misses=Math.floor(l.misses*.6):this.misses=l.misses+1,this.availabilityDelay=l.availabilityDelay},D(A,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?Object(F.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||M}},{key:"drift",get:function(){var l=this.driftEndTime-this.driftStartTime;if(l>0){var s=this.driftEnd-this.driftStart;return s*1e3/l}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var l;return(l=this.partList)!==null&&l!==void 0&&l.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var l;return(l=this.fragments)!==null&&l!==void 0&&l.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var l;return(l=this.partList)!==null&&l!==void 0&&l.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var l;return(l=this.partList)!==null&&l!==void 0&&l.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),A}()},"./src/loader/level-key.ts":function(w,C,h){h.r(C),h.d(C,"LevelKey",function(){return M});var F=h("./node_modules/url-toolkit/src/url-toolkit.js");function O(R,A){for(var c=0;c<A.length;c++){var a=A[c];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(R,a.key,a)}}function D(R,A,c){return A&&O(R.prototype,A),c&&O(R,c),Object.defineProperty(R,"prototype",{writable:!1}),R}var M=function(){R.fromURL=function(c,a){return new R(c,a)},R.fromURI=function(c){return new R(c)};function R(A,c){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,c?this._uri=Object(F.buildAbsoluteURL)(A,c,{alwaysNormalize:!0}):this._uri=A}return D(R,[{key:"uri",get:function(){return this._uri}}]),R}()},"./src/loader/load-stats.ts":function(w,C,h){h.r(C),h.d(C,"LoadStats",function(){return F});var F=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return u});var F=h("./src/polyfills/number.ts"),O=h("./node_modules/url-toolkit/src/url-toolkit.js"),D=h("./src/loader/date-range.ts"),M=h("./src/loader/fragment.ts"),R=h("./src/loader/level-details.ts"),A=h("./src/loader/level-key.ts"),c=h("./src/utils/attr-list.ts"),a=h("./src/utils/logger.ts"),l=h("./src/utils/codecs.ts"),s=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,S=/#EXT-X-MEDIA:(.*)/g,v=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),p=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),d=/\.(mp4|m4s|m4v|m4a)$/i;function n(i){var o,m;return d.test((o=(m=O.parseURL(i))===null||m===void 0?void 0:m.path)!=null?o:"")}var u=function(){function i(){}return i.findGroup=function(m,L){for(var P=0;P<m.length;P++){var y=m[P];if(y.id===L)return y}},i.convertAVC1ToAVCOTI=function(m){var L=m.split(".");if(L.length>2){var P=L.shift()+".";return P+=parseInt(L.shift()).toString(16),P+=("000"+parseInt(L.shift()).toString(16)).slice(-4),P}return m},i.resolve=function(m,L){return O.buildAbsoluteURL(L,m,{alwaysNormalize:!0})},i.parseMasterPlaylist=function(m,L){var P=[],y={},T=!1;s.lastIndex=0;for(var g;(g=s.exec(m))!=null;)if(g[1]){var x=new c.AttrList(g[1]),I={attrs:x,bitrate:x.decimalInteger("AVERAGE-BANDWIDTH")||x.decimalInteger("BANDWIDTH"),name:x.NAME,url:i.resolve(g[2],L)},U=x.decimalResolution("RESOLUTION");U&&(I.width=U.width,I.height=U.height),f((x.CODECS||"").split(/[ ,]+/).filter(function(B){return B}),I),I.videoCodec&&I.videoCodec.indexOf("avc1")!==-1&&(I.videoCodec=i.convertAVC1ToAVCOTI(I.videoCodec)),P.push(I)}else if(g[3]){var b=new c.AttrList(g[3]);b["DATA-ID"]&&(T=!0,y[b["DATA-ID"]]=b)}return{levels:P,sessionData:T?y:null}},i.parseMasterPlaylistMedia=function(m,L,P,y){y===void 0&&(y=[]);var T,g=[],x=0;for(S.lastIndex=0;(T=S.exec(m))!==null;){var I=new c.AttrList(T[1]);if(I.TYPE===P){var U={attrs:I,bitrate:0,id:x++,groupId:I["GROUP-ID"],instreamId:I["INSTREAM-ID"],name:I.NAME||I.LANGUAGE||"",type:P,default:I.bool("DEFAULT"),autoselect:I.bool("AUTOSELECT"),forced:I.bool("FORCED"),lang:I.LANGUAGE,url:I.URI?i.resolve(I.URI,L):""};if(y.length){var b=i.findGroup(y,U.groupId)||y[0];E(U,b,"audioCodec"),E(U,b,"textCodec")}g.push(U)}}return g},i.parseLevelPlaylist=function(m,L,P,y,T){var g=new R.LevelDetails(L),x=g.fragments,I=null,U=0,b=0,B=0,_=0,k=null,N=new M.Fragment(y,L),K,W,j,H=-1,Y=!1;for(v.lastIndex=0,g.m3u8=m;(K=v.exec(m))!==null;){Y&&(Y=!1,N=new M.Fragment(y,L),N.start=B,N.sn=U,N.cc=_,N.level=P,I&&(N.initSegment=I,N.rawProgramDateTime=I.rawProgramDateTime,I.rawProgramDateTime=null));var Z=K[1];if(Z){N.duration=parseFloat(Z);var $=(" "+K[2]).slice(1);N.title=$||null,N.tagList.push($?["INF",Z,$]:["INF",Z])}else if(K[3])Object(F.isFiniteNumber)(N.duration)&&(N.start=B,j&&(N.levelkey=j),N.sn=U,N.level=P,N.cc=_,N.urlId=T,x.push(N),N.relurl=(" "+K[3]).slice(1),e(N,k),k=N,B+=N.duration,U++,b=0,Y=!0);else if(K[4]){var V=(" "+K[4]).slice(1);k?N.setByteRange(V,k):N.setByteRange(V)}else if(K[5])N.rawProgramDateTime=(" "+K[5]).slice(1),N.tagList.push(["PROGRAM-DATE-TIME",N.rawProgramDateTime]),H===-1&&(H=x.length);else{if(K=K[0].match(p),!K){a.logger.warn("No matches on slow regex match for level playlist!");continue}for(W=1;W<K.length&&typeof K[W]=="undefined";W++);var Q=(" "+K[W]).slice(1),z=(" "+K[W+1]).slice(1),X=K[W+2]?(" "+K[W+2]).slice(1):"";switch(Q){case"PLAYLIST-TYPE":g.type=z.toUpperCase();break;case"MEDIA-SEQUENCE":U=g.startSN=parseInt(z);break;case"SKIP":{var ee=new c.AttrList(z),J=ee.decimalInteger("SKIPPED-SEGMENTS");if(Object(F.isFiniteNumber)(J)){g.skippedSegments=J;for(var te=J;te--;)x.unshift(null);U+=J}var se=ee.enumeratedString("RECENTLY-REMOVED-DATERANGES");se&&(g.recentlyRemovedDateranges=se.split("	"));break}case"TARGETDURATION":g.targetduration=parseFloat(z);break;case"VERSION":g.version=parseInt(z);break;case"EXTM3U":break;case"ENDLIST":g.live=!1;break;case"#":(z||X)&&N.tagList.push(X?[z,X]:[z]);break;case"DISCONTINUITY":_++,N.tagList.push(["DIS"]);break;case"GAP":N.tagList.push([Q]);break;case"BITRATE":N.tagList.push([Q,z]);break;case"DATERANGE":{var re=new c.AttrList(z),de=new D.DateRange(re,g.dateRanges[re.ID]);de.isValid||g.skippedSegments?g.dateRanges[de.id]=de:a.logger.warn('Ignoring invalid DATERANGE tag: "'+z+'"'),N.tagList.push(["EXT-X-DATERANGE",z]);break}case"DISCONTINUITY-SEQUENCE":_=parseInt(z);break;case"KEY":{var oe,ae=new c.AttrList(z),fe=ae.enumeratedString("METHOD"),ce=ae.URI,Ee=ae.hexadecimalInteger("IV"),ve=ae.enumeratedString("KEYFORMATVERSIONS"),he=ae.enumeratedString("KEYID"),pe=(oe=ae.enumeratedString("KEYFORMAT"))!=null?oe:"identity",ge=["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"];if(ge.indexOf(pe)>-1){a.logger.warn("Keyformat "+pe+" is not supported from the manifest");continue}else if(pe!=="identity")continue;fe&&(j=A.LevelKey.fromURL(L,ce),ce&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(fe)>=0&&(j.method=fe,j.keyFormat=pe,he&&(j.keyID=he),ve&&(j.keyFormatVersions=ve),j.iv=Ee));break}case"START":{var Se=new c.AttrList(z),ie=Se.decimalFloatingPoint("TIME-OFFSET");Object(F.isFiniteNumber)(ie)&&(g.startTimeOffset=ie);break}case"MAP":{var le=new c.AttrList(z);if(N.duration){var ye=new M.Fragment(y,L);t(ye,le,P,j),I=ye,N.initSegment=I,I.rawProgramDateTime&&!N.rawProgramDateTime&&(N.rawProgramDateTime=I.rawProgramDateTime)}else t(N,le,P,j),I=N,Y=!0;break}case"SERVER-CONTROL":{var ne=new c.AttrList(z);g.canBlockReload=ne.bool("CAN-BLOCK-RELOAD"),g.canSkipUntil=ne.optionalFloat("CAN-SKIP-UNTIL",0),g.canSkipDateRanges=g.canSkipUntil>0&&ne.bool("CAN-SKIP-DATERANGES"),g.partHoldBack=ne.optionalFloat("PART-HOLD-BACK",0),g.holdBack=ne.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var ue=new c.AttrList(z);g.partTarget=ue.decimalFloatingPoint("PART-TARGET");break}case"PART":{var me=g.partList;me||(me=g.partList=[]);var Le=b>0?me[me.length-1]:void 0,Ae=b++,Ie=new M.Part(new c.AttrList(z),N,L,Ae,Le);me.push(Ie),N.duration+=Ie.duration;break}case"PRELOAD-HINT":{var xe=new c.AttrList(z);g.preloadHint=xe;break}case"RENDITION-REPORT":{var Fe=new c.AttrList(z);g.renditionReports=g.renditionReports||[],g.renditionReports.push(Fe);break}default:a.logger.warn("line parsed but not handled: "+K);break}}}k&&!k.relurl?(x.pop(),B-=k.duration,g.partList&&(g.fragmentHint=k)):g.partList&&(e(N,k),N.cc=_,g.fragmentHint=N);var Oe=x.length,De=x[0],Me=x[Oe-1];if(B+=g.skippedSegments*g.targetduration,B>0&&Oe&&Me){g.averagetargetduration=B/Oe;var Pe=Me.sn;g.endSN=Pe!=="initSegment"?Pe:0,De&&(g.startCC=De.cc,De.initSegment||g.fragments.every(function(be){return be.relurl&&n(be.relurl)})&&(a.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),N=new M.Fragment(y,L),N.relurl=Me.relurl,N.level=P,N.sn="initSegment",De.initSegment=N,g.needSidxRanges=!0))}else g.endSN=0,g.startCC=0;return g.fragmentHint&&(B+=g.fragmentHint.duration),g.totalduration=B,g.endCC=_,H>0&&r(x,H),g},i}();function f(i,o){["video","audio","text"].forEach(function(m){var L=i.filter(function(y){return Object(l.isCodecType)(y,m)});if(L.length){var P=L.filter(function(y){return y.lastIndexOf("avc1",0)===0||y.lastIndexOf("mp4a",0)===0});o[m+"Codec"]=P.length>0?P[0]:L[0],i=i.filter(function(y){return L.indexOf(y)===-1})}}),o.unknownCodecs=i}function E(i,o,m){var L=o[m];L&&(i[m]=L)}function r(i,o){for(var m=i[o],L=o;L--;){var P=i[L];if(!P)return;P.programDateTime=m.programDateTime-P.duration*1e3,m=P}}function e(i,o){i.rawProgramDateTime?i.programDateTime=Date.parse(i.rawProgramDateTime):o!=null&&o.programDateTime&&(i.programDateTime=o.endProgramDateTime),Object(F.isFiniteNumber)(i.programDateTime)||(i.programDateTime=null,i.rawProgramDateTime=null)}function t(i,o,m,L){i.relurl=o.URI,o.BYTERANGE&&i.setByteRange(o.BYTERANGE),i.level=m,i.sn="initSegment",L&&(i.levelkey=L),i.initSegment=null}},"./src/loader/playlist-loader.ts":function(w,C,h){h.r(C);var F=h("./src/polyfills/number.ts"),O=h("./src/events.ts"),D=h("./src/errors.ts"),M=h("./src/utils/logger.ts"),R=h("./src/utils/mp4-tools.ts"),A=h("./src/loader/m3u8-parser.ts"),c=h("./src/types/loader.ts"),a=h("./src/utils/attr-list.ts");function l(v){var p=v.type;switch(p){case c.PlaylistContextType.AUDIO_TRACK:return c.PlaylistLevelType.AUDIO;case c.PlaylistContextType.SUBTITLE_TRACK:return c.PlaylistLevelType.SUBTITLE;default:return c.PlaylistLevelType.MAIN}}function s(v,p){var d=v.url;return(d===void 0||d.indexOf("data:")===0)&&(d=p.url),d}var S=function(){function v(d){this.hls=void 0,this.loaders=Object.create(null),this.hls=d,this.registerListeners()}var p=v.prototype;return p.startLoad=function(n){},p.stopLoad=function(){this.destroyInternalLoaders()},p.registerListeners=function(){var n=this.hls;n.on(O.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(O.Events.LEVEL_LOADING,this.onLevelLoading,this),n.on(O.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),n.on(O.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},p.unregisterListeners=function(){var n=this.hls;n.off(O.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.off(O.Events.LEVEL_LOADING,this.onLevelLoading,this),n.off(O.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),n.off(O.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},p.createInternalLoader=function(n){var u=this.hls.config,f=u.pLoader,E=u.loader,r=f||E,e=new r(u);return n.loader=e,this.loaders[n.type]=e,e},p.getInternalLoader=function(n){return this.loaders[n.type]},p.resetInternalLoader=function(n){this.loaders[n]&&delete this.loaders[n]},p.destroyInternalLoaders=function(){for(var n in this.loaders){var u=this.loaders[n];u&&u.destroy(),this.resetInternalLoader(n)}},p.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},p.onManifestLoading=function(n,u){var f=u.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:c.PlaylistContextType.MANIFEST,url:f,deliveryDirectives:null})},p.onLevelLoading=function(n,u){var f=u.id,E=u.level,r=u.url,e=u.deliveryDirectives;this.load({id:f,groupId:null,level:E,responseType:"text",type:c.PlaylistContextType.LEVEL,url:r,deliveryDirectives:e})},p.onAudioTrackLoading=function(n,u){var f=u.id,E=u.groupId,r=u.url,e=u.deliveryDirectives;this.load({id:f,groupId:E,level:null,responseType:"text",type:c.PlaylistContextType.AUDIO_TRACK,url:r,deliveryDirectives:e})},p.onSubtitleTrackLoading=function(n,u){var f=u.id,E=u.groupId,r=u.url,e=u.deliveryDirectives;this.load({id:f,groupId:E,level:null,responseType:"text",type:c.PlaylistContextType.SUBTITLE_TRACK,url:r,deliveryDirectives:e})},p.load=function(n){var u,f=this.hls.config,E=this.getInternalLoader(n);if(E){var r=E.context;if(r&&r.url===n.url){M.logger.trace("[playlist-loader]: playlist request ongoing");return}M.logger.log("[playlist-loader]: aborting previous loader for type: "+n.type),E.abort()}var e,t,i,o;switch(n.type){case c.PlaylistContextType.MANIFEST:e=f.manifestLoadingMaxRetry,t=f.manifestLoadingTimeOut,i=f.manifestLoadingRetryDelay,o=f.manifestLoadingMaxRetryTimeout;break;case c.PlaylistContextType.LEVEL:case c.PlaylistContextType.AUDIO_TRACK:case c.PlaylistContextType.SUBTITLE_TRACK:e=0,t=f.levelLoadingTimeOut;break;default:e=f.levelLoadingMaxRetry,t=f.levelLoadingTimeOut,i=f.levelLoadingRetryDelay,o=f.levelLoadingMaxRetryTimeout;break}if(E=this.createInternalLoader(n),(u=n.deliveryDirectives)!==null&&u!==void 0&&u.part){var m;if(n.type===c.PlaylistContextType.LEVEL&&n.level!==null?m=this.hls.levels[n.level].details:n.type===c.PlaylistContextType.AUDIO_TRACK&&n.id!==null?m=this.hls.audioTracks[n.id].details:n.type===c.PlaylistContextType.SUBTITLE_TRACK&&n.id!==null&&(m=this.hls.subtitleTracks[n.id].details),m){var L=m.partTarget,P=m.targetduration;L&&P&&(t=Math.min(Math.max(L*3,P*.8)*1e3,t))}}var y={timeout:t,maxRetry:e,retryDelay:i,maxRetryDelay:o,highWaterMark:0},T={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};E.load(n,y,T)},p.loadsuccess=function(n,u,f,E){if(E===void 0&&(E=null),f.isSidxRequest){this.handleSidxRequest(n,f),this.handlePlaylistLoaded(n,u,f,E);return}this.resetInternalLoader(f.type);var r=n.data;if(r.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(n,f,"no EXTM3U delimiter",E);return}u.parsing.start=performance.now(),r.indexOf("#EXTINF:")>0||r.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(n,u,f,E):this.handleMasterPlaylist(n,u,f,E)},p.loaderror=function(n,u,f){f===void 0&&(f=null),this.handleNetworkError(u,f,!1,n)},p.loadtimeout=function(n,u,f){f===void 0&&(f=null),this.handleNetworkError(u,f,!0)},p.handleMasterPlaylist=function(n,u,f,E){var r=this.hls,e=n.data,t=s(n,f),i=A.default.parseMasterPlaylist(e,t),o=i.levels,m=i.sessionData;if(!o.length){this.handleManifestParsingError(n,f,"no level found in manifest",E);return}var L=o.map(function(I){return{id:I.attrs.AUDIO,audioCodec:I.audioCodec}}),P=o.map(function(I){return{id:I.attrs.SUBTITLES,textCodec:I.textCodec}}),y=A.default.parseMasterPlaylistMedia(e,t,"AUDIO",L),T=A.default.parseMasterPlaylistMedia(e,t,"SUBTITLES",P),g=A.default.parseMasterPlaylistMedia(e,t,"CLOSED-CAPTIONS");if(y.length){var x=y.some(function(I){return!I.url});!x&&o[0].audioCodec&&!o[0].attrs.AUDIO&&(M.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),y.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new a.AttrList({}),bitrate:0,url:""}))}r.trigger(O.Events.MANIFEST_LOADED,{levels:o,audioTracks:y,subtitles:T,captions:g,url:t,stats:u,networkDetails:E,sessionData:m})},p.handleTrackOrLevelPlaylist=function(n,u,f,E){var r=this.hls,e=f.id,t=f.level,i=f.type,o=s(n,f),m=Object(F.isFiniteNumber)(e)?e:0,L=Object(F.isFiniteNumber)(t)?t:m,P=l(f),y=A.default.parseLevelPlaylist(n.data,o,L,P,m);if(!y.fragments.length){r.trigger(O.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:o,reason:"no fragments found in level",level:typeof f.level=="number"?f.level:void 0});return}if(i===c.PlaylistContextType.MANIFEST){var T={attrs:new a.AttrList({}),bitrate:0,details:y,name:"",url:o};r.trigger(O.Events.MANIFEST_LOADED,{levels:[T],audioTracks:[],url:o,stats:u,networkDetails:E,sessionData:null})}if(u.parsing.end=performance.now(),y.needSidxRanges){var g,x=(g=y.fragments[0].initSegment)===null||g===void 0?void 0:g.url;this.load({url:x,isSidxRequest:!0,type:i,level:t,levelDetails:y,id:e,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null});return}f.levelDetails=y,this.handlePlaylistLoaded(n,u,f,E)},p.handleSidxRequest=function(n,u){var f=new Uint8Array(n.data),E=Object(R.findBox)(f,["sidx"])[0];if(!!E){var r=Object(R.parseSegmentIndex)(E);if(!!r){var e=r.references,t=u.levelDetails;e.forEach(function(i,o){var m=i.info,L=t.fragments[o];if(L.byteRange.length===0&&L.setByteRange(String(1+m.end-m.start)+"@"+String(m.start)),L.initSegment){var P=Object(R.findBox)(f,["moov"])[0],y=P?P.length:null;L.initSegment.setByteRange(String(y)+"@0")}})}}},p.handleManifestParsingError=function(n,u,f,E){this.hls.trigger(O.Events.ERROR,{type:D.ErrorTypes.NETWORK_ERROR,details:D.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:u.type===c.PlaylistContextType.MANIFEST,url:n.url,reason:f,response:n,context:u,networkDetails:E})},p.handleNetworkError=function(n,u,f,E){f===void 0&&(f=!1),M.logger.warn("[playlist-loader]: A network "+(f?"timeout":"error")+" occurred while loading "+n.type+" level: "+n.level+" id: "+n.id+' group-id: "'+n.groupId+'"');var r=D.ErrorDetails.UNKNOWN,e=!1,t=this.getInternalLoader(n);switch(n.type){case c.PlaylistContextType.MANIFEST:r=f?D.ErrorDetails.MANIFEST_LOAD_TIMEOUT:D.ErrorDetails.MANIFEST_LOAD_ERROR,e=!0;break;case c.PlaylistContextType.LEVEL:r=f?D.ErrorDetails.LEVEL_LOAD_TIMEOUT:D.ErrorDetails.LEVEL_LOAD_ERROR,e=!1;break;case c.PlaylistContextType.AUDIO_TRACK:r=f?D.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:D.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,e=!1;break;case c.PlaylistContextType.SUBTITLE_TRACK:r=f?D.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:D.ErrorDetails.SUBTITLE_LOAD_ERROR,e=!1;break}t&&this.resetInternalLoader(n.type);var i={type:D.ErrorTypes.NETWORK_ERROR,details:r,fatal:e,url:n.url,loader:t,context:n,networkDetails:u};E&&(i.response=E),this.hls.trigger(O.Events.ERROR,i)},p.handlePlaylistLoaded=function(n,u,f,E){var r=f.type,e=f.level,t=f.id,i=f.groupId,o=f.loader,m=f.levelDetails,L=f.deliveryDirectives;if(!(m!=null&&m.targetduration)){this.handleManifestParsingError(n,f,"invalid target duration",E);return}if(!!o)switch(m.live&&(o.getCacheAge&&(m.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(m.ageHeader))&&(m.ageHeader=0)),r){case c.PlaylistContextType.MANIFEST:case c.PlaylistContextType.LEVEL:this.hls.trigger(O.Events.LEVEL_LOADED,{details:m,level:e||0,id:t||0,stats:u,networkDetails:E,deliveryDirectives:L});break;case c.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(O.Events.AUDIO_TRACK_LOADED,{details:m,id:t||0,groupId:i||"",stats:u,networkDetails:E,deliveryDirectives:L});break;case c.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(O.Events.SUBTITLE_TRACK_LOADED,{details:m,id:t||0,groupId:i||"",stats:u,networkDetails:E,deliveryDirectives:L});break}},v}();C.default=S},"./src/polyfills/number.ts":function(w,C,h){h.r(C),h.d(C,"isFiniteNumber",function(){return F}),h.d(C,"MAX_SAFE_INTEGER",function(){return O});var F=Number.isFinite||function(D){return typeof D=="number"&&isFinite(D)},O=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":function(w,C,h){h.r(C);var F=function(){function O(){}return O.getSilentFrame=function(M,R){switch(M){case"mp4a.40.2":if(R===1)return new Uint8Array([0,200,0,128,35,128]);if(R===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(R===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(R===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(R===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(R===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(R===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(R===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(R===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},O}();C.default=F},"./src/remux/mp4-generator.ts":function(w,C,h){h.r(C);var F=Math.pow(2,32)-1,O=function(){function D(){}return D.init=function(){D.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var R;for(R in D.types)D.types.hasOwnProperty(R)&&(D.types[R]=[R.charCodeAt(0),R.charCodeAt(1),R.charCodeAt(2),R.charCodeAt(3)]);var A=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),c=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);D.HDLR_TYPES={video:A,audio:c};var a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),l=new Uint8Array([0,0,0,0,0,0,0,0]);D.STTS=D.STSC=D.STCO=l,D.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),D.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),D.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),D.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),S=new Uint8Array([97,118,99,49]),v=new Uint8Array([0,0,0,1]);D.FTYP=D.box(D.types.ftyp,s,v,s,S),D.DINF=D.box(D.types.dinf,D.box(D.types.dref,a))},D.box=function(R){for(var A=8,c=arguments.length,a=new Array(c>1?c-1:0),l=1;l<c;l++)a[l-1]=arguments[l];for(var s=a.length,S=s;s--;)A+=a[s].byteLength;var v=new Uint8Array(A);for(v[0]=A>>24&255,v[1]=A>>16&255,v[2]=A>>8&255,v[3]=A&255,v.set(R,4),s=0,A=8;s<S;s++)v.set(a[s],A),A+=a[s].byteLength;return v},D.hdlr=function(R){return D.box(D.types.hdlr,D.HDLR_TYPES[R])},D.mdat=function(R){return D.box(D.types.mdat,R)},D.mdhd=function(R,A){A*=R;var c=Math.floor(A/(F+1)),a=Math.floor(A%(F+1));return D.box(D.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,R>>24&255,R>>16&255,R>>8&255,R&255,c>>24,c>>16&255,c>>8&255,c&255,a>>24,a>>16&255,a>>8&255,a&255,85,196,0,0]))},D.mdia=function(R){return D.box(D.types.mdia,D.mdhd(R.timescale,R.duration),D.hdlr(R.type),D.minf(R))},D.mfhd=function(R){return D.box(D.types.mfhd,new Uint8Array([0,0,0,0,R>>24,R>>16&255,R>>8&255,R&255]))},D.minf=function(R){return R.type==="audio"?D.box(D.types.minf,D.box(D.types.smhd,D.SMHD),D.DINF,D.stbl(R)):D.box(D.types.minf,D.box(D.types.vmhd,D.VMHD),D.DINF,D.stbl(R))},D.moof=function(R,A,c){return D.box(D.types.moof,D.mfhd(R),D.traf(c,A))},D.moov=function(R){for(var A=R.length,c=[];A--;)c[A]=D.trak(R[A]);return D.box.apply(null,[D.types.moov,D.mvhd(R[0].timescale,R[0].duration)].concat(c).concat(D.mvex(R)))},D.mvex=function(R){for(var A=R.length,c=[];A--;)c[A]=D.trex(R[A]);return D.box.apply(null,[D.types.mvex].concat(c))},D.mvhd=function(R,A){A*=R;var c=Math.floor(A/(F+1)),a=Math.floor(A%(F+1)),l=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,R>>24&255,R>>16&255,R>>8&255,R&255,c>>24,c>>16&255,c>>8&255,c&255,a>>24,a>>16&255,a>>8&255,a&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return D.box(D.types.mvhd,l)},D.sdtp=function(R){var A=R.samples||[],c=new Uint8Array(4+A.length),a,l;for(a=0;a<A.length;a++)l=A[a].flags,c[a+4]=l.dependsOn<<4|l.isDependedOn<<2|l.hasRedundancy;return D.box(D.types.sdtp,c)},D.stbl=function(R){return D.box(D.types.stbl,D.stsd(R),D.box(D.types.stts,D.STTS),D.box(D.types.stsc,D.STSC),D.box(D.types.stsz,D.STSZ),D.box(D.types.stco,D.STCO))},D.avc1=function(R){var A=[],c=[],a,l,s;for(a=0;a<R.sps.length;a++)l=R.sps[a],s=l.byteLength,A.push(s>>>8&255),A.push(s&255),A=A.concat(Array.prototype.slice.call(l));for(a=0;a<R.pps.length;a++)l=R.pps[a],s=l.byteLength,c.push(s>>>8&255),c.push(s&255),c=c.concat(Array.prototype.slice.call(l));var S=D.box(D.types.avcC,new Uint8Array([1,A[3],A[4],A[5],255,224|R.sps.length].concat(A).concat([R.pps.length]).concat(c))),v=R.width,p=R.height,d=R.pixelRatio[0],n=R.pixelRatio[1];return D.box(D.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,v>>8&255,v&255,p>>8&255,p&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),S,D.box(D.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),D.box(D.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,n>>24,n>>16&255,n>>8&255,n&255])))},D.esds=function(R){var A=R.config.length;return new Uint8Array([0,0,0,0,3,23+A,0,1,0,4,15+A,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([A]).concat(R.config).concat([6,1,2]))},D.mp4a=function(R){var A=R.samplerate;return D.box(D.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,R.channelCount,0,16,0,0,0,0,A>>8&255,A&255,0,0]),D.box(D.types.esds,D.esds(R)))},D.mp3=function(R){var A=R.samplerate;return D.box(D.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,R.channelCount,0,16,0,0,0,0,A>>8&255,A&255,0,0]))},D.stsd=function(R){return R.type==="audio"?R.segmentCodec==="mp3"&&R.codec==="mp3"?D.box(D.types.stsd,D.STSD,D.mp3(R)):D.box(D.types.stsd,D.STSD,D.mp4a(R)):D.box(D.types.stsd,D.STSD,D.avc1(R))},D.tkhd=function(R){var A=R.id,c=R.duration*R.timescale,a=R.width,l=R.height,s=Math.floor(c/(F+1)),S=Math.floor(c%(F+1));return D.box(D.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,A>>24&255,A>>16&255,A>>8&255,A&255,0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,S>>24,S>>16&255,S>>8&255,S&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,a>>8&255,a&255,0,0,l>>8&255,l&255,0,0]))},D.traf=function(R,A){var c=D.sdtp(R),a=R.id,l=Math.floor(A/(F+1)),s=Math.floor(A%(F+1));return D.box(D.types.traf,D.box(D.types.tfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255])),D.box(D.types.tfdt,new Uint8Array([1,0,0,0,l>>24,l>>16&255,l>>8&255,l&255,s>>24,s>>16&255,s>>8&255,s&255])),D.trun(R,c.length+16+20+8+16+8+8),c)},D.trak=function(R){return R.duration=R.duration||4294967295,D.box(D.types.trak,D.tkhd(R),D.mdia(R))},D.trex=function(R){var A=R.id;return D.box(D.types.trex,new Uint8Array([0,0,0,0,A>>24,A>>16&255,A>>8&255,A&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},D.trun=function(R,A){var c=R.samples||[],a=c.length,l=12+16*a,s=new Uint8Array(l),S,v,p,d,n,u;for(A+=8+l,s.set([R.type==="video"?1:0,0,15,1,a>>>24&255,a>>>16&255,a>>>8&255,a&255,A>>>24&255,A>>>16&255,A>>>8&255,A&255],0),S=0;S<a;S++)v=c[S],p=v.duration,d=v.size,n=v.flags,u=v.cts,s.set([p>>>24&255,p>>>16&255,p>>>8&255,p&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,n.degradPrio&240<<8,n.degradPrio&15,u>>>24&255,u>>>16&255,u>>>8&255,u&255],12+16*S);return D.box(D.types.trun,s)},D.initSegment=function(R){D.types||D.init();var A=D.moov(R),c=new Uint8Array(D.FTYP.byteLength+A.byteLength);return c.set(D.FTYP),c.set(A,D.FTYP.byteLength),c},D}();O.types=void 0,O.HDLR_TYPES=void 0,O.STTS=void 0,O.STSC=void 0,O.STCO=void 0,O.STSZ=void 0,O.VMHD=void 0,O.SMHD=void 0,O.STSD=void 0,O.FTYP=void 0,O.DINF=void 0,C.default=O},"./src/remux/mp4-remuxer.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return n}),h.d(C,"normalizePts",function(){return u}),h.d(C,"flushTextTrackMetadataCueSamples",function(){return E}),h.d(C,"flushTextTrackUserdataCueSamples",function(){return r});var F=h("./src/polyfills/number.ts"),O=h("./src/remux/aac-helper.ts"),D=h("./src/remux/mp4-generator.ts"),M=h("./src/events.ts"),R=h("./src/errors.ts"),A=h("./src/utils/logger.ts"),c=h("./src/types/loader.ts"),a=h("./src/utils/timescale-conversion.ts");function l(){return l=Object.assign?Object.assign.bind():function(i){for(var o=1;o<arguments.length;o++){var m=arguments[o];for(var L in m)Object.prototype.hasOwnProperty.call(m,L)&&(i[L]=m[L])}return i},l.apply(this,arguments)}var s=10*1e3,S=1024,v=1152,p=null,d=null,n=function(){function i(m,L,P,y){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=m,this.config=L,this.typeSupported=P,this.ISGenerated=!1,p===null){var T=navigator.userAgent||"",g=T.match(/Chrome\/(\d+)/i);p=g?parseInt(g[1]):0}if(d===null){var x=navigator.userAgent.match(/Safari\/(\d+)/i);d=x?parseInt(x[1]):0}}var o=i.prototype;return o.destroy=function(){},o.resetTimeStamp=function(L){A.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=L},o.resetNextTimestamp=function(){A.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},o.resetInitSegment=function(){A.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},o.getVideoStartPts=function(L){var P=!1,y=L.reduce(function(T,g){var x=g.pts-T;return x<-4294967296?(P=!0,u(T,g.pts)):x>0?T:g.pts},L[0].pts);return P&&A.logger.debug("PTS rollover detected"),y},o.remux=function(L,P,y,T,g,x,I,U){var b,B,_,k,N,K,W=g,j=g,H=L.pid>-1,Y=P.pid>-1,Z=P.samples.length,$=L.samples.length>0,V=I&&Z>0||Z>1,Q=(!H||$)&&(!Y||V)||this.ISGenerated||I;if(Q){this.ISGenerated||(_=this.generateIS(L,P,g));var z=this.isVideoContiguous,X=-1,ee;if(V&&(X=f(P.samples),!z&&this.config.forceKeyFrameOnDiscontinuity))if(K=!0,X>0){A.logger.warn("[mp4-remuxer]: Dropped "+X+" out of "+Z+" video samples due to a missing keyframe");var J=this.getVideoStartPts(P.samples);P.samples=P.samples.slice(X),P.dropped+=X,j+=(P.samples[0].pts-J)/P.inputTimeScale,ee=j}else X===-1&&(A.logger.warn("[mp4-remuxer]: No keyframe found out of "+Z+" video samples"),K=!1);if(this.ISGenerated){if($&&V){var te=this.getVideoStartPts(P.samples),se=u(L.samples[0].pts,te)-te,re=se/P.inputTimeScale;W+=Math.max(0,re),j+=Math.max(0,-re)}if($){if(L.samplerate||(A.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),_=this.generateIS(L,P,g)),B=this.remuxAudio(L,W,this.isAudioContiguous,x,Y||V||U===c.PlaylistLevelType.AUDIO?j:void 0),V){var de=B?B.endPTS-B.startPTS:0;P.inputTimeScale||(A.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),_=this.generateIS(L,P,g)),b=this.remuxVideo(P,j,z,de)}}else V&&(b=this.remuxVideo(P,j,z,0));b&&(b.firstKeyFrame=X,b.independent=X!==-1,b.firstKeyFramePTS=ee)}}return this.ISGenerated&&(y.samples.length&&(N=E(y,g,this._initPTS,this._initDTS)),T.samples.length&&(k=r(T,g,this._initPTS))),{audio:B,video:b,initSegment:_,independent:K,text:k,id3:N}},o.generateIS=function(L,P,y){var T=L.samples,g=P.samples,x=this.typeSupported,I={},U=!Object(F.isFiniteNumber)(this._initPTS),b="audio/mp4",B,_,k;if(U&&(B=_=1/0),L.config&&T.length){switch(L.timescale=L.samplerate,L.segmentCodec){case"mp3":x.mpeg?(b="audio/mpeg",L.codec=""):x.mp3&&(L.codec="mp3");break}I.audio={id:"audio",container:b,codec:L.codec,initSegment:L.segmentCodec==="mp3"&&x.mpeg?new Uint8Array(0):D.default.initSegment([L]),metadata:{channelCount:L.channelCount}},U&&(k=L.inputTimeScale,B=_=T[0].pts-Math.round(k*y))}if(P.sps&&P.pps&&g.length&&(P.timescale=P.inputTimeScale,I.video={id:"main",container:"video/mp4",codec:P.codec,initSegment:D.default.initSegment([P]),metadata:{width:P.width,height:P.height}},U)){k=P.inputTimeScale;var N=this.getVideoStartPts(g),K=Math.round(k*y);_=Math.min(_,u(g[0].dts,N)-K),B=Math.min(B,N-K)}if(Object.keys(I).length)return this.ISGenerated=!0,U&&(this._initPTS=B,this._initDTS=_),{tracks:I,initPTS:B,timescale:k}},o.remuxVideo=function(L,P,y,T){var g=L.inputTimeScale,x=L.samples,I=[],U=x.length,b=this._initPTS,B=this.nextAvcDts,_=8,k=this.videoSampleDuration,N,K,W=Number.POSITIVE_INFINITY,j=Number.NEGATIVE_INFINITY,H=!1;if(!y||B===null){var Y=P*g,Z=x[0].pts-u(x[0].dts,x[0].pts);B=Y-Z}for(var $=0;$<U;$++){var V=x[$];V.pts=u(V.pts-b,B),V.dts=u(V.dts-b,B),V.dts<x[$>0?$-1:$].dts&&(H=!0)}H&&x.sort(function(_e,Ve){var Dt=_e.dts-Ve.dts,At=_e.pts-Ve.pts;return Dt||At}),N=x[0].dts,K=x[x.length-1].dts;var Q=K-N,z=Q?Math.round(Q/(U-1)):k||L.inputTimeScale/30;if(y){var X=N-B,ee=X>z,J=X<-1;if(ee||J){ee?A.logger.warn("AVC: "+Object(a.toMsFromMpegTsClock)(X,!0)+" ms ("+X+"dts) hole between fragments detected, filling it"):A.logger.warn("AVC: "+Object(a.toMsFromMpegTsClock)(-X,!0)+" ms ("+X+"dts) overlapping between fragments detected"),N=B;var te=x[0].pts-X;x[0].dts=N,x[0].pts=te,A.logger.log("Video: First PTS/DTS adjusted: "+Object(a.toMsFromMpegTsClock)(te,!0)+"/"+Object(a.toMsFromMpegTsClock)(N,!0)+", delta: "+Object(a.toMsFromMpegTsClock)(X,!0)+" ms")}}N=Math.max(0,N);for(var se=0,re=0,de=0;de<U;de++){for(var oe=x[de],ae=oe.units,fe=ae.length,ce=0,Ee=0;Ee<fe;Ee++)ce+=ae[Ee].data.length;re+=ce,se+=fe,oe.length=ce,oe.dts=Math.max(oe.dts,N),W=Math.min(oe.pts,W),j=Math.max(oe.pts,j)}K=x[U-1].dts;var ve=re+4*se+8,he;try{he=new Uint8Array(ve)}catch{this.observer.emit(M.Events.ERROR,M.Events.ERROR,{type:R.ErrorTypes.MUX_ERROR,details:R.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ve,reason:"fail allocating video mdat "+ve});return}var pe=new DataView(he.buffer);pe.setUint32(0,ve),he.set(D.default.types.mdat,4);for(var ge=!1,Se=Number.POSITIVE_INFINITY,ie=Number.POSITIVE_INFINITY,le=Number.NEGATIVE_INFINITY,ye=Number.NEGATIVE_INFINITY,ne=0;ne<U;ne++){for(var ue=x[ne],me=ue.units,Le=0,Ae=0,Ie=me.length;Ae<Ie;Ae++){var xe=me[Ae],Fe=xe.data,Oe=xe.data.byteLength;pe.setUint32(_,Oe),_+=4,he.set(Fe,_),_+=Oe,Le+=4+Oe}var De=void 0;if(ne<U-1)k=x[ne+1].dts-ue.dts,De=x[ne+1].pts-ue.pts;else{var Me=this.config,Pe=ne>0?ue.dts-x[ne-1].dts:z;if(De=ne>0?ue.pts-x[ne-1].pts:z,Me.stretchShortVideoTrack&&this.nextAudioPts!==null){var be=Math.floor(Me.maxBufferHole*g),Be=(T?W+T*g:this.nextAudioPts)-ue.pts;Be>be?(k=Be-Pe,k<0?k=Pe:ge=!0,A.logger.log("[mp4-remuxer]: It is approximately "+Be/90+" ms to the next segment; using duration "+k/90+" ms for the last video frame.")):k=Pe}else k=Pe}var pt=Math.round(ue.pts-ue.dts);Se=Math.min(Se,k),le=Math.max(le,k),ie=Math.min(ie,De),ye=Math.max(ye,De),I.push(new e(ue.key,k,Le,pt))}if(I.length){if(p){if(p<70){var Ge=I[0].flags;Ge.dependsOn=2,Ge.isNonSync=0}}else if(d&&ye-ie<le-Se&&z/le<.025&&I[0].cts===0){A.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var Ue=N,Te=0,je=I.length;Te<je;Te++){var He=Ue+I[Te].duration,yt=Ue+I[Te].cts;if(Te<je-1){var Tt=He+I[Te+1].cts;I[Te].duration=Tt-yt}else I[Te].duration=Te?I[Te-1].duration:z;I[Te].cts=0,Ue=He}}}console.assert(k!==null,"mp4SampleDuration must be computed"),k=ge||!k?z:k,this.nextAvcDts=B=K+k,this.videoSampleDuration=k,this.isVideoContiguous=!0;var xt=D.default.moof(L.sequenceNumber++,N,l({},L,{samples:I})),St="video",Lt={data1:xt,data2:he,startPTS:W/g,endPTS:(j+k)/g,startDTS:N/g,endDTS:B/g,type:St,hasAudio:!1,hasVideo:!0,nb:I.length,dropped:L.dropped};return L.samples=[],L.dropped=0,console.assert(he.length,"MDAT length must not be zero"),Lt},o.remuxAudio=function(L,P,y,T,g){var x=L.inputTimeScale,I=L.samplerate?L.samplerate:x,U=x/I,b=L.segmentCodec==="aac"?S:v,B=b*U,_=this._initPTS,k=L.segmentCodec==="mp3"&&this.typeSupported.mpeg,N=[],K=g!==void 0,W=L.samples,j=k?0:8,H=this.nextAudioPts||-1,Y=P*x;if(this.isAudioContiguous=y=y||W.length&&H>0&&(T&&Math.abs(Y-H)<9e3||Math.abs(u(W[0].pts-_,Y)-H)<20*B),W.forEach(function(xe){xe.pts=u(xe.pts-_,Y)}),!y||H<0){if(W=W.filter(function(xe){return xe.pts>=0}),!W.length)return;g===0?H=0:T&&!K?H=Math.max(0,Y):H=W[0].pts}if(L.segmentCodec==="aac")for(var Z=this.config.maxAudioFramesDrift,$=0,V=H;$<W.length;$++){var Q=W[$],z=Q.pts,X=z-V,ee=Math.abs(1e3*X/x);if(X<=-Z*B&&K)$===0&&(A.logger.warn("Audio frame @ "+(z/x).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*X/x)+" ms."),this.nextAudioPts=H=V=z);else if(X>=Z*B&&ee<s&&K){var J=Math.round(X/B);V=z-J*B,V<0&&(J--,V+=B),$===0&&(this.nextAudioPts=H=V),A.logger.warn("[mp4-remuxer]: Injecting "+J+" audio frame @ "+(V/x).toFixed(3)+"s due to "+Math.round(1e3*X/x)+" ms gap.");for(var te=0;te<J;te++){var se=Math.max(V,0),re=O.default.getSilentFrame(L.manifestCodec||L.codec,L.channelCount);re||(A.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),re=Q.unit.subarray()),W.splice($,0,{unit:re,pts:se}),V+=B,$++}}Q.pts=V,V+=B}for(var de=null,oe=null,ae,fe=0,ce=W.length;ce--;)fe+=W[ce].unit.byteLength;for(var Ee=0,ve=W.length;Ee<ve;Ee++){var he=W[Ee],pe=he.unit,ge=he.pts;if(oe!==null){var Se=N[Ee-1];Se.duration=Math.round((ge-oe)/U)}else if(y&&L.segmentCodec==="aac"&&(ge=H),de=ge,fe>0){fe+=j;try{ae=new Uint8Array(fe)}catch{this.observer.emit(M.Events.ERROR,M.Events.ERROR,{type:R.ErrorTypes.MUX_ERROR,details:R.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:fe,reason:"fail allocating audio mdat "+fe});return}if(!k){var ie=new DataView(ae.buffer);ie.setUint32(0,fe),ae.set(D.default.types.mdat,4)}}else return;ae.set(pe,j);var le=pe.byteLength;j+=le,N.push(new e(!0,b,le,0)),oe=ge}var ye=N.length;if(!!ye){var ne=N[N.length-1];this.nextAudioPts=H=oe+U*ne.duration;var ue=k?new Uint8Array(0):D.default.moof(L.sequenceNumber++,de/U,l({},L,{samples:N}));L.samples=[];var me=de/x,Le=H/x,Ae="audio",Ie={data1:ue,data2:ae,startPTS:me,endPTS:Le,startDTS:me,endDTS:Le,type:Ae,hasAudio:!0,hasVideo:!1,nb:ye};return this.isAudioContiguous=!0,console.assert(ae.length,"MDAT length must not be zero"),Ie}},o.remuxEmptyAudio=function(L,P,y,T){var g=L.inputTimeScale,x=L.samplerate?L.samplerate:g,I=g/x,U=this.nextAudioPts,b=(U!==null?U:T.startDTS*g)+this._initDTS,B=T.endDTS*g+this._initDTS,_=I*S,k=Math.ceil((B-b)/_),N=O.default.getSilentFrame(L.manifestCodec||L.codec,L.channelCount);if(A.logger.warn("[mp4-remuxer]: remux empty Audio"),!N){A.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var K=[],W=0;W<k;W++){var j=b+W*_;K.push({unit:N,pts:j,dts:j})}return L.samples=K,this.remuxAudio(L,P,y,!1)},i}();function u(i,o){var m;if(o===null)return i;for(o<i?m=-8589934592:m=8589934592;Math.abs(i-o)>4294967296;)i+=m;return i}function f(i){for(var o=0;o<i.length;o++)if(i[o].key)return o;return-1}function E(i,o,m,L){var P=i.samples.length;if(!!P){for(var y=i.inputTimeScale,T=0;T<P;T++){var g=i.samples[T];g.pts=u(g.pts-m,o*y)/y,g.dts=u(g.dts-L,o*y)/y}var x=i.samples;return i.samples=[],{samples:x}}}function r(i,o,m){var L=i.samples.length;if(!!L){for(var P=i.inputTimeScale,y=0;y<L;y++){var T=i.samples[y];T.pts=u(T.pts-m,o*P)/P}i.samples.sort(function(x,I){return x.pts-I.pts});var g=i.samples;return i.samples=[],{samples:g}}}var e=function(o,m,L,P){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=m,this.size=L,this.cts=P,this.flags=new t(o)},t=function(o){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=o?2:1,this.isNonSync=o?0:1}},"./src/remux/passthrough-remuxer.ts":function(w,C,h){h.r(C);var F=h("./src/polyfills/number.ts"),O=h("./src/remux/mp4-remuxer.ts"),D=h("./src/utils/mp4-tools.ts"),M=h("./src/loader/fragment.ts"),R=h("./src/utils/logger.ts"),A=function(){function a(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var l=a.prototype;return l.destroy=function(){},l.resetTimeStamp=function(S){this.initPTS=S,this.lastEndTime=null},l.resetNextTimestamp=function(){this.lastEndTime=null},l.resetInitSegment=function(S,v,p){this.audioCodec=v,this.videoCodec=p,this.generateInitSegment(S),this.emitInitSegment=!0},l.generateInitSegment=function(S){var v=this.audioCodec,p=this.videoCodec;if(!S||!S.byteLength){this.initTracks=void 0,this.initData=void 0;return}var d=this.initData=Object(D.parseInitSegment)(S);v||(v=c(d.audio,M.ElementaryStreamTypes.AUDIO)),p||(p=c(d.video,M.ElementaryStreamTypes.VIDEO));var n={};d.audio&&d.video?n.audiovideo={container:"video/mp4",codec:v+","+p,initSegment:S,id:"main"}:d.audio?n.audio={container:"audio/mp4",codec:v,initSegment:S,id:"audio"}:d.video?n.video={container:"video/mp4",codec:p,initSegment:S,id:"main"}:R.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=n},l.remux=function(S,v,p,d,n){var u,f=this.initPTS,E=this.lastEndTime,r={audio:void 0,video:void 0,text:d,id3:p,initSegment:void 0};Object(F.isFiniteNumber)(E)||(E=this.lastEndTime=n||0);var e=v.samples;if(!e||!e.length)return r;var t={initPTS:void 0,timescale:1},i=this.initData;if((!i||!i.length)&&(this.generateInitSegment(e),i=this.initData),!i||!i.length)return R.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),r;this.emitInitSegment&&(t.tracks=this.initTracks,this.emitInitSegment=!1);var o=Object(D.getStartDTS)(i,e);Object(F.isFiniteNumber)(f)||(this.initPTS=t.initPTS=f=o-n);var m=Object(D.getDuration)(e,i),L=S?o-f:E,P=L+m;Object(D.offsetStartDTS)(i,e,f),m>0?this.lastEndTime=P:(R.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var y=!!i.audio,T=!!i.video,g="";y&&(g+="audio"),T&&(g+="video");var x={data1:e,startPTS:L,startDTS:L,endPTS:P,endDTS:P,type:g,hasAudio:y,hasVideo:T,nb:1,dropped:0};r.audio=x.type==="audio"?x:void 0,r.video=x.type!=="audio"?x:void 0,r.initSegment=t;var I=(u=this.initPTS)!=null?u:0;return r.id3=Object(O.flushTextTrackMetadataCueSamples)(p,n,I,I),d.samples.length&&(r.text=Object(O.flushTextTrackUserdataCueSamples)(d,n,I)),r},a}();function c(a,l){var s=a==null?void 0:a.codec;return s&&s.length>4?s:s==="hvc1"||s==="hev1"?"hvc1.1.c.L120.90":s==="av01"?"av01.0.04M.08":s==="avc1"||l===M.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}C.default=A},"./src/task-loop.ts":function(w,C,h){h.r(C),h.d(C,"default",function(){return F});var F=function(){function O(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var D=O.prototype;return D.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},D.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},D.onHandlerDestroyed=function(){},D.hasInterval=function(){return!!this._tickInterval},D.hasNextTick=function(){return!!this._tickTimer},D.setInterval=function(R){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,R),!0)},D.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},D.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},D.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},D.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},D.doTick=function(){},O}()},"./src/types/demuxer.ts":function(w,C,h){h.r(C),h.d(C,"MetadataSchema",function(){return F});var F;(function(O){O.audioId3="org.id3",O.dateRange="com.apple.quicktime.HLS",O.emsg="https://aomedia.org/emsg/ID3"})(F||(F={}))},"./src/types/level.ts":function(w,C,h){h.r(C),h.d(C,"HlsSkip",function(){return D}),h.d(C,"getSkipValue",function(){return M}),h.d(C,"HlsUrlParameters",function(){return R}),h.d(C,"Level",function(){return A});function F(c,a){for(var l=0;l<a.length;l++){var s=a[l];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(c,s.key,s)}}function O(c,a,l){return a&&F(c.prototype,a),l&&F(c,l),Object.defineProperty(c,"prototype",{writable:!1}),c}var D;(function(c){c.No="",c.Yes="YES",c.v2="v2"})(D||(D={}));function M(c,a){var l=c.canSkipUntil,s=c.canSkipDateRanges,S=c.endSN,v=a!==void 0?a-S:0;return l&&v<l?s?D.v2:D.Yes:D.No}var R=function(){function c(l,s,S){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=l,this.part=s,this.skip=S}var a=c.prototype;return a.addDirectives=function(s){var S=new self.URL(s);return this.msn!==void 0&&S.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&S.searchParams.set("_HLS_part",this.part.toString()),this.skip&&S.searchParams.set("_HLS_skip",this.skip),S.toString()},c}(),A=function(){function c(a){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[a.url],this.attrs=a.attrs,this.bitrate=a.bitrate,a.details&&(this.details=a.details),this.id=a.id||0,this.name=a.name,this.width=a.width||0,this.height=a.height||0,this.audioCodec=a.audioCodec,this.videoCodec=a.videoCodec,this.unknownCodecs=a.unknownCodecs,this.codecSet=[a.videoCodec,a.audioCodec].filter(function(l){return l}).join(",").replace(/\.[^.,]+/g,"")}return O(c,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(l){var s=l%this.url.length;this._urlId!==s&&(this.details=void 0,this._urlId=s)}}]),c}()},"./src/types/loader.ts":function(w,C,h){h.r(C),h.d(C,"PlaylistContextType",function(){return F}),h.d(C,"PlaylistLevelType",function(){return O});var F;(function(D){D.MANIFEST="manifest",D.LEVEL="level",D.AUDIO_TRACK="audioTrack",D.SUBTITLE_TRACK="subtitleTrack"})(F||(F={}));var O;(function(D){D.MAIN="main",D.AUDIO="audio",D.SUBTITLE="subtitle"})(O||(O={}))},"./src/types/transmuxer.ts":function(w,C,h){h.r(C),h.d(C,"ChunkMetadata",function(){return F});var F=function(M,R,A,c,a,l){c===void 0&&(c=0),a===void 0&&(a=-1),l===void 0&&(l=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=O(),this.buffering={audio:O(),video:O(),audiovideo:O()},this.level=M,this.sn=R,this.id=A,this.size=c,this.part=a,this.partial=l};function O(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts":function(w,C,h){h.r(C),h.d(C,"AttrList",function(){return D});var F=/^(\d+)x(\d+)$/,O=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,D=function(){function M(A){typeof A=="string"&&(A=M.parseAttrList(A));for(var c in A)A.hasOwnProperty(c)&&(this[c]=A[c])}var R=M.prototype;return R.decimalInteger=function(c){var a=parseInt(this[c],10);return a>Number.MAX_SAFE_INTEGER?1/0:a},R.hexadecimalInteger=function(c){if(this[c]){var a=(this[c]||"0x").slice(2);a=(a.length&1?"0":"")+a;for(var l=new Uint8Array(a.length/2),s=0;s<a.length/2;s++)l[s]=parseInt(a.slice(s*2,s*2+2),16);return l}else return null},R.hexadecimalIntegerAsNumber=function(c){var a=parseInt(this[c],16);return a>Number.MAX_SAFE_INTEGER?1/0:a},R.decimalFloatingPoint=function(c){return parseFloat(this[c])},R.optionalFloat=function(c,a){var l=this[c];return l?parseFloat(l):a},R.enumeratedString=function(c){return this[c]},R.bool=function(c){return this[c]==="YES"},R.decimalResolution=function(c){var a=F.exec(this[c]);if(a!==null)return{width:parseInt(a[1],10),height:parseInt(a[2],10)}},M.parseAttrList=function(c){var a,l={},s='"';for(O.lastIndex=0;(a=O.exec(c))!==null;){var S=a[2];S.indexOf(s)===0&&S.lastIndexOf(s)===S.length-1&&(S=S.slice(1,-1)),l[a[1]]=S}return l},M}()},"./src/utils/binary-search.ts":function(w,C,h){h.r(C);var F={search:function(D,M){for(var R=0,A=D.length-1,c=null,a=null;R<=A;){c=(R+A)/2|0,a=D[c];var l=M(a);if(l>0)R=c+1;else if(l<0)A=c-1;else return a}return null}};C.default=F},"./src/utils/buffer-helper.ts":function(w,C,h){h.r(C),h.d(C,"BufferHelper",function(){return D});var F=h("./src/utils/logger.ts"),O={length:0,start:function(){return 0},end:function(){return 0}},D=function(){function M(){}return M.isBuffered=function(A,c){try{if(A){for(var a=M.getBuffered(A),l=0;l<a.length;l++)if(c>=a.start(l)&&c<=a.end(l))return!0}}catch{}return!1},M.bufferInfo=function(A,c,a){try{if(A){var l=M.getBuffered(A),s=[],S;for(S=0;S<l.length;S++)s.push({start:l.start(S),end:l.end(S)});return this.bufferedInfo(s,c,a)}}catch{}return{len:0,start:c,end:c,nextStart:void 0}},M.bufferedInfo=function(A,c,a){c=Math.max(0,c),A.sort(function(e,t){var i=e.start-t.start;return i||t.end-e.end});var l=[];if(a)for(var s=0;s<A.length;s++){var S=l.length;if(S){var v=l[S-1].end;A[s].start-v<a?A[s].end>v&&(l[S-1].end=A[s].end):l.push(A[s])}else l.push(A[s])}else l=A;for(var p=0,d,n=c,u=c,f=0;f<l.length;f++){var E=l[f].start,r=l[f].end;if(c+a>=E&&c<r)n=E,u=r,p=u-c;else if(c+a<E){d=E;break}}return{len:p,start:n||0,end:u||0,nextStart:d}},M.getBuffered=function(A){try{return A.buffered}catch(c){return F.logger.log("failed to get media.buffered",c),O}},M}()},"./src/utils/codecs.ts":function(w,C,h){h.r(C),h.d(C,"isCodecType",function(){return O}),h.d(C,"isCodecSupportedInMp4",function(){return D});var F={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function O(M,R){var A=F[R];return!!A&&A[M.slice(0,4)]===!0}function D(M,R){return MediaSource.isTypeSupported((R||"video")+'/mp4;codecs="'+M+'"')}},"./src/utils/discontinuities.ts":function(w,C,h){h.r(C),h.d(C,"findFirstFragWithCC",function(){return M}),h.d(C,"shouldAlignOnDiscontinuities",function(){return R}),h.d(C,"findDiscontinuousReferenceFrag",function(){return A}),h.d(C,"adjustSlidingStart",function(){return a}),h.d(C,"alignStream",function(){return l}),h.d(C,"alignPDT",function(){return S}),h.d(C,"alignFragmentByPDTDelta",function(){return v}),h.d(C,"alignMediaPlaylistByPDT",function(){return p});var F=h("./src/polyfills/number.ts"),O=h("./src/utils/logger.ts"),D=h("./src/controller/level-helper.ts");function M(d,n){for(var u=null,f=0,E=d.length;f<E;f++){var r=d[f];if(r&&r.cc===n){u=r;break}}return u}function R(d,n,u){return!!(n.details&&(u.endCC>u.startCC||d&&d.cc<u.startCC))}function A(d,n){var u=d.fragments,f=n.fragments;if(!f.length||!u.length){O.logger.log("No fragments to align");return}var E=M(u,f[0].cc);if(!E||E&&!E.startPTS){O.logger.log("No frag in previous level to align on");return}return E}function c(d,n){if(d){var u=d.start+n;d.start=d.startPTS=u,d.endPTS=u+d.duration}}function a(d,n){for(var u=n.fragments,f=0,E=u.length;f<E;f++)c(u[f],d);n.fragmentHint&&c(n.fragmentHint,d),n.alignedSliding=!0}function l(d,n,u){!n||(s(d,u,n),!u.alignedSliding&&n.details&&S(u,n.details),!u.alignedSliding&&n.details&&!u.skippedSegments&&Object(D.adjustSliding)(n.details,u))}function s(d,n,u){if(R(d,u,n)){var f=A(u.details,n);f&&Object(F.isFiniteNumber)(f.start)&&(O.logger.log("Adjusting PTS using last level due to CC increase within current level "+n.url),a(f.start,n))}}function S(d,n){if(!(!n.fragments.length||!d.hasProgramDateTime||!n.hasProgramDateTime)){var u=n.fragments[0].programDateTime,f=d.fragments[0].programDateTime,E=(f-u)/1e3+n.fragments[0].start;E&&Object(F.isFiniteNumber)(E)&&(O.logger.log("Adjusting PTS using programDateTime delta "+(f-u)+"ms, sliding:"+E.toFixed(3)+" "+d.url+" "),a(E,d))}}function v(d,n){var u=d.programDateTime;if(!!u){var f=(u-n)/1e3;d.start=d.startPTS=f,d.endPTS=f+d.duration}}function p(d,n){if(!(!n.fragments.length||!d.hasProgramDateTime||!n.hasProgramDateTime)){var u=n.fragments[0].programDateTime,f=n.fragments[0].start,E=u-f*1e3;d.fragments.forEach(function(r){v(r,E)}),d.fragmentHint&&v(d.fragmentHint,E),d.alignedSliding=!0}}},"./src/utils/ewma-bandwidth-estimator.ts":function(w,C,h){h.r(C);var F=h("./src/utils/ewma.ts"),O=function(){function D(R,A,c){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=c,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new F.default(R),this.fast_=new F.default(A)}var M=D.prototype;return M.update=function(A,c){var a=this.slow_,l=this.fast_;this.slow_.halfLife!==A&&(this.slow_=new F.default(A,a.getEstimate(),a.getTotalWeight())),this.fast_.halfLife!==c&&(this.fast_=new F.default(c,l.getEstimate(),l.getTotalWeight()))},M.sample=function(A,c){A=Math.max(A,this.minDelayMs_);var a=8*c,l=A/1e3,s=a/l;this.fast_.sample(l,s),this.slow_.sample(l,s)},M.canEstimate=function(){var A=this.fast_;return A&&A.getTotalWeight()>=this.minWeight_},M.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},M.destroy=function(){},D}();C.default=O},"./src/utils/ewma.ts":function(w,C,h){h.r(C);var F=function(){function O(M,R,A){R===void 0&&(R=0),A===void 0&&(A=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=M,this.alpha_=M?Math.exp(Math.log(.5)/M):0,this.estimate_=R,this.totalWeight_=A}var D=O.prototype;return D.sample=function(R,A){var c=Math.pow(this.alpha_,R);this.estimate_=A*(1-c)+c*this.estimate_,this.totalWeight_+=R},D.getTotalWeight=function(){return this.totalWeight_},D.getEstimate=function(){if(this.alpha_){var R=1-Math.pow(this.alpha_,this.totalWeight_);if(R)return this.estimate_/R}return this.estimate_},O}();C.default=F},"./src/utils/fetch-loader.ts":function(w,C,h){h.r(C),h.d(C,"fetchSupported",function(){return v});var F=h("./src/polyfills/number.ts"),O=h("./src/loader/load-stats.ts"),D=h("./src/demux/chunk-cache.ts");function M(f,E){f.prototype=Object.create(E.prototype),f.prototype.constructor=f,l(f,E)}function R(f){var E=typeof Map=="function"?new Map:void 0;return R=function(e){if(e===null||!a(e))return e;if(typeof e!="function")throw new TypeError("Super expression must either be null or a function");if(typeof E!="undefined"){if(E.has(e))return E.get(e);E.set(e,t)}function t(){return A(e,arguments,s(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),l(t,e)},R(f)}function A(f,E,r){return c()?A=Reflect.construct.bind():A=function(t,i,o){var m=[null];m.push.apply(m,i);var L=Function.bind.apply(t,m),P=new L;return o&&l(P,o.prototype),P},A.apply(null,arguments)}function c(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function a(f){return Function.toString.call(f).indexOf("[native code]")!==-1}function l(f,E){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},l(f,E)}function s(f){return s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},s(f)}function S(){return S=Object.assign?Object.assign.bind():function(f){for(var E=1;E<arguments.length;E++){var r=arguments[E];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(f[e]=r[e])}return f},S.apply(this,arguments)}function v(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var p=function(){function f(r){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=r.fetchSetup||n,this.controller=new self.AbortController,this.stats=new O.LoadStats}var E=f.prototype;return E.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},E.abortInternal=function(){var e=this.response;(!e||!e.ok)&&(this.stats.aborted=!0,this.controller.abort())},E.abort=function(){var e;this.abortInternal(),(e=this.callbacks)!==null&&e!==void 0&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},E.load=function(e,t,i){var o=this,m=this.stats;if(m.loading.start)throw new Error("Loader can only be used once.");m.loading.start=self.performance.now();var L=d(e,this.controller.signal),P=i.onProgress,y=e.responseType==="arraybuffer",T=y?"byteLength":"length";this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,L),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){o.abortInternal(),i.onTimeout(m,e,o.response)},t.timeout),self.fetch(this.request).then(function(g){if(o.response=o.loader=g,!g.ok){var x=g.status,I=g.statusText;throw new u(I||"fetch, bad network response",x,g)}return m.loading.first=Math.max(self.performance.now(),m.loading.start),m.total=parseInt(g.headers.get("Content-Length")||"0"),P&&Object(F.isFiniteNumber)(t.highWaterMark)?o.loadProgressively(g,m,e,t.highWaterMark,P):y?g.arrayBuffer():g.text()}).then(function(g){var x=o.response;self.clearTimeout(o.requestTimeout),m.loading.end=Math.max(self.performance.now(),m.loading.first),m.loaded=m.total=g[T];var I={url:x.url,data:g};P&&!Object(F.isFiniteNumber)(t.highWaterMark)&&P(m,e,g,x),i.onSuccess(I,m,e,x)}).catch(function(g){if(self.clearTimeout(o.requestTimeout),!m.aborted){var x=g&&g.code||0,I=g?g.message:null;i.onError({code:x,text:I},e,g?g.details:null)}})},E.getCacheAge=function(){var e=null;if(this.response){var t=this.response.headers.get("age");e=t?parseFloat(t):null}return e},E.loadProgressively=function(e,t,i,o,m){o===void 0&&(o=0);var L=new D.default,P=e.body.getReader(),y=function T(){return P.read().then(function(g){if(g.done)return L.dataLength&&m(t,i,L.flush(),e),Promise.resolve(new ArrayBuffer(0));var x=g.value,I=x.length;return t.loaded+=I,I<o||L.dataLength?(L.push(x),L.dataLength>=o&&m(t,i,L.flush(),e)):m(t,i,x,e),T()}).catch(function(){return Promise.reject()})};return y()},f}();function d(f,E){var r={method:"GET",mode:"cors",credentials:"same-origin",signal:E,headers:new self.Headers(S({},f.headers))};return f.rangeEnd&&r.headers.set("Range","bytes="+f.rangeStart+"-"+String(f.rangeEnd-1)),r}function n(f,E){return new self.Request(f.url,E)}var u=function(f){M(E,f);function E(r,e,t){var i;return i=f.call(this,r)||this,i.code=void 0,i.details=void 0,i.code=e,i.details=t,i}return E}(R(Error));C.default=p},"./src/utils/logger.ts":function(w,C,h){h.r(C),h.d(C,"enableLogs",function(){return A}),h.d(C,"logger",function(){return c});var F=function(){},O={trace:F,debug:F,log:F,warn:F,info:F,error:F},D=O;function M(a){var l=self.console[a];return l?l.bind(self.console,"["+a+"] >"):F}function R(a){for(var l=arguments.length,s=new Array(l>1?l-1:0),S=1;S<l;S++)s[S-1]=arguments[S];s.forEach(function(v){D[v]=a[v]?a[v].bind(a):M(v)})}function A(a){if(self.console&&a===!0||typeof a=="object"){R(a,"debug","log","info","warn","error");try{D.log()}catch{D=O}}else D=O}var c=D},"./src/utils/mediakeys-helper.ts":function(w,C,h){h.r(C),h.d(C,"KeySystems",function(){return F}),h.d(C,"requestMediaKeySystemAccess",function(){return O});var F;(function(D){D.WIDEVINE="com.widevine.alpha",D.PLAYREADY="com.microsoft.playready"})(F||(F={}));var O=function(){return typeof self!="undefined"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}()},"./src/utils/mediasource-helper.ts":function(w,C,h){h.r(C),h.d(C,"getMediaSource",function(){return F});function F(){return self.MediaSource||self.WebKitMediaSource}},"./src/utils/mp4-tools.ts":function(w,C,h){h.r(C),h.d(C,"RemuxerTrackIdConfig",function(){return A}),h.d(C,"bin2str",function(){return c}),h.d(C,"readUint16",function(){return a}),h.d(C,"readUint32",function(){return l}),h.d(C,"readSint32",function(){return s}),h.d(C,"writeUint32",function(){return S}),h.d(C,"findBox",function(){return v}),h.d(C,"parseSegmentIndex",function(){return p}),h.d(C,"parseInitSegment",function(){return d}),h.d(C,"getStartDTS",function(){return n}),h.d(C,"getDuration",function(){return u}),h.d(C,"computeRawDurationFromSamples",function(){return f}),h.d(C,"offsetStartDTS",function(){return E}),h.d(C,"segmentValidRange",function(){return r}),h.d(C,"appendUint8Array",function(){return e}),h.d(C,"parseSamples",function(){return t}),h.d(C,"parseSEIMessageFromNALu",function(){return m}),h.d(C,"parseEmsg",function(){return P});var F=h("./src/utils/typed-array.ts"),O=h("./src/loader/fragment.ts"),D=h("./src/demux/id3.ts"),M=Math.pow(2,32)-1,R=[].push,A={video:1,audio:2,id3:3,text:4};function c(y){return String.fromCharCode.apply(null,y)}function a(y,T){var g=y[T]<<8|y[T+1];return g<0?65536+g:g}function l(y,T){var g=s(y,T);return g<0?4294967296+g:g}function s(y,T){return y[T]<<24|y[T+1]<<16|y[T+2]<<8|y[T+3]}function S(y,T,g){y[T]=g>>24,y[T+1]=g>>16&255,y[T+2]=g>>8&255,y[T+3]=g&255}function v(y,T){var g=[];if(!T.length)return g;for(var x=y.byteLength,I=0;I<x;){var U=l(y,I),b=c(y.subarray(I+4,I+8)),B=U>1?I+U:x;if(b===T[0])if(T.length===1)g.push(y.subarray(I+8,B));else{var _=v(y.subarray(I+8,B),T.slice(1));_.length&&R.apply(g,_)}I=B}return g}function p(y){var T=[],g=y[0],x=8,I=l(y,x);x+=4;var U=0,b=0;g===0?x+=8:x+=16,x+=2;var B=y.length+b,_=a(y,x);x+=2;for(var k=0;k<_;k++){var N=x,K=l(y,N);N+=4;var W=K&2147483647,j=(K&2147483648)>>>31;if(j===1)return console.warn("SIDX has hierarchical references (not supported)"),null;var H=l(y,N);N+=4,T.push({referenceSize:W,subsegmentDuration:H,info:{duration:H/I,start:B,end:B+W-1}}),B+=W,N+=4,x=N}return{earliestPresentationTime:U,timescale:I,version:g,referencesCount:_,references:T}}function d(y){for(var T=[],g=v(y,["moov","trak"]),x=0;x<g.length;x++){var I=g[x],U=v(I,["tkhd"])[0];if(U){var b=U[0],B=b===0?12:20,_=l(U,B),k=v(I,["mdia","mdhd"])[0];if(k){b=k[0],B=b===0?12:20;var N=l(k,B),K=v(I,["mdia","hdlr"])[0];if(K){var W=c(K.subarray(8,12)),j={soun:O.ElementaryStreamTypes.AUDIO,vide:O.ElementaryStreamTypes.VIDEO}[W];if(j){var H=v(I,["mdia","minf","stbl","stsd"])[0],Y=void 0;H&&(Y=c(H.subarray(12,16))),T[_]={timescale:N,type:j},T[j]={timescale:N,id:_,codec:Y}}}}}}var Z=v(y,["moov","mvex","trex"]);return Z.forEach(function($){var V=l($,4),Q=T[V];Q&&(Q.default={duration:l($,12),flags:l($,20)})}),T}function n(y,T){return v(T,["moof","traf"]).reduce(function(g,x){var I=v(x,["tfdt"])[0],U=I[0],b=v(x,["tfhd"]).reduce(function(B,_){var k=l(_,4),N=y[k];if(N){var K=l(I,4);U===1&&(K*=Math.pow(2,32),K+=l(I,8));var W=N.timescale||9e4,j=K/W;if(isFinite(j)&&(B===null||j<B))return j}return B},null);return b!==null&&isFinite(b)&&(g===null||b<g)?b:g},null)||0}function u(y,T){for(var g=0,x=0,I=0,U=v(y,["moof","traf"]),b=0;b<U.length;b++){var B=U[b],_=v(B,["tfhd"])[0],k=l(_,4),N=T[k];if(!!N){var K=N.default,W=l(_,0)|(K==null?void 0:K.flags),j=K==null?void 0:K.duration;W&8&&(W&2?j=l(_,12):j=l(_,8));for(var H=N.timescale||9e4,Y=v(B,["trun"]),Z=0;Z<Y.length;Z++){if(g=f(Y[Z]),!g&&j){var $=l(Y[Z],4);g=j*$}N.type===O.ElementaryStreamTypes.VIDEO?x+=g/H:N.type===O.ElementaryStreamTypes.AUDIO&&(I+=g/H)}}}if(x===0&&I===0){for(var V=0,Q=v(y,["sidx"]),z=0;z<Q.length;z++){var X=p(Q[z]);X!=null&&X.references&&(V+=X.references.reduce(function(ee,J){return ee+J.info.duration||0},0))}return V}return x||I}function f(y){var T=l(y,0),g=8;T&1&&(g+=4),T&4&&(g+=4);for(var x=0,I=l(y,4),U=0;U<I;U++){if(T&256){var b=l(y,g);x+=b,g+=4}T&512&&(g+=4),T&1024&&(g+=4),T&2048&&(g+=4)}return x}function E(y,T,g){v(T,["moof","traf"]).forEach(function(x){v(x,["tfhd"]).forEach(function(I){var U=l(I,4),b=y[U];if(!!b){var B=b.timescale||9e4;v(x,["tfdt"]).forEach(function(_){var k=_[0],N=l(_,4);if(k===0)N-=g*B,N=Math.max(N,0),S(_,4,N);else{N*=Math.pow(2,32),N+=l(_,8),N-=g*B,N=Math.max(N,0);var K=Math.floor(N/(M+1)),W=Math.floor(N%(M+1));S(_,4,K),S(_,8,W)}})}})})}function r(y){var T={valid:null,remainder:null},g=v(y,["moof"]);if(g){if(g.length<2)return T.remainder=y,T}else return T;var x=g[g.length-1];return T.valid=Object(F.sliceUint8)(y,0,x.byteOffset-8),T.remainder=Object(F.sliceUint8)(y,x.byteOffset-8),T}function e(y,T){var g=new Uint8Array(y.length+T.length);return g.set(y),g.set(T,y.length),g}function t(y,T){var g=[],x=T.samples,I=T.timescale,U=T.id,b=!1,B=v(x,["moof"]);return B.map(function(_){var k=_.byteOffset-8,N=v(_,["traf"]);N.map(function(K){var W=v(K,["tfdt"]).map(function(j){var H=j[0],Y=l(j,4);return H===1&&(Y*=Math.pow(2,32),Y+=l(j,8)),Y/I})[0];return W!==void 0&&(y=W),v(K,["tfhd"]).map(function(j){var H=l(j,4),Y=l(j,0)&16777215,Z=(Y&1)!==0,$=(Y&2)!==0,V=(Y&8)!==0,Q=0,z=(Y&16)!==0,X=0,ee=(Y&32)!==0,J=8;H===U&&(Z&&(J+=8),$&&(J+=4),V&&(Q=l(j,J),J+=4),z&&(X=l(j,J),J+=4),ee&&(J+=4),T.type==="video"&&(b=i(T.codec)),v(K,["trun"]).map(function(te){var se=te[0],re=l(te,0)&16777215,de=(re&1)!==0,oe=0,ae=(re&4)!==0,fe=(re&256)!==0,ce=0,Ee=(re&512)!==0,ve=0,he=(re&1024)!==0,pe=(re&2048)!==0,ge=0,Se=l(te,4),ie=8;de&&(oe=l(te,ie),ie+=4),ae&&(ie+=4);for(var le=oe+k,ye=0;ye<Se;ye++){if(fe?(ce=l(te,ie),ie+=4):ce=Q,Ee?(ve=l(te,ie),ie+=4):ve=X,he&&(ie+=4),pe&&(se===0?ge=l(te,ie):ge=s(te,ie),ie+=4),T.type===O.ElementaryStreamTypes.VIDEO)for(var ne=0;ne<ve;){var ue=l(x,le);le+=4;var me=x[le]&31;if(o(b,me)){var Le=x.subarray(le,le+ue);m(Le,y+ge/I,g)}le+=ue,ne+=ue+4}y+=ce/I}}))})})}),g}function i(y){if(!y)return!1;var T=y.indexOf("."),g=T<0?y:y.substring(0,T);return g==="hvc1"||g==="hev1"||g==="dvh1"||g==="dvhe"}function o(y,T){return y?T===39||T===40:T===6}function m(y,T,g){var x=L(y),I=0;I++;for(var U=0,b=0,B=!1,_=0;I<x.length;){U=0;do{if(I>=x.length)break;_=x[I++],U+=_}while(_===255);b=0;do{if(I>=x.length)break;_=x[I++],b+=_}while(_===255);var k=x.length-I;if(!B&&U===4&&I<x.length){B=!0;var N=x[I++];if(N===181){var K=a(x,I);if(I+=2,K===49){var W=l(x,I);if(I+=4,W===1195456820){var j=x[I++];if(j===3){var H=x[I++],Y=31&H,Z=64&H,$=Z?2+Y*3:0,V=new Uint8Array($);if(Z){V[0]=H;for(var Q=1;Q<$;Q++)V[Q]=x[I++]}g.push({type:j,payloadType:U,pts:T,bytes:V})}}}}}else if(U===5&&b<k){if(B=!0,b>16){for(var z=[],X=0;X<16;X++){var ee=x[I++].toString(16);z.push(ee.length==1?"0"+ee:ee),(X===3||X===5||X===7||X===9)&&z.push("-")}for(var J=b-16,te=new Uint8Array(J),se=0;se<J;se++)te[se]=x[I++];g.push({payloadType:U,pts:T,uuid:z.join(""),userData:Object(D.utf8ArrayToStr)(te),userDataBytes:te})}}else if(b<k)I+=b;else if(b>k)break}}function L(y){for(var T=y.byteLength,g=[],x=1;x<T-2;)y[x]===0&&y[x+1]===0&&y[x+2]===3?(g.push(x+2),x+=2):x++;if(g.length===0)return y;var I=T-g.length,U=new Uint8Array(I),b=0;for(x=0;x<I;b++,x++)b===g[0]&&(b++,g.shift()),U[x]=y[b];return U}function P(y){var T=y[0],g="",x="",I=0,U=0,b=0,B=0,_=0,k=0;if(T===0){for(;c(y.subarray(k,k+1))!=="\0";)g+=c(y.subarray(k,k+1)),k+=1;for(g+=c(y.subarray(k,k+1)),k+=1;c(y.subarray(k,k+1))!=="\0";)x+=c(y.subarray(k,k+1)),k+=1;x+=c(y.subarray(k,k+1)),k+=1,I=l(y,12),U=l(y,16),B=l(y,20),_=l(y,24),k=28}else if(T===1){k+=4,I=l(y,k),k+=4;var N=l(y,k);k+=4;var K=l(y,k);for(k+=4,b=Math.pow(2,32)*N+K,Number.isSafeInteger(b)||(b=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),B=l(y,k),k+=4,_=l(y,k),k+=4;c(y.subarray(k,k+1))!=="\0";)g+=c(y.subarray(k,k+1)),k+=1;for(g+=c(y.subarray(k,k+1)),k+=1;c(y.subarray(k,k+1))!=="\0";)x+=c(y.subarray(k,k+1)),k+=1;x+=c(y.subarray(k,k+1)),k+=1}var W=y.subarray(k,y.byteLength);return{schemeIdUri:g,value:x,timeScale:I,presentationTime:b,presentationTimeDelta:U,eventDuration:B,id:_,payload:W}}},"./src/utils/texttrack-utils.ts":function(w,C,h){h.r(C),h.d(C,"sendAddTrackEvent",function(){return O}),h.d(C,"addCueToTrack",function(){return D}),h.d(C,"clearCurrentCues",function(){return M}),h.d(C,"removeCuesInRange",function(){return R}),h.d(C,"getCuesInRange",function(){return c});var F=h("./src/utils/logger.ts");function O(a,l){var s;try{s=new Event("addtrack")}catch{s=document.createEvent("Event"),s.initEvent("addtrack",!1,!1)}s.track=a,l.dispatchEvent(s)}function D(a,l){var s=a.mode;if(s==="disabled"&&(a.mode="hidden"),a.cues&&!a.cues.getCueById(l.id))try{if(a.addCue(l),!a.cues.getCueById(l.id))throw new Error("addCue is failed for: "+l)}catch(v){F.logger.debug("[texttrack-utils]: "+v);var S=new self.TextTrackCue(l.startTime,l.endTime,l.text);S.id=l.id,a.addCue(S)}s==="disabled"&&(a.mode=s)}function M(a){var l=a.mode;if(l==="disabled"&&(a.mode="hidden"),a.cues)for(var s=a.cues.length;s--;)a.removeCue(a.cues[s]);l==="disabled"&&(a.mode=l)}function R(a,l,s,S){var v=a.mode;if(v==="disabled"&&(a.mode="hidden"),a.cues&&a.cues.length>0)for(var p=c(a.cues,l,s),d=0;d<p.length;d++)(!S||S(p[d]))&&a.removeCue(p[d]);v==="disabled"&&(a.mode=v)}function A(a,l){if(l<a[0].startTime)return 0;var s=a.length-1;if(l>a[s].endTime)return-1;for(var S=0,v=s;S<=v;){var p=Math.floor((v+S)/2);if(l<a[p].startTime)v=p-1;else if(l>a[p].startTime&&S<s)S=p+1;else return p}return a[S].startTime-l<l-a[v].startTime?S:v}function c(a,l,s){var S=[],v=A(a,l);if(v>-1)for(var p=v,d=a.length;p<d;p++){var n=a[p];if(n.startTime>=l&&n.endTime<=s)S.push(n);else if(n.startTime>s)return S}return S}},"./src/utils/time-ranges.ts":function(w,C,h){h.r(C);var F={toString:function(D){for(var M="",R=D.length,A=0;A<R;A++)M+="["+D.start(A).toFixed(3)+","+D.end(A).toFixed(3)+"]";return M}};C.default=F},"./src/utils/timescale-conversion.ts":function(w,C,h){h.r(C),h.d(C,"toTimescaleFromBase",function(){return O}),h.d(C,"toTimescaleFromScale",function(){return D}),h.d(C,"toMsFromMpegTsClock",function(){return M}),h.d(C,"toMpegTsClockFromTimescale",function(){return R});var F=9e4;function O(A,c,a,l){a===void 0&&(a=1),l===void 0&&(l=!1);var s=A*c*a;return l?Math.round(s):s}function D(A,c,a,l){return a===void 0&&(a=1),l===void 0&&(l=!1),O(A,c,1/a,l)}function M(A,c){return c===void 0&&(c=!1),O(A,1e3,1/F,c)}function R(A,c){return c===void 0&&(c=1),O(A,F,1/c)}},"./src/utils/typed-array.ts":function(w,C,h){h.r(C),h.d(C,"sliceUint8",function(){return F});function F(O,D,M){return Uint8Array.prototype.slice?O.slice(D,M):new Uint8Array(Array.prototype.slice.call(O,D,M))}},"./src/utils/xhr-loader.ts":function(w,C,h){h.r(C);var F=h("./src/utils/logger.ts"),O=h("./src/loader/load-stats.ts"),D=/^age:\s*[\d.]+\s*$/m,M=function(){function R(c){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=c?c.xhrSetup:null,this.stats=new O.LoadStats,this.retryDelay=0}var A=R.prototype;return A.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},A.abortInternal=function(){var a=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),a&&(a.onreadystatechange=null,a.onprogress=null,a.readyState!==4&&(this.stats.aborted=!0,a.abort()))},A.abort=function(){var a;this.abortInternal(),(a=this.callbacks)!==null&&a!==void 0&&a.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},A.load=function(a,l,s){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=a,this.config=l,this.callbacks=s,this.retryDelay=l.retryDelay,this.loadInternal()},A.loadInternal=function(){var a=this.config,l=this.context;if(!!a){var s=this.loader=new self.XMLHttpRequest,S=this.stats;S.loading.first=0,S.loaded=0;var v=this.xhrSetup;try{if(v)try{v(s,l.url)}catch{s.open("GET",l.url,!0),v(s,l.url)}s.readyState||s.open("GET",l.url,!0);var p=this.context.headers;if(p)for(var d in p)s.setRequestHeader(d,p[d])}catch(n){this.callbacks.onError({code:s.status,text:n.message},l,s);return}l.rangeEnd&&s.setRequestHeader("Range","bytes="+l.rangeStart+"-"+(l.rangeEnd-1)),s.onreadystatechange=this.readystatechange.bind(this),s.onprogress=this.loadprogress.bind(this),s.responseType=l.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),a.timeout),s.send()}},A.readystatechange=function(){var a=this.context,l=this.loader,s=this.stats;if(!(!a||!l)){var S=l.readyState,v=this.config;if(!s.aborted&&S>=2)if(self.clearTimeout(this.requestTimeout),s.loading.first===0&&(s.loading.first=Math.max(self.performance.now(),s.loading.start)),S===4){l.onreadystatechange=null,l.onprogress=null;var p=l.status;if(p>=200&&p<300){s.loading.end=Math.max(self.performance.now(),s.loading.first);var d,n;if(a.responseType==="arraybuffer"?(d=l.response,n=d.byteLength):(d=l.responseText,n=d.length),s.loaded=s.total=n,!this.callbacks)return;var u=this.callbacks.onProgress;if(u&&u(s,a,d,l),!this.callbacks)return;var f={url:l.responseURL,data:d};this.callbacks.onSuccess(f,s,a,l)}else s.retry>=v.maxRetry||p>=400&&p<499?(F.logger.error(p+" while loading "+a.url),this.callbacks.onError({code:p,text:l.statusText},a,l)):(F.logger.warn(p+" while loading "+a.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,v.maxRetryDelay),s.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),v.timeout)}},A.loadtimeout=function(){F.logger.warn("timeout while loading "+this.context.url);var a=this.callbacks;a&&(this.abortInternal(),a.onTimeout(this.stats,this.context,this.loader))},A.loadprogress=function(a){var l=this.stats;l.loaded=a.loaded,a.lengthComputable&&(l.total=a.total)},A.getCacheAge=function(){var a=null;if(this.loader&&D.test(this.loader.getAllResponseHeaders())){var l=this.loader.getResponseHeader("age");a=l?parseFloat(l):null}return a},R}();C.default=M}}).default})})(Ne);var Re=ze(Ne.exports),Xe=function(){var G=this,q=G.$createElement,w=G._self._c||q;return w("div",{staticClass:"video-player"},[w("transition",{attrs:{name:"fade"}},[!!G.thumb&&G.state.playback==="idle"?w("img",{staticClass:"thumb",attrs:{src:G.thumb.src,srcset:G.thumb.srcset,sizes:"auto"}}):G._e()]),w("transition",{attrs:{name:"fade"}},[G.state.playback==="idle"||G.state.playback==="ended"||G.state.playback==="paused"?w("div",{staticClass:"overlay",on:{click:G.togglePlayback}},[w("button",{staticClass:"overlay__inner"},[w("svg",{attrs:{width:"10",height:"13",viewBox:"0 0 10 13",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"}},[w("path",{attrs:{d:"M0 0.388916L10 6.50003L0 12.6111V0.388916Z"}})])])]):G._e()]),w("video",{ref:"video",staticClass:"player-video",attrs:{loop:!1,preload:"auto"},domProps:{muted:G.state.muted},on:{play:G.onPlay,pause:G.onPause,ended:G.onEnded,click:G.togglePlayback}})],1)},$e=[],Ot="";function Ce(G,q,w,C,h,F,O,D){var M=typeof G=="function"?G.options:G;q&&(M.render=q,M.staticRenderFns=w,M._compiled=!0),C&&(M.functional=!0),F&&(M._scopeId="data-v-"+F);var R;if(O?(R=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(a=__VUE_SSR_CONTEXT__),h&&h.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(O)},M._ssrRegister=R):h&&(R=D?function(){h.call(this,(M.functional?this.parent:this).$root.$options.shadowRoot)}:h),R)if(M.functional){M._injectStyles=R;var A=M.render;M.render=function(l,s){return R.call(s),A(l,s)}}else{var c=M.beforeCreate;M.beforeCreate=c?[].concat(c,R):[R]}return{exports:G,options:M}}const Qe={name:"VideoPlayer",props:{src:{type:String,required:!0},thumb:{type:Object,default:()=>({})}},data(){return{state:{loaded:!1,playback:"idle",muted:!1},hls:null}},mounted(){this.load()},beforeUnmount(){this.destroy()},methods:{load(){Re.isSupported()?(this.hls=new Re,this.hls.loadSource(this.src),this.hls.attachMedia(this.$refs.video),this.hls.on(Re.Events.MEDIA_ATTACHED,this.onLoad)):(this.$refs.video.src=this.src,this.$refs.video.load(),this.state.loaded=!0)},destroy(){this.hls.detachMedia(),this.hls.destroy()},play(){const G=this.$refs.video.play();G!==null&&G.catch(()=>{this.pause()})},pause(){this.$refs.video.pause()},togglePlayback(){this.state.playback==="playing"?this.pause():this.play()},onLoad(){this.state.loaded=!0},onPlay(){this.state.playback="playing"},onPause(){this.state.playback="paused"},onEnded(){this.state.playback="ended"}}},ke={};var Ze=Ce(Qe,Xe,$e,!1,Je,null,null,null);function Je(G){for(let q in ke)this[q]=ke[q]}var qe=function(){return Ze.exports}(),et=function(){var G=this,q=G.$createElement,w=G._self._c||q;return w("k-block-figure",{attrs:{"is-empty":!G.video.url,caption:G.content.caption,"empty-icon":"image","empty-text":"No file selected yet \u2026"},on:{open:G.open,update:G.update}},[G.src?w("VideoPlayer",{attrs:{src:G.src,thumb:G.thumb}}):G._e()],1)},tt=[];const rt={name:"VideoBlock",components:{VideoPlayer:qe},data(){return{mux:null}},computed:{video(){return this.content.video[0]||{}},id(){var G;return(G=this.mux)==null?void 0:G.playback_ids[0].id},src(){return this.id?`https://stream.mux.com/${this.id}.m3u8`:""},time(){return this.content.thumbnail||0},thumb(){if(!this.id)return"";const G=`https://image.mux.com/${this.id}/thumbnail.jpg?time=${this.time}`;return{src:G,srcset:[300,600,900,1200,1600].map(w=>`${G}&width=${w} ${w}w`).join(", ")}}},watch:{"video.link":{handler(G){G&&this.$api.get(G).then(q=>{this.mux=JSON.parse(q.content.mux)})},immediate:!0}}},Ke={};var nt=Ce(rt,et,tt,!1,it,null,null,null);function it(G){for(let q in Ke)this[q]=Ke[q]}var at=function(){return nt.exports}(),st=function(){var G=this,q=G.$createElement,w=G._self._c||q;return w("div",{staticClass:"audio-player"},[w("transition",{attrs:{name:"fade"}},[G.state.playback==="idle"||G.state.playback==="ended"||G.state.playback==="paused"?w("div",{staticClass:"overlay",on:{click:G.togglePlayback}}):G._e()]),w("audio",{ref:"audio",staticClass:"player-audio k-block-type-audio-element",attrs:{controls:"",loop:!1,muted:G.state.muted,preload:"auto"},on:{play:G.onPlay,pause:G.onPause,ended:G.onEnded,click:G.togglePlayback}})],1)},ot=[],Pt="";const lt={name:"AudioPlayer",props:{src:{type:String,required:!0}},data(){return{state:{loaded:!1,playback:"idle",muted:!1},hls:null}},mounted(){this.load()},beforeUnmount(){this.destroy()},methods:{load(){Re.isSupported()?(this.hls=new Re,this.hls.loadSource(this.src),this.hls.attachMedia(this.$refs.audio),this.hls.on(Re.Events.MEDIA_ATTACHED,this.onLoad)):(this.$refs.audio.src=this.src,this.$refs.audio.load(),this.state.loaded=!0)},destroy(){this.hls.detachMedia(),this.hls.destroy()},play(){const G=this.$refs.audio.play();G!==null&&G.catch(()=>{this.pause()})},pause(){this.$refs.audio.pause()},togglePlayback(){this.state.playback==="playing"?this.pause():this.play()},onLoad(){this.state.loaded=!0},onPlay(){this.state.playback="playing"},onPause(){this.state.playback="paused"},onEnded(){this.state.playback="ended"}}},we={};var ut=Ce(lt,st,ot,!1,ft,null,null,null);function ft(G){for(let q in we)this[q]=we[q]}var dt=function(){return ut.exports}(),ht=function(){var G=this,q=G.$createElement,w=G._self._c||q;return w("k-block-figure",{attrs:{"is-empty":!G.audio.url,caption:G.content.caption,"empty-icon":"image","empty-text":"No file selected yet \u2026"},on:{open:G.open,update:G.update}},[G.src?w("AudioPlayer",{attrs:{src:G.src}}):G._e()],1)},ct=[];const vt={name:"AudioBlock",components:{AudioPlayer:dt},data(){return{mux:null}},computed:{audio(){return this.content.audio[0]||{}},id(){var G;return(G=this.mux)==null?void 0:G.playback_ids[0].id},src(){return this.id?`https://stream.mux.com/${this.id}.m3u8`:""}},watch:{"audio.link":{handler(G){G&&this.$api.get(G).then(q=>{this.mux=JSON.parse(q.content.mux)})},immediate:!0}}},We={};var gt=Ce(vt,ht,ct,!1,mt,null,null,null);function mt(G){for(let q in We)this[q]=We[q]}var Et=function(){return gt.exports}();window.panel.plugin("robinscholz/kirby-mux",{blocks:{"mux-video":at,"mux-audio":Et}})})();

```

# index.php

```php
<?php
@include_once __DIR__ . '/vendor/autoload.php';
// To get the video aspect ratio and other meta data
require('vendor/james-heinrich/getid3/getid3/getid3.php');
Dotenv\Dotenv::createImmutable(kirby()->root('base'))->load(); // TODO: Add configurable path for .env
Kirby::plugin('robinscholz/kirby-mux', [
    'translations' => [
        'en' => [
            'field.blocks.mux-video.thumbnail' => 'Generate thumbnail from frame',
            'field.blocks.mux-video.thumbnail.help' => 'In seconds',
        ],
        'de' => [
            'field.blocks.mux-video.thumbnail' => 'Thumbnail aus Frame generieren',
            'field.blocks.mux-video.thumbnail.help' => 'In Sekunden',
        ],
    ],
    'blueprints' => [
        'files/mux-video' => __DIR__ . '/blueprints/files/mux-video.yml',
        'blocks/mux-video' => __DIR__ . '/blueprints/blocks/mux-video.yml',
        'files/mux-audio' => __DIR__ . '/blueprints/files/mux-audio.yml',
        'blocks/mux-audio' => __DIR__ . '/blueprints/blocks/mux-audio.yml'
	],
    'hooks' => [
        'file.create:after' => function (Kirby\Cms\File $file) {
            if (!in_array($file->type(), ['video','audio'])) {
                return;
            }
            // Resolution is rather the width and height to calculate the aspect-ratio from get ID3 vendor
            $resolutionX = '';
            $resolutionY = '';
            // Authenticate
            $assetsApi = KirbyMux\Auth::assetsApi();
            // Upload the file to mux
            $result = KirbyMux\Methods::upload($assetsApi, $file->url(), $file->type());
            // Save mux data
            $getID3 = new getID3;
            // Analyze file and store returned data in $ThisFileInfo
            $ThisFileInfo = $getID3->analyze($file->root());
            // Return the width and height
            if($file->type() === 'video') {
                $resolutionX = $ThisFileInfo['video']['resolution_x'];
                $resolutionY = $ThisFileInfo['video']['resolution_y'];
            }
            try {
                $file = $file->update([
                    'mux' => $result->getData(),
                    'resolutionX' => $resolutionX,
                    'resolutionY' => $resolutionY,
                    'resAspect' => $result->getData()->getAspectRatio()
                ]);
            } catch (Exception $e) {
                throw new Exception($e->getMessage());
            }
        },
        'file.delete:before' => function (Kirby\Cms\File $file) {
            if (!in_array($file->type(), ['video','audio'])) {
                return;
            }
            if (is_null(json_decode($file->mux())) != 1) :
                // Authentication setup
                $assetsApi = KirbyMux\Auth::assetsApi();
                // Get mux Id
                $muxId = json_decode($file->mux())->id;
                // Delete Asset
                try {
                    $assetsApi->deleteAsset($muxId);
                } catch (Exception $e) {
                    throw new Exception($e->getMessage());
                }
            endif;
        },
        'file.replace:before' => function (Kirby\Cms\File $file, Kirby\Filesystem\File $upload) {
            if (!in_array($upload->type(), ['video','audio'])) {
                return;
            }
            // Authentication setup
            $assetsApi = KirbyMux\Auth::assetsApi();
            // Get old mux Id
            $muxId = json_decode($file->mux())->id;
            // Delete old asset
            try {
                $assetsApi->deleteAsset($muxId);
            } catch (Exception $e) {
                throw new Exception($e->getMessage());
            }
        },
        'file.replace:after' => function (Kirby\Cms\File $newFile, Kirby\Cms\File $oldFile) {
            if (!in_array($newFile->type(), ['video','audio'])) {
                return;
            }
            // Authentication setup
            $assetsApi = KirbyMux\Auth::assetsApi();
            // Upload new file to mux
            $result = KirbyMux\Methods::upload($assetsApi, $newFile->url());
            // Save playback Id
            try {
                $newFile = $newFile->update([
                    'mux' => $result->getData()
                ]);
            } catch (Exception $e) {
                throw new Exception($e->getMessage());
            }
        }
    ]
]);

```

# LICENSE.md

```md
MIT License

Copyright (c) 2022 Robin Scholz

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

```

# package.json

```json
{
  "version": "1.2.0",
  "scripts": {
    "dev": "npx -y kirbyup src/index.js --watch",
    "build": "npx -y kirbyup src/index.js"
  },
  "dependencies": {
    "hls.js": "^1.6.0"
  }
}

```

# README.md

```md
# 📼 Kirby Mux

A [Kirby](https://getkirby.com) plugin to upload video files to [Mux](https://mux.com).

## Installation

### Download

Download and copy this repository to `/site/plugins/kirby-mux`.

### Git submodule

\`\`\`
git submodule add https://github.com/robinscholz/kirby-mux.git site/plugins/kirby-mux
\`\`\`

### Composer

\`\`\`
composer require robinscholz/kirby-mux
\`\`\`

## Configuration

Add a .env file to the root of your Kirby plugin with the following properties:

| Key              | Type      |
| ---------------- | --------- |
| MUX_TOKEN_ID     | `String`  |
| MUX_TOKEN_SECRET | `String`  |
| MUX_DEV          | `Boolean` |

### MUX_TOKEN_ID

In order for the plugin to work, you need to create an `API Access Token` on the MUX dashboard. Save the `Token ID` here.

### MUX_TOKEN_SECRET

Save the associated `Token Secret` here.

### MUX_DEV

Set this to `true` for local development. Instead of the actual video, the plugin will upload a test video to Mux. This is neccessary, since videos need to be publicly hosted for Mux to be able to import them.

> **NOTE:** This plugin includes a .env.example file as well.

## Caveats

The plugin does not include any frontend facing code or snippets. In order to stream the videos from Mux you need to implement your own custom video player. [HLS.js](https://github.com/video-dev/hls.js/) is a good option for example.

## Plugin Development

[Kirbyup](https://github.com/johannschopplich/kirbyup) is used for the development and build setup.

Kirbyup will be fetched remotely with your first `npm run` command, which may take a short amount of time.

### Development

Start the dev process with:

\`\`\`
npm run dev
\`\`\`

This will automatically update the `index.js` and `index.css` of the plugin as soon as changes are made.
Reload the Panel to see the code changes reflected.

### Production

Build final files with:

\`\`\`
npm run build
\`\`\`

This will automatically create a minified and optimized version of the `index.js` and `index.css`.

## License

MIT

```

# src/components/AudioBlock.vue

```vue
<template>
  <k-block-figure
    :is-empty="!audio.url"
    :caption="content.caption"
    empty-icon="image"
    empty-text="No file selected yet …"
    @open="open"
    @update="update"
  >
    <AudioPlayer v-if="src" :src="src" />
  </k-block-figure>
</template>

<script>
import AudioPlayer from "./AudioPlayer.vue";
export default {
  name: "AudioBlock",
  components: {
    AudioPlayer,
  },
  data() {
    return {
      mux: null,
    };
  },
  computed: {
    audio() {
      return this.content.audio[0] || {};
    },
    id() {
      return this.mux?.playback_ids[0].id;
    },
    src() {
      if (!this.id) return "";
      return `https://stream.mux.com/${this.id}.m3u8`;
    }
  },
  watch: {
    "audio.link": {
      handler(link) {
        if (link) {
          this.$api.get(link).then((file) => {
            this.mux = JSON.parse(file.content.mux);
          });
        }
      },
      immediate: true,
    },
  },
};
</script>

```

# src/components/AudioPlayer.vue

```vue
<template>
  <div class="audio-player">
    <transition name="fade">
      <div
        v-if="
          state.playback === 'idle' ||
          state.playback === 'ended' ||
          state.playback === 'paused'
        "
        class="overlay"
        @click="togglePlayback"
      >
      </div>
    </transition>
    <audio
      controls
      ref="audio"
      class="player-audio k-block-type-audio-element"
      :loop="false"
      :muted="state.muted"
      preload="auto"
      @play="onPlay"
      @pause="onPause"
      @ended="onEnded"
      @click="togglePlayback"
    />
  </div>
</template>

<script>
import Hls from "hls.js/dist/hls.light.js";

export default {
  name: "AudioPlayer",
  props: {
    src: {
      type: String,
      required: true,
    }
  },
  data() {
    return {
      state: {
        loaded: false,
        playback: "idle",
        muted: false,
      },
      hls: null,
    };
  },
  mounted() {
    this.load();
  },
  beforeUnmount() {
    this.destroy();
  },
  methods: {
    load() {
      if (Hls.isSupported()) {
        this.hls = new Hls();
        this.hls.loadSource(this.src);
        this.hls.attachMedia(this.$refs.audio);
        this.hls.on(Hls.Events.MEDIA_ATTACHED, this.onLoad);
      } else {
        this.$refs.audio.src = this.src;
        this.$refs.audio.load();
        this.state.loaded = true;
      }
    },
    destroy() {
      this.hls.detachMedia();
      this.hls.destroy();
    },
    play() {
      const playPromise = this.$refs.audio.play();
      if (playPromise !== null) {
        playPromise.catch(() => {
          this.pause();
        });
      }
    },
    pause() {
      this.$refs.audio.pause();
    },
    togglePlayback() {
      if (this.state.playback === "playing") {
        this.pause();
      } else {
        this.play();
      }
    },
    onLoad() {
      this.state.loaded = true;
    },
    onPlay() {
      this.state.playback = "playing";
    },
    onPause() {
      this.state.playback = "paused";
    },
    onEnded() {
      this.state.playback = "ended";
    },
  },
};
</script>

<style lang="postcss">
.audio-player {
  position: relative;
  display: flex;
}
audio {
  width: 100%;
  cursor: pointer;
}
</style>

```

# src/components/VideoBlock.vue

```vue
<template>
  <k-block-figure
    :is-empty="!video.url"
    :caption="content.caption"
    empty-icon="image"
    empty-text="No file selected yet …"
    @open="open"
    @update="update"
  >
    <VideoPlayer v-if="src" :src="src" :thumb="thumb" />
  </k-block-figure>
</template>

<script>
import VideoPlayer from "./VideoPlayer.vue";

export default {
  name: "VideoBlock",
  components: {
    VideoPlayer,
  },
  data() {
    return {
      mux: null,
    };
  },
  computed: {
    video() {
      return this.content.video[0] || {};
    },
    id() {
      return this.mux?.playback_ids[0].id;
    },
    src() {
      if (!this.id) return "";
      return `https://stream.mux.com/${this.id}.m3u8`;
    },
    time() {
      return this.content.thumbnail || 0;
    },
    thumb() {
      if (!this.id) return "";
      const url = `https://image.mux.com/${this.id}/thumbnail.jpg?time=${this.time}`;
      const srcset = [300, 600, 900, 1200, 1600];
      return {
        src: url,
        srcset: srcset.map((w) => `${url}&width=${w} ${w}w`).join(", "),
      };
    },
  },
  watch: {
    "video.link": {
      handler(link) {
        if (link) {
          this.$api.get(link).then((file) => {
            this.mux = JSON.parse(file.content.mux);
          });
        }
      },
      immediate: true,
    },
  },
};
</script>

```

# src/components/VideoPlayer.vue

```vue
<template>
  <div class="video-player">
    <transition name="fade">
      <img
        v-if="!!thumb && state.playback === 'idle'"
        :src="thumb.src"
        :srcset="thumb.srcset"
        sizes="auto"
        class="thumb"
      />
    </transition>
    <transition name="fade">
      <div
        v-if="
          state.playback === 'idle' ||
          state.playback === 'ended' ||
          state.playback === 'paused'
        "
        class="overlay"
        @click="togglePlayback"
      >
        <button class="overlay__inner">
          <svg
            width="10"
            height="13"
            viewBox="0 0 10 13"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M0 0.388916L10 6.50003L0 12.6111V0.388916Z" />
          </svg>
        </button>
      </div>
    </transition>
    <video
      ref="video"
      class="player-video"
      :loop="false"
      :muted="state.muted"
      preload="auto"
      @play="onPlay"
      @pause="onPause"
      @ended="onEnded"
      @click="togglePlayback"
    />
  </div>
</template>

<script>
import Hls from "hls.js/dist/hls.light.js";

export default {
  name: "VideoPlayer",
  props: {
    src: {
      type: String,
      required: true,
    },
    thumb: {
      type: Object,
      default: () => ({}),
    },
  },
  data() {
    return {
      state: {
        loaded: false,
        playback: "idle",
        muted: false,
      },
      hls: null,
    };
  },
  mounted() {
    this.load();
  },
  beforeUnmount() {
    this.destroy();
  },
  methods: {
    load() {
      if (Hls.isSupported()) {
        this.hls = new Hls();
        this.hls.loadSource(this.src);
        this.hls.attachMedia(this.$refs.video);
        this.hls.on(Hls.Events.MEDIA_ATTACHED, this.onLoad);
      } else {
        this.$refs.video.src = this.src;
        this.$refs.video.load();
        this.state.loaded = true;
      }
    },
    destroy() {
      this.hls.detachMedia();
      this.hls.destroy();
    },
    play() {
      const playPromise = this.$refs.video.play();
      if (playPromise !== null) {
        playPromise.catch(() => {
          this.pause();
        });
      }
    },
    pause() {
      this.$refs.video.pause();
    },
    togglePlayback() {
      if (this.state.playback === "playing") {
        this.pause();
      } else {
        this.play();
      }
    },
    onLoad() {
      this.state.loaded = true;
    },
    onPlay() {
      this.state.playback = "playing";
    },
    onPause() {
      this.state.playback = "paused";
    },
    onEnded() {
      this.state.playback = "ended";
    },
  },
};
</script>

<style lang="postcss">
.video-player {
  position: relative;
  display: flex;
}

.thumb {
  width: 100%;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10;
}

.overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20;
}

.overlay__inner {
  width: 56px;
  height: 42px;
  padding-left: 3px;
  background: #000;
  border: 0;
  display: flex;
  color: #fff;
  align-items: center;
  justify-content: center;
  transition: width 0.15s ease-out, height 0.15s ease-out;
  cursor: pointer;
}

.overlay__inner svg {
  width: 14px;
  height: auto;
}

.overlay__inner:active {
  width: 53.333px;
  height: 40px;
}

video {
  width: 100%;
  cursor: pointer;
}
.k-block-container-type-mux-video {
  position: relative;
  z-index: 0;
}
.k-block-container-type-mux-video .k-block-figure-empty {
  height: 100%;
}
</style>

```

# src/index.js

```js
import VideoBlock from "./components/VideoBlock.vue";
import AudioBlock from "./components/AudioBlock.vue";

window.panel.plugin("robinscholz/kirby-mux", {
  blocks: {
    "mux-video": VideoBlock,
    "mux-audio": AudioBlock,
  },
});

```

